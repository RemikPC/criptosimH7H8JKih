<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoExchange Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #C8FF00;
            --primary-light: #E4FF7D;
            --primary-extra-light: #F5FFC6;
            --dark-bg: #121212;
            --dark-card: #1E1E1E;
            --dark-element: #2A2A2A;
            --text-light: #FFFFFF;
            --text-gray: #AAAAAA;
            --success: #00C851;
            --danger: #ff4444;
            --warning: #ffbb33;
            --bank-blue: #1E3A8A;
            --bank-light-blue: #3B82F6;
            --bank-white: #FFFFFF;
            --bank-gray: #F8FAFC;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-danger: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --stocks-green: #10B981;
            --stocks-red: #EF4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-light);
            min-height: 100vh;
            padding-bottom: 80px;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(200, 255, 0, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(59, 130, 246, 0.05) 0%, transparent 20%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Навигация */
        .nav-tabs {
            display: flex;
            background-color: var(--dark-card);
            border-radius: 16px;
            padding: 8px;
            margin: 20px 0;
            position: sticky;
            top: 10px;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }

        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 14px 0;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--text-gray);
            position: relative;
            overflow: hidden;
            min-width: 120px;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(200, 255, 0, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .nav-tab:hover::before {
            left: 100%;
        }

        .nav-tab.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }

        /* Контент вкладок */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Карточки */
        .card {
            background-color: var(--dark-card);
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--bank-light-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* График */
        .chart-container {
            height: 320px;
            margin-bottom: 24px;
            border-radius: 16px;
            overflow: hidden;
        }

        /* Формы */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-light);
        }

        .form-control {
            width: 100%;
            padding: 14px 18px;
            background-color: var(--dark-element);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-light);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(200, 255, 0, 0.1);
            background-color: rgba(42, 42, 42, 0.8);
        }

        /* Кнопки */
        .btn {
            display: inline-block;
            padding: 14px 28px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #00a844);
        }

        .btn-danger {
            background: var(--gradient-danger);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #ff8800);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: var(--dark-bg);
        }

        .btn-bank {
            background: linear-gradient(135deg, var(--bank-light-blue), #1e40af);
            color: var(--bank-white);
        }

        /* Балансы */
        .balance-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--gradient-primary);
            border-radius: 16px;
            margin-bottom: 16px;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }

        .balance-card:hover {
            transform: translateY(-3px);
        }

        .balance-info {
            display: flex;
            align-items: center;
        }

        .balance-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.2rem;
            backdrop-filter: blur(10px);
        }

        .balance-amount {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .balance-change {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Таймер */
        .timer {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin: 24px 0;
            color: var(--primary);
            text-shadow: 0 0 20px rgba(200, 255, 0, 0.5);
            animation: pulse 1s infinite;
        }

        /* Результат ставки */
        .result {
            text-align: center;
            padding: 24px;
            border-radius: 16px;
            margin: 24px 0;
            font-weight: 700;
            font-size: 1.3rem;
            display: none;
            animation: slideInUp 0.5s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result.success {
            background: linear-gradient(135deg, rgba(0, 200, 81, 0.2), rgba(0, 168, 68, 0.1));
            color: var(--success);
            border: 2px solid var(--success);
            display: block;
        }

        .result.failure {
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.2), rgba(245, 87, 108, 0.1));
            color: var(--danger);
            border: 2px solid var(--danger);
            display: block;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
                gap: 8px;
            }
            
            .card {
                padding: 20px;
            }
            
            .balance-card {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .balance-actions {
                margin-top: 16px;
                width: 100%;
            }
        }

        /* История операций */
        .transaction-history {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 12px;
            background: var(--dark-element);
            padding: 16px;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.3s ease;
        }

        .transaction-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-amount.positive {
            color: var(--success);
            font-weight: 600;
        }

        .transaction-amount.negative {
            color: var(--danger);
            font-weight: 600;
        }

        /* Селектор валют */
        .currency-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .currency-option {
            flex: 1;
            text-align: center;
            padding: 16px;
            background-color: var(--dark-element);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .currency-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .currency-option.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        /* Направление конвертации */
        .conversion-direction {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 24px 0;
        }

        .direction-arrow {
            margin: 0 24px;
            font-size: 1.8rem;
            color: var(--primary);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Уведомления */
        .notification {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 20px 28px;
            background: var(--gradient-primary);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            animation: slideInRight 0.3s ease;
            color: white;
            font-weight: 600;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--dark-card);
            border-radius: 20px;
            padding: 32px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--bank-light-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.8rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: var(--primary);
        }

        .modal-footer {
            display: flex;
            gap: 16px;
            margin-top: 28px;
        }

        /* NFT Grid */
        .nft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .nft-card {
            background: var(--gradient-primary);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .nft-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.5);
        }

        .nft-image {
            width: 100%;
            height: 220px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            backdrop-filter: blur(10px);
        }

        .nft-name {
            font-weight: 700;
            margin-bottom: 12px;
            font-size: 1.3rem;
        }

        .nft-price {
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 16px;
            font-size: 1.2rem;
        }

        .nft-count {
            opacity: 0.9;
            font-size: 0.9rem;
            margin-bottom: 16px;
        }

        /* Аутентификация */
        .auth-container {
            max-width: 440px;
            margin: 60px auto;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 24px;
            background: var(--dark-element);
            border-radius: 12px;
            padding: 8px;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 16px;
            background-color: transparent;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .auth-tab.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .auth-content {
            display: none;
        }

        .auth-content.active {
            display: block;
        }

        /* Профиль */
        .profile-info {
            text-align: center;
            margin-bottom: 36px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2.5rem;
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .admin-badge {
            background: var(--gradient-danger);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 12px;
        }

        /* Банк */
        .bank-container {
            background: linear-gradient(135deg, var(--bank-blue) 0%, #1e3a8a 100%);
            min-height: 100vh;
            color: var(--bank-white);
            padding: 20px 0;
        }

        .bank-header {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 24px 0;
            backdrop-filter: blur(10px);
            margin-bottom: 24px;
        }

        .bank-card {
            background-color: var(--bank-white);
            color: var(--bank-blue);
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .bank-card:hover {
            transform: translateY(-5px);
        }

        .bank-tabs {
            display: flex;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 8px;
            margin: 24px 0;
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
        }

        .bank-tab {
            flex: 1;
            text-align: center;
            padding: 16px 0;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--bank-white);
            min-width: 140px;
        }

        .bank-tab.active {
            background-color: var(--bank-white);
            color: var(--bank-blue);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
        }

        .bank-content {
            display: none;
        }

        .bank-content.active {
            display: block;
        }

        .card-item {
            background: var(--gradient-primary);
            color: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .card-number {
            font-family: 'Courier New', monospace;
            font-size: 1.4rem;
            letter-spacing: 2px;
            margin: 20px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .card-details {
            display: flex;
            justify-content: space-between;
            font-size: 1rem;
        }

        .property-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .property-card {
            background-color: var(--bank-white);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .property-card:hover {
            transform: translateY(-5px);
        }

        .property-image {
            width: 100%;
            height: 180px;
            background: var(--gradient-primary);
            border-radius: 12px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            color: white;
        }

        .back-to-trading {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* Документы */
        .document-status {
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            text-align: center;
            font-weight: bold;
        }

        .document-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .document-verified {
            background-color: #d1edff;
            color: #004085;
        }

        .document-ready {
            background-color: #d4edda;
            color: #155724;
        }

        .timer-small {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        /* Яхты */
        .yacht-card {
            background: var(--gradient-primary);
            color: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .document-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 8px;
        }

        .badge-car {
            background-color: #007bff;
            color: white;
        }

        .badge-property {
            background-color: #28a745;
            color: white;
        }

        .badge-yacht {
            background-color: #6f42c1;
            color: white;
        }

        /* Crash Game */
        .crash-game-container {
            text-align: center;
        }

        .crash-multiplier {
            font-size: 5rem;
            font-weight: bold;
            margin: 24px 0;
            color: var(--primary);
            text-shadow: 0 0 30px rgba(200, 255, 0, 0.7);
            transition: all 0.1s ease;
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from {
                text-shadow: 0 0 20px rgba(200, 255, 0, 0.7);
            }
            to {
                text-shadow: 0 0 30px rgba(200, 255, 0, 1), 0 0 40px rgba(200, 255, 0, 0.5);
            }
        }

        .crash-graph {
            height: 240px;
            background: var(--gradient-primary);
            border-radius: 16px;
            margin: 24px 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .crash-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--primary);
            transform-origin: 0 0;
            transition: transform 0.1s linear;
            box-shadow: 0 0 10px rgba(200, 255, 0, 0.5);
        }

        .crash-point {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--danger);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }

        .crash-history {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 24px 0;
            flex-wrap: wrap;
        }

        .crash-history-item {
            padding: 10px 20px;
            background: var(--dark-element);
            border-radius: 20px;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .crash-history-item:hover {
            transform: scale(1.1);
        }

        .crash-history-item.win {
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .crash-history-item.loss {
            background: var(--gradient-danger);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        }

        .crash-controls {
            display: flex;
            gap: 16px;
            margin-top: 24px;
        }

        .crash-bet-input {
            flex: 2;
        }

        .crash-bet-button {
            flex: 1;
        }

        .crash-cashout-button {
            flex: 1;
            background: var(--gradient-success);
        }

        .crash-cashout-button:disabled {
            background: var(--text-gray);
            cursor: not-allowed;
            transform: none !important;
        }

        .crash-info {
            background: var(--dark-element);
            padding: 20px;
            border-radius: 16px;
            margin: 20px 0;
            text-align: left;
        }

        .crash-info h3 {
            color: var(--primary);
            margin-bottom: 12px;
        }

        .crash-risk-indicator {
            display: flex;
            justify-content: space-between;
            margin: 16px 0;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .risk-level {
            text-align: center;
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            margin: 0 4px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .risk-level.active {
            background: var(--gradient-danger);
            color: white;
            transform: scale(1.05);
        }

        .pulsating-update {
            animation: pulse 2s infinite;
            color: var(--primary);
            font-weight: bold;
            margin-left: 12px;
            font-size: 0.9em;
            text-shadow: 0 0 10px rgba(200, 255, 0, 0.5);
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }

        .stat-card {
            background: var(--dark-element);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-gray);
            font-size: 0.9rem;
        }

        /* Улучшение NFT */
        .nft-upgrade-container {
            text-align: center;
        }

        .nft-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }

        .nft-selector-item {
            background: var(--dark-element);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .nft-selector-item:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
        }

        .nft-selector-item.selected {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .nft-selector-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nft-emoji {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .upgrade-animation-container {
            height: 200px;
            background: var(--dark-element);
            border-radius: 16px;
            margin: 24px 0;
            position: relative;
            overflow: hidden;
            display: none;
        }

        .upgrade-animation {
            display: flex;
            height: 100%;
            align-items: center;
            animation: scrollAnimation 3s linear infinite;
            position: absolute;
            left: 0;
        }

        @keyframes scrollAnimation {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        .upgrade-nft-item {
            min-width: 150px;
            height: 150px;
            background: var(--gradient-primary);
            border-radius: 12px;
            margin: 0 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .upgrade-result {
            text-align: center;
            padding: 24px;
            border-radius: 16px;
            margin: 24px 0;
            display: none;
        }

        .upgrade-result.success {
            background: linear-gradient(135deg, rgba(0, 200, 81, 0.2), rgba(0, 168, 68, 0.1));
            border: 2px solid var(--success);
            color: var(--success);
        }

        .upgrade-result.failure {
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.2), rgba(245, 87, 108, 0.1));
            border: 2px solid var(--danger);
            color: var(--danger);
        }

        /* Кликер */
        .clicker-container {
            text-align: center;
        }

        .catcoin-display {
            font-size: 4rem;
            font-weight: bold;
            margin: 24px 0;
            color: #FF6B6B;
            text-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
        }

        .clicker-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            border: none;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            margin: 24px 0;
            transition: all 0.1s ease;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
            position: relative;
            overflow: hidden;
        }

        .clicker-button::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite linear;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .clicker-button:active {
            transform: scale(0.95);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.5);
        }

        .clicker-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .clicker-upgrades {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }

        .clicker-upgrade-card {
            background: var(--dark-element);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .clicker-upgrade-card:hover {
            transform: translateY(-5px);
        }

        .clicker-upgrade-card h3 {
            color: var(--primary);
            margin-bottom: 12px;
        }

        .clicker-upgrade-price {
            color: #FFD700;
            font-weight: bold;
            margin-bottom: 16px;
        }

        .clicker-stats {
            display: flex;
            justify-content: space-around;
            margin: 24px 0;
            padding: 20px;
            background: var(--gradient-primary);
            border-radius: 16px;
            color: white;
        }

        .clicker-stat {
            text-align: center;
        }

        .clicker-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .clicker-stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Цвета NFT для улучшений */
        .nft-black { background: linear-gradient(135deg, #000000, #434343) !important; }
        .nft-orange { background: linear-gradient(135deg, #FF6B35, #FFA62E) !important; }
        .nft-blue { background: linear-gradient(135deg, #1E3A8A, #3B82F6) !important; }
        .nft-red { background: linear-gradient(135deg, #DC2626, #EF4444) !important; }
        .nft-green { background: linear-gradient(135deg, #059669, #10B981) !important; }
        .nft-purple { background: linear-gradient(135deg, #7C3AED, #8B5CF6) !important; }
        .nft-white { background: linear-gradient(135deg, #FFFFFF, #E5E5E5) !important; color: #333 !important; }
        .nft-cyan { background: linear-gradient(135deg, #0891B2, #06B6D4) !important; }
        .nft-brown { background: linear-gradient(135deg, #78350F, #92400E) !important; }
        .nft-yellow { background: linear-gradient(135deg, #F59E0B, #FBBF24) !important; }

        /* Индикатор улучшения NFT */
        .nft-upgrade-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 8px;
        }

        .upgrade-common { background-color: #6B7280; color: white; }
        .upgrade-uncommon { background-color: #10B981; color: white; }
        .upgrade-rare { background-color: #3B82F6; color: white; }
        .upgrade-epic { background-color: #8B5CF6; color: white; }
        .upgrade-legendary { background-color: #F59E0B; color: white; }
        .upgrade-mythic { background-color: #EF4444; color: white; }
        .upgrade-godlike { background-color: #000000; color: white; }

        /* Слоты */
        .slots-container {
            text-align: center;
        }

        .slots-machine {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            padding: 30px;
            background: var(--dark-element);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }

        .slot-reel {
            width: 120px;
            height: 180px;
            background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            border: 4px solid var(--primary);
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .slot-reel.spinning {
            animation: slotSpin 0.2s linear infinite;
        }

        @keyframes slotSpin {
            0% { transform: translateY(0); }
            100% { transform: translateY(-200px); }
        }

        .slot-emoji {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            opacity: 0;
            animation: emojiAppear 0.3s forwards;
        }

        @keyframes emojiAppear {
            to { opacity: 1; }
        }

        .slots-nft-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }

        .slot-nft-item {
            background: var(--dark-element);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .slot-nft-item:hover {
            transform: translateY(-3px);
        }

        .slot-nft-item.selected {
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(200, 255, 0, 0.3);
        }

        .slot-nft-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .slot-result {
            text-align: center;
            padding: 30px;
            border-radius: 20px;
            margin: 30px 0;
            font-size: 1.4rem;
            font-weight: bold;
            display: none;
            animation: resultAppear 0.5s ease;
        }

        @keyframes resultAppear {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Акции */
        .stocks-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .stocks-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stock-card {
            background: var(--dark-element);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .stock-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .stock-card.positive {
            border-left-color: var(--stocks-green);
        }

        .stock-card.negative {
            border-left-color: var(--stocks-red);
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .stock-name {
            font-size: 1.4rem;
            font-weight: bold;
        }

        .stock-price {
            font-size: 1.6rem;
            font-weight: bold;
        }

        .stock-change {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 12px;
        }

        .stock-change.positive {
            background: rgba(16, 185, 129, 0.2);
            color: var(--stocks-green);
        }

        .stock-change.negative {
            background: rgba(239, 68, 68, 0.2);
            color: var(--stocks-red);
        }

        .stock-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        .stock-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .stock-chart-container {
            height: 200px;
            margin: 20px 0;
        }

        .owned-stocks-info {
            background: var(--dark-element);
            padding: 20px;
            border-radius: 16px;
            margin-top: 24px;
        }

        .stocks-controls {
            display: flex;
            gap: 16px;
            margin: 20px 0;
        }

        .stocks-controls input {
            flex: 2;
        }

        .stocks-controls button {
            flex: 1;
        }

        .stock-ownership {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .ownership-bar {
            flex: 2;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 0 12px;
        }

        .ownership-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .ownership-percent {
            flex: 1;
            text-align: right;
            font-weight: 600;
            color: var(--primary);
        }

        /* Картины */
        .paintings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .painting-card {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.3);
        }

        .painting-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 40px rgba(139, 92, 246, 0.5);
        }

        .painting-card.mona-lisa {
            background: linear-gradient(135deg, #EF4444, #DC2626);
        }

        .painting-card.savior {
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
        }

        .painting-card.exchange {
            background: linear-gradient(135deg, #10B981, #059669);
        }

        .painting-card.card-players {
            background: linear-gradient(135deg, #F59E0B, #D97706);
        }

        .painting-image {
            width: 100%;
            height: 250px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        .painting-price {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 16px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .painting-status {
            font-size: 1rem;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .painting-owned {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
            font-weight: 600;
        }

        /* Брокерский счет */
        .broker-balance {
            background: linear-gradient(135deg, #059669, #10B981);
            color: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
            /* Исправление для полей ввода акций */
.stock-input {
    transition: none !important;
    animation: none !important;
}

.stock-input:focus {
    border-color: var(--primary) !important;
    box-shadow: 0 0 0 4px rgba(200, 255, 0, 0.1) !important;
    background-color: rgba(42, 42, 42, 0.8) !important;
}

/* Убедитесь что поля ввода не сбрасываются при обновлении */
#stocks-list input[type="number"] {
    transition: none;
}

#stocks-list input[type="number"]:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(200, 255, 0, 0.1);
}
        }

        .stock-actions input[type="number"] {
    transition: none !important;
    animation: none !important;
}

.stock-actions input[type="number"]:focus {
    outline: none !important;
    border-color: var(--primary) !important;
    box-shadow: 0 0 0 4px rgba(200, 255, 0, 0.1) !important;
    background-color: rgba(42, 42, 42, 0.8) !important;
}

/* Убедитесь что поля ввода не сбрасываются при обновлении */
#stocks-list input[type="number"] {
    transition: none !important;
}

#stocks-list input[type="number"]:focus {
    outline: none !important;
    border-color: var(--primary) !important;
    box-shadow: 0 0 0 4px rgba(200, 255, 0, 0.1) !important;
    background-color: rgba(42, 42, 42, 0.8) !important;
}

/* Отключаем анимации для всех полей ввода в секции акций */
.stocks-container input[type="number"],
.stocks-container input[type="text"] {
    transition: none !important;
}

.stocks-container input[type="number"]:focus,
.stocks-container input[type="text"]:focus {
    animation: none !important;
    transition: none !important;
}

/* Добавьте в CSS */
.currency-option.disabled {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
    pointer-events: none !important;
}
/* Fragment Styles */
.fragment-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}

.fragment-header {
    text-align: center;
    padding: 40px 0 30px;
}

.fragment-tabs {
    display: flex;
    background-color: var(--dark-element);
    border-radius: 16px;
    padding: 8px;
    margin: 20px 0 30px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.fragment-tab {
    flex: 1;
    text-align: center;
    padding: 16px 0;
    cursor: pointer;
    border-radius: 12px;
    transition: all 0.3s ease;
    font-weight: 600;
    color: var(--text-gray);
    position: relative;
    overflow: hidden;
}

.fragment-tab::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.2), transparent);
    transition: left 0.5s ease;
}

.fragment-tab:hover::before {
    left: 100%;
}

.fragment-tab.active {
    background: linear-gradient(135deg, #8B5CF6, #7C3AED);
    color: white;
    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
    transform: translateY(-2px);
}

.fragment-content {
    display: none;
    animation: fadeIn 0.5s ease;
}

.fragment-content.active {
    display: block;
}

/* Ники стили */
.nicks-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 24px;
}

.nick-card {
    background: var(--dark-element);
    border-radius: 16px;
    padding: 24px;
    text-align: center;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    position: relative;
    overflow: hidden;
}

.nick-card:hover {
    transform: translateY(-5px);
    border-color: var(--primary);
    box-shadow: 0 8px 25px rgba(200, 255, 0, 0.2);
}

.nick-card.owned {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1));
    border-color: #8B5CF6;
}

.nick-card.premium {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1));
    border-color: #FFD700;
}

.nick-name {
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 12px;
    color: var(--primary);
}

.nick-card.premium .nick-name {
    color: #FFD700;
}

.nick-price {
    font-size: 1.4rem;
    font-weight: bold;
    margin-bottom: 16px;
    color: var(--text-light);
}

.nick-change {
    font-size: 0.9rem;
    margin-bottom: 20px;
    padding: 6px 12px;
    border-radius: 20px;
    display: inline-block;
}

.nick-change.positive {
    background: rgba(0, 200, 81, 0.2);
    color: var(--success);
}

.nick-change.negative {
    background: rgba(255, 68, 68, 0.2);
    color: var(--danger);
}

.nick-availability {
    font-size: 0.9rem;
    color: var(--text-gray);
    margin-bottom: 20px;
}

.nick-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: linear-gradient(135deg, #8B5CF6, #7C3AED);
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
}

/* NFT на рынке */
.market-nft-card {
    background: var(--dark-element);
    border-radius: 16px;
    padding: 24px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.market-nft-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #8B5CF6, #7C3AED);
}

.market-nft-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 40px rgba(139, 92, 246, 0.3);
}

.market-nft-image {
    width: 100%;
    height: 150px;
    border-radius: 12px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3.5rem;
    background: rgba(255, 255, 255, 0.1);
}

.market-nft-info {
    margin-bottom: 16px;
}

.market-nft-name {
    font-weight: bold;
    font-size: 1.3rem;
    margin-bottom: 8px;
}

.market-nft-owner {
    font-size: 0.9rem;
    color: var(--text-gray);
    margin-bottom: 8px;
}

.market-nft-price {
    font-size: 1.6rem;
    font-weight: bold;
    color: var(--primary);
    margin-bottom: 20px;
}

.market-nft-status {
    font-size: 0.9rem;
    padding: 6px 12px;
    border-radius: 20px;
    display: inline-block;
    margin-bottom: 20px;
}

.market-nft-status.available {
    background: rgba(0, 200, 81, 0.2);
    color: var(--success);
}

.market-nft-status.selling {
    background: rgba(255, 200, 0, 0.2);
    color: #FFD700;
}

.sale-timer {
    font-size: 0.9rem;
    color: var(--text-gray);
    margin-top: 12px;
    font-family: 'Courier New', monospace;
}

/* Fragment NFT селектор */
.fragment-nft-selector {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 16px;
    margin: 20px 0;
}

.fragment-nft-item {
    background: var(--dark-element);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.fragment-nft-item:hover {
    transform: translateY(-3px);
    border-color: var(--primary);
}

.fragment-nft-item.selected {
    background: linear-gradient(135deg, #8B5CF6, #7C3AED);
    color: white;
    border-color: #8B5CF6;
    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
}

.fragment-nft-emoji {
    font-size: 2.5rem;
    margin-bottom: 8px;
    border-radius: 8px;
    padding: 10px;
}

.fragment-nft-rarity {
    font-size: 0.8rem;
    padding: 4px 8px;
    border-radius: 12px;
    display: inline-block;
    margin-bottom: 8px;
    font-weight: bold;
}

.rarity-common { background-color: #6B7280; color: white; }
.rarity-uncommon { background-color: #10B981; color: white; }
.rarity-rare { background-color: #3B82F6; color: white; }
.rarity-epic { background-color: #8B5CF6; color: white; }
.rarity-legendary { background-color: #F59E0B; color: white; }
.rarity-godlike { background-color: #000000; color: white; }

/* Адаптивность */
@media (max-width: 768px) {
    .fragment-tabs {
        flex-direction: column;
        gap: 8px;
    }
    
    .nicks-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
    
    .fragment-nft-selector {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }
}
/* Добавьте в CSS стили */
.fragment-nft-item.warning {
    border: 2px solid #FFD700 !important;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
}

.fragment-nft-item.danger {
    border: 2px solid var(--danger) !important;
    box-shadow: 0 0 15px rgba(255, 68, 68, 0.3);
    animation: pulse-danger 2s infinite;
}

@keyframes pulse-danger {
    0% { box-shadow: 0 0 10px rgba(255, 68, 68, 0.3); }
    50% { box-shadow: 0 0 20px rgba(255, 68, 68, 0.5); }
    100% { box-shadow: 0 0 10px rgba(255, 68, 68, 0.3); }
}

.burn-warning {
    position: absolute;
    top: 5px;
    left: 5px;
    background: var(--danger);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: bold;
    z-index: 1;
}
/* Добавьте в CSS */
.price-info-container {
    margin-top: 10px;
    padding: 12px;
    border-radius: 8px;
    font-size: 0.9rem;
}

.price-info-danger {
    background: rgba(255, 68, 68, 0.1);
    border: 1px solid rgba(255, 68, 68, 0.3);
    color: var(--danger);
}

.price-info-warning {
    background: rgba(255, 152, 0, 0.1);
    border: 1px solid rgba(255, 152, 0, 0.3);
    color: #FF9800;
}

.price-info-success {
    background: rgba(0, 200, 81, 0.1);
    border: 1px solid rgba(0, 200, 81, 0.3);
    color: var(--success);
}

.price-info-normal {
    background: rgba(200, 255, 0, 0.1);
    border: 1px solid rgba(200, 255, 0, 0.3);
    color: var(--primary);
}

.chance-indicator {
    display: flex;
    align-items: center;
    margin-top: 10px;
}

.chance-bar {
    flex: 1;
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
    margin-right: 10px;
}

.chance-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s ease;
}

.chance-high { background: linear-gradient(90deg, var(--success), #00ff88); }
.chance-medium { background: linear-gradient(90deg, #FFD700, #ffaa00); }
.chance-low { background: linear-gradient(90deg, #FF9800, #ff5500); }
.chance-very-low { background: linear-gradient(90deg, var(--danger), #ff0000); }
    </style>
</head>
<body>
    <div class="container">
        <header style="text-align: center; padding: 24px 0;">
            <h1 style="font-size: 2.5rem; margin-bottom: 12px; color: var(--primary); text-shadow: 0 0 20px rgba(200, 255, 0, 0.5);">
                CryptoExchange Simulator
                <span class="pulsating-update">Fragment!</span>
            </h1>
            <p style="color: var(--text-gray); font-size: 1.1rem;">Торгуйте, конвертируйте и управляйте криптовалютами</p>
        </header>

        <!-- Навигация -->
        <div class="nav-tabs" id="main-nav" style="display: none;">
            <div class="nav-tab active" data-tab="trade">Игра</div>
            <div class="nav-tab" data-tab="crash-game">Crash Game</div>
            <div class="nav-tab" data-tab="slots">Слоты</div>
            <div class="nav-tab" data-tab="stocks">Акции</div>
            <div class="nav-tab" data-tab="wallets">Кошельки</div>
            <div class="nav-tab" data-tab="conversion">Конвертация</div>
            <div class="nav-tab" data-tab="nft-market">NFT Маркет</div>
            <div class="nav-tab" data-tab="inventory">Инвентарь</div>
            <div class="nav-tab" data-tab="upgrade">Улучшение</div>
            <div class="nav-tab" data-tab="clicker">Кликер</div>
            <div class="nav-tab" data-tab="deposit">Ввод средств</div>
            <div class="nav-tab" data-tab="withdraw">Вывод средств</div>
            <div class="nav-tab" data-tab="profile">Профиль</div>
            <div class="nav-tab" id="admin-tab" data-tab="admin" style="display: none;">Админ</div>
            <div class="nav-tab" data-tab="bank" style="background: linear-gradient(135deg, var(--bank-light-blue), #1e40af); color: white;">Банк</div>
            <div class="nav-tab" data-tab="fragment" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white;">Fragment</div>
        </div>

        <!-- Аутентификация -->
        <div id="auth" class="tab-content active">
            <!-- ... (существующий код аутентификации без изменений) ... -->
            <div class="auth-container">
                <div class="card">
                    <div class="auth-tabs">
                        <div class="auth-tab active" data-auth="login">Вход</div>
                        <div class="auth-tab" data-auth="register">Регистрация</div>
                    </div>
                    
                    <div id="login-form" class="auth-content active">
                        <h2 style="text-align: center; margin-bottom: 24px;">Вход в аккаунт</h2>
                        <div class="form-group">
                            <label class="form-label" for="login-username">Логин</label>
                            <input type="text" id="login-username" class="form-control" placeholder="Введите логин">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="login-password">Пароль</label>
                            <input type="password" id="login-password" class="form-control" placeholder="Введите пароль">
                        </div>
                        <button id="btn-login" class="btn btn-block">Войти</button>
                    </div>
                    
                    <div id="register-form" class="auth-content">
                        <h2 style="text-align: center; margin-bottom: 24px;">Регистрация</h2>
                        <div class="form-group">
                            <label class="form-label" for="register-username">Логин</label>
                            <input type="text" id="register-username" class="form-control" placeholder="Придумайте логин">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="register-password">Пароль</label>
                            <input type="password" id="register-password" class="form-control" placeholder="Придумайте пароль">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="register-confirm">Подтверждение пароля</label>
                            <input type="password" id="register-confirm" class="form-control" placeholder="Повторите пароль">
                        </div>
                        <button id="btn-register" class="btn btn-block">Зарегистрироваться</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Вкладка "Игра" -->
        <div id="trade" class="tab-content">
            <!-- ... (существующий код игры без изменений) ... -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Торговля</h2>
                    <div id="current-price" style="font-weight: 700; font-size: 1.4rem; color: var(--primary);">BTC: $0</div>
                </div>
                
                <div class="chart-container">
                    <canvas id="price-chart"></canvas>
                </div>
                
                <div class="currency-selector">
                    <div class="currency-option active" data-currency="BTC">Bitcoin (BTC)</div>
                    <div class="currency-option" data-currency="ETH">Ethereum (ETH)</div>
                    <div class="currency-option" data-currency="TON">Toncoin (TON)</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="bet-amount">Сумма ставки</label>
                    <input type="number" id="bet-amount" class="form-control" placeholder="Введите сумму" min="0.001" step="0.001">
                    <div style="margin-top: 10px; font-size: 0.9rem; color: var(--text-gray);">
                        Минимум: 0.001, Максимум: <span id="max-bet">0</span>
                    </div>
                </div>
                
                <div class="form-group" style="display: flex; gap: 16px;">
                    <button id="btn-up" class="btn btn-success" style="flex: 1;">ВВЕРХ</button>
                    <button id="btn-down" class="btn btn-danger" style="flex: 1;">ВНИЗ</button>
                </div>
                
                <div id="timer" class="timer" style="display: none;"></div>
                
                <div id="bet-result" class="result"></div>
            </div>
        </div>

        <!-- Вкладка "Crash Game" -->
        <div id="crash-game" class="tab-content">
            <!-- ... (существующий код Crash Game без изменений) ... -->
            <div class="card">
                <div class="crash-game-container">
                    <h2 class="card-title">Crash Game</h2>
                    <p style="color: var(--text-gray); margin-bottom: 20px;">Играйте только за STARS! Успейте вывести до краша</p>
                    
                    <div class="crash-multiplier" id="crash-multiplier">1.00x</div>
                    
                    <div class="crash-graph" id="crash-graph">
                        <div class="crash-line" id="crash-line"></div>
                    </div>
                    
                    <div class="crash-history" id="crash-history">
                        <!-- История крашей будет загружена динамически -->
                    </div>

                    <div class="crash-info">
                        <h3>📊 Статистика рисков</h3>
                        <div class="crash-risk-indicator">
                            <div class="risk-level" id="risk-low">Низкий риск</div>
                            <div class="risk-level active" id="risk-medium">Средний риск</div>
                            <div class="risk-level" id="risk-high">Высокий риск</div>
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-gray);">
                            • Шанс моментального краша: <span id="instant-crash-chance">5%</span><br>
                            • Шанс краша до 2x: <span id="early-crash-chance">25%</span><br>
                            • Максимальный множитель: <span id="max-multiplier">10.0x</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="crash-bet-amount">Сумма ставки (STARS)</label>
                        <input type="number" id="crash-bet-amount" class="form-control" placeholder="Введите сумму" min="1" step="1">
                        <div style="margin-top: 10px; font-size: 0.9rem; color: var(--text-gray);">
                            Доступно: <span id="available-stars">0</span> STARS
                        </div>
                    </div>
                    
                    <div class="crash-controls">
                        <div class="crash-bet-input">
                            <button id="btn-crash-bet" class="btn btn-block">Сделать ставку</button>
                        </div>
                        <div class="crash-bet-button">
                            <button id="btn-crash-cashout" class="btn crash-cashout-button" disabled>Забрать</button>
                        </div>
                    </div>
                    
                    <div id="crash-result" class="result"></div>
                </div>
            </div>
        </div>

        <!-- НОВАЯ Вкладка "Слоты" -->
        <div id="slots" class="tab-content">
            <div class="card">
                <div class="slots-container">
                    <h2 class="card-title">NFT Слоты</h2>
                    <p style="color: var(--text-gray); margin-bottom: 24px;">Используйте улучшенные NFT для игры в слотах. Рискуйте и получайте награды!</p>
                    
                    <div class="slots-machine" id="slots-machine">
                        <div class="slot-reel" id="slot-reel-1">🎰</div>
                        <div class="slot-reel" id="slot-reel-2">🎰</div>
                        <div class="slot-reel" id="slot-reel-3">🎰</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Выберите улучшенный NFT для ставки</label>
                        <div class="slots-nft-selector" id="slots-nft-selector">
                            <!-- NFT для слотов будут загружены динамически -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div style="background: var(--dark-element); padding: 20px; border-radius: 16px; margin-bottom: 20px;">
                            <h3 style="color: var(--primary); margin-bottom: 12px;">Правила игры:</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div style="background: rgba(0, 200, 81, 0.1); padding: 16px; border-radius: 12px;">
                                    <div style="font-weight: bold; color: var(--success); margin-bottom: 8px;">🎰 3 одинаковых смайла</div>
                                    <div style="font-size: 0.9rem;">Вы получаете 2 таких же улучшенных NFT</div>
                                </div>
                                <div style="background: rgba(255, 200, 0, 0.1); padding: 16px; border-radius: 12px;">
                                    <div style="font-weight: bold; color: #FFD700; margin-bottom: 8px;">💰 7 7 7</div>
                                    <div style="font-size: 0.9rem;">Вы получаете NFT с черным фоном (самое ценное улучшение)</div>
                                </div>
                                <div style="background: rgba(255, 255, 255, 0.1); padding: 16px; border-radius: 12px;">
                                    <div style="font-weight: bold; color: var(--text-light); margin-bottom: 8px;">🎲 2 одинаковых смайла</div>
                                    <div style="font-size: 0.9rem;">Ваш NFT сохраняется</div>
                                </div>
                                <div style="background: rgba(255, 68, 68, 0.1); padding: 16px; border-radius: 12px;">
                                    <div style="font-weight: bold; color: var(--danger); margin-bottom: 8px;">💥 Ничего не совпало</div>
                                    <div style="font-size: 0.9rem;">NFT пропадает</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="slot-result" id="slot-result"></div>
                    
                    <button id="btn-spin-slots" class="btn btn-block" disabled>Крутить слоты</button>
                </div>
            </div>
        </div>

        <!-- НОВАЯ Вкладка "Акции" -->
        <div id="stocks" class="tab-content">
            <div class="card">
                <div class="stocks-container">
                    <h2 class="card-title">Биржевые Акции</h2>
                    <p style="color: var(--text-gray); margin-bottom: 24px;">Инвестируйте в акции компаний и получайте дивиденды</p>
                    
                    <div class="broker-balance">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Брокерский счет</div>
                                <div style="font-size: 2rem; font-weight: bold;" id="broker-balance">0 ₽</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Рублевый счет</div>
                                <div style="font-size: 1.2rem; font-weight: bold;">5,000 ₽</div>
                            </div>
                        </div>
                        <div style="margin-top: 16px;">
                            <div style="display: flex; gap: 12px;">
                                <input type="number" id="transfer-to-broker" class="form-control" placeholder="Сумма для перевода" style="flex: 2;">
                                <button id="btn-transfer-to-broker" class="btn" style="flex: 1;">→ Брокерский</button>
                                <button id="btn-transfer-from-broker" class="btn btn-outline" style="flex: 1;">← Рублевый</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stocks-list" id="stocks-list">
                        <!-- Акции будут загружены динамически -->
                    </div>
                    
                    <div class="owned-stocks-info">
                        <h3 style="color: var(--primary); margin-bottom: 16px;">Мои инвестиции</h3>
                        <div id="owned-stocks-list">
                            <!-- Инвестиции будут загружены динамически -->
                        </div>
                        <div id="dividends-info" style="margin-top: 20px; padding: 16px; background: rgba(0, 200, 81, 0.1); border-radius: 12px; display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: bold; color: var(--success);">🎁 Дивиденды</div>
                                    <div style="font-size: 0.9rem;">Выплата каждые 2 минуты</div>
                                </div>
                                <div style="font-size: 1.4rem; font-weight: bold; color: var(--success);" id="dividends-amount">0 ₽</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Вкладка "Кошельки" -->
        <div id="wallets" class="tab-content">
            <div class="card">
                <h2 class="card-title">Криптокошелек</h2>
                
                <div class="balance-card">
                    <div class="balance-info">
                        <div class="balance-icon">B</div>
                        <div>
                            <div>Bitcoin (BTC)</div>
                            <div class="balance-change">+2.1% за сутки</div>
                        </div>
                    </div>
                    <div>
                        <div class="balance-amount" id="btc-balance">0.005 BTC</div>
                        <div class="balance-change" id="btc-value">$0</div>
                    </div>
                </div>
                
                <div class="balance-card">
                    <div class="balance-info">
                        <div class="balance-icon">E</div>
                        <div>
                            <div>Ethereum (ETH)</div>
                            <div class="balance-change">+1.5% за сутки</div>
                        </div>
                    </div>
                    <div>
                        <div class="balance-amount" id="eth-balance">0.05 ETH</div>
                        <div class="balance-change" id="eth-value">$0</div>
                    </div>
                </div>
                
                <div class="balance-card">
                    <div class="balance-info">
                        <div class="balance-icon">T</div>
                        <div>
                            <div>Toncoin (TON)</div>
                            <div class="balance-change">+3.2% за сутки</div>
                        </div>
                    </div>
                    <div>
                        <div class="balance-amount" id="ton-balance">50 TON</div>
                        <div class="balance-change" id="ton-value">$0</div>
                    </div>
                </div>

                <div class="balance-card">
                    <div class="balance-info">
                        <div class="balance-icon">⭐</div>
                        <div>
                            <div>Звезды (STARS)</div>
                            <div class="balance-change">+1.8% за сутки</div>
                        </div>
                    </div>
                    <div>
                        <div class="balance-amount" id="stars-balance">0 STARS</div>
                        <div class="balance-change" id="stars-value">0 ₽</div>
                    </div>
                </div>

                <!-- Новый баланс для Catcoins -->
                <div class="balance-card" id="catcoin-balance-card" style="display: none;">
                    <div class="balance-info">
                        <div class="balance-icon">🐱</div>
                        <div>
                            <div>Catcoins (CAT)</div>
                            <div class="balance-change">Новая валюта</div>
                        </div>
                    </div>
                    <div>
                        <div class="balance-amount" id="cat-balance">0 CAT</div>
                        <div class="balance-change" id="cat-value">0 TON</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">Рублевый кошелек</h2>
                
                <div class="balance-card">
                    <div class="balance-info">
                        <div class="balance-icon">₽</div>
                        <div>
                            <div>Российский рубль (RUB)</div>
                            <div class="balance-change">Стабильный</div>
                        </div>
                    </div>
                    <div>
                        <div class="balance-amount" id="rub-balance">5,000 ₽</div>
                    </div>
                </div>
                
                <!-- НОВЫЙ Брокерский кошелек -->
                <div class="balance-card broker-balance">
                    <div class="balance-info">
                        <div class="balance-icon">📈</div>
                        <div>
                            <div>Брокерский счет (RUB)</div>
                            <div class="balance-change">Для инвестиций в акции</div>
                        </div>
                    </div>
                    <div>
                        <div class="balance-amount" id="broker-balance-wallet">0 ₽</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">История операций</h2>
                <div class="transaction-history" id="transaction-history">
                    <!-- История операций будет загружена динамически -->
                </div>
            </div>
        </div>

        <!-- Вкладка "Конвертация" -->
        <div id="conversion" class="tab-content">
            <!-- ... (существующий код конвертации без изменений) ... -->
            <div class="card">
                <h2 class="card-title">Конвертация валют</h2>
                
                <div class="conversion-direction">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" for="from-currency">Из</label>
                        <select id="from-currency" class="form-control">
                            <option value="RUB">Рубли (RUB)</option>
                            <option value="BTC">Bitcoin (BTC)</option>
                            <option value="ETH">Ethereum (ETH)</option>
                            <option value="TON">Toncoin (TON)</option>
                            <option value="STARS">Звезды (STARS)</option>
                            <option value="CAT" id="cat-from-option" style="display: none;">Catcoins (CAT)</option>
                        </select>
                    </div>
                    
                    <div class="direction-arrow">⇄</div>
                    
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" for="to-currency">В</label>
                        <select id="to-currency" class="form-control">
                            <option value="BTC">Bitcoin (BTC)</option>
                            <option value="ETH">Ethereum (ETH)</option>
                            <option value="TON">Toncoin (TON)</option>
                            <option value="STARS">Звезды (STARS)</option>
                            <option value="RUB">Рубли (RUB)</option>
                            <option value="CAT" id="cat-to-option" style="display: none;">Catcoins (CAT)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="conversion-amount">Сумма</label>
                    <input type="number" id="conversion-amount" class="form-control" placeholder="Введите сумму">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="conversion-result">Результат</label>
                    <input type="text" id="conversion-result" class="form-control" readonly>
                </div>
                
                <div style="margin-bottom: 24px; padding: 16px; background: var(--gradient-primary); border-radius: 12px; color: white;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Курс:</span>
                        <span id="conversion-rate">1 BTC = 0 ₽</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <span>Комиссия (2%):</span>
                        <span id="conversion-fee">0</span>
                    </div>
                </div>
                
                <button id="btn-convert" class="btn btn-block">Конвертировать</button>
            </div>
        </div>

        <!-- Вкладка "NFT Маркет" -->
        <div id="nft-market" class="tab-content">
            <!-- ... (существующий код NFT маркета без изменений) ... -->
            <div class="card">
                <h2 class="card-title">NFT Маркет</h2>
                <p style="color: var(--text-gray); margin-bottom: 24px;">Покупайте уникальные NFT за Звезды</p>
                
                <div class="nft-grid" id="nft-market-grid">
                    <!-- NFT будут загружены динамически -->
                </div>
            </div>
        </div>

        <!-- Вкладка "Инвентарь" -->
        <div id="inventory" class="tab-content">
            <!-- ... (существующий код инвентаря без изменений) ... -->
            <div class="card">
                <h2 class="card-title">Мои NFT</h2>
                <p style="color: var(--text-gray); margin-bottom: 24px;">Ваша коллекция NFT</p>
                
                <div class="nft-grid" id="inventory-grid">
                    <!-- Инвентарь будет загружен динамически -->
                </div>
            </div>
        </div>

        <!-- Вкладка "Улучшение" -->
        <div id="upgrade" class="tab-content">
            <!-- ... (существующий код улучшения без изменений) ... -->
            <div class="card">
                <div class="nft-upgrade-container">
                    <h2 class="card-title">Улучшение NFT</h2>
                    <p style="color: var(--text-gray); margin-bottom: 24px;">Выберите NFT для улучшения и получите случайный цвет фона</p>
                    
                    <div class="form-group">
                        <label class="form-label">Выберите NFT для улучшения</label>
                        <div class="nft-selector" id="nft-upgrade-selector">
                            <!-- NFT для улучшения будут загружены динамически -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Информация об улучшении</label>
                        <div style="background: var(--dark-element); padding: 20px; border-radius: 16px; margin-bottom: 20px;">
                            <h3 style="color: var(--primary); margin-bottom: 12px;">Шансы улучшения:</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                <div style="background: #000000; color: white; padding: 12px; border-radius: 8px;">
                                    <div>Черный (x4)</div>
                                    <div style="font-size: 0.9rem;">Шанс: 0.5%</div>
                                </div>
                                <div style="background: #FF6B35; color: white; padding: 12px; border-radius: 8px;">
                                    <div>Оранжевый (x3)</div>
                                    <div style="font-size: 0.9rem;">Шанс: 2%</div>
                                </div>
                                <div style="background: #1E3A8A; color: white; padding: 12px; border-radius: 8px;">
                                    <div>Синий (x2.5)</div>
                                    <div style="font-size: 0.9rem;">Шанс: 5%</div>
                                </div>
                                <div style="background: #DC2626; color: white; padding: 12px; border-radius: 8px;">
                                    <div>Красный (x2)</div>
                                    <div style="font-size: 0.9rem;">Шанс: 8%</div>
                                </div>
                                <div style="background: #059669; color: white; padding: 12px; border-radius: 8px;">
                                    <div>Зеленый (x1.5)</div>
                                    <div style="font-size: 0.9rem;">Шанс: 12%</div>
                                </div>
                            </div>
                            <div style="margin-top: 12px; color: var(--text-gray); font-size: 0.9rem;">
                                * Цена улучшенного NFT фиксируется и не меняется динамически
                            </div>
                        </div>
                    </div>
                    
                    <div class="upgrade-animation-container" id="upgrade-animation">
                        <div class="upgrade-animation" id="upgrade-animation-content">
                            <!-- Анимация будет создана динамически -->
                        </div>
                    </div>
                    
                    <div class="upgrade-result" id="upgrade-result"></div>
                    
                    <button id="btn-upgrade-nft" class="btn btn-block" disabled>Улучшить выбранный NFT</button>
                </div>
            </div>
        </div>

        <!-- Вкладка "Кликер" -->
        <div id="clicker" class="tab-content">
            <!-- ... (существующий код кликера без изменений) ... -->
            <div class="card">
                <div class="clicker-container">
                    <h2 class="card-title">Catcoin Кликер</h2>
                    <p style="color: var(--text-gray); margin-bottom: 24px;">Кликайте по кнопке, чтобы зарабатывать Catcoins!</p>
                    
                    <div class="catcoin-display" id="catcoin-amount">0 CAT</div>
                    
                    <button class="clicker-button" id="clicker-button">
                        🐱<br>Клик!
                    </button>
                    
                    <div class="clicker-stats">
                        <div class="clicker-stat">
                            <div class="clicker-stat-value" id="clicker-per-click">1</div>
                            <div class="clicker-stat-label">Коинов за клик</div>
                        </div>
                        <div class="clicker-stat">
                            <div class="clicker-stat-value" id="clicker-auto-rate">0</div>
                            <div class="clicker-stat-label">Коинов в секунду</div>
                        </div>
                        <div class="clicker-stat">
                            <div class="clicker-stat-value" id="clicker-total-clicks">0</div>
                            <div class="clicker-stat-label">Всего кликов</div>
                        </div>
                    </div>
                    
                    <div class="clicker-upgrades">
                        <div class="clicker-upgrade-card">
                            <h3>Улучшить клик</h3>
                            <p style="color: var(--text-gray); margin-bottom: 12px;">+1 коин за каждый клик</p>
                            <div class="clicker-upgrade-price" id="click-upgrade-price">10 TON</div>
                            <button class="btn btn-block" id="btn-upgrade-click">Купить улучшение</button>
                        </div>
                        
                        <div class="clicker-upgrade-card">
                            <h3>Автокликер</h3>
                            <p style="color: var(--text-gray); margin-bottom: 12px;">+1 коин каждую секунду</p>
                            <div class="clicker-upgrade-price" id="auto-clicker-price">50 TON</div>
                            <button class="btn btn-block" id="btn-buy-auto-clicker">Купить автокликер</button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 24px; padding: 20px; background: var(--dark-element); border-radius: 16px;">
                        <h3 style="color: var(--primary); margin-bottom: 12px;">Конвертация Catcoins</h3>
                        <p style="color: var(--text-gray); margin-bottom: 16px; font-size: 0.9rem;" id="conversion-status">
                            ⚠️ Конвертация недоступна. Администратор должен добавить Catcoin в листинг.
                        </p>
                        <div style="display: flex; gap: 16px;">
                            <div style="flex: 2;">
                                <input type="number" id="catcoin-convert-amount" class="form-control" placeholder="Введите количество CAT" disabled>
                            </div>
                            <div style="flex: 1;">
                                <button class="btn btn-block" id="btn-convert-catcoin" disabled>→ TON</button>
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.9rem; color: var(--text-gray);">
                            Курс: 1 CAT = 0.001 TON
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Вкладка "Ввод средств" -->
        <div id="deposit" class="tab-content">
            <!-- ... (существующий код ввода средств без изменений) ... -->
            <div class="card">
                <h2 class="card-title">Пополнение рублевого кошелька</h2>
                
                <div class="form-group">
                    <label class="form-label" for="card-number">Номер карты</label>
                    <input type="text" id="card-number" class="form-control" placeholder="XXXX XXXX XXXX XXXX" maxlength="19">
                </div>
                
                <div style="display: flex; gap: 16px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" for="card-expiry">Срок действия</label>
                        <input type="text" id="card-expiry" class="form-control" placeholder="MM/YY" maxlength="5">
                    </div>
                    
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" for="card-cvc">CVC/CVV</label>
                        <input type="text" id="card-cvc" class="form-control" placeholder="XXX" maxlength="3">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="deposit-amount">Сумма пополнения</label>
                    <input type="number" id="deposit-amount" class="form-control" placeholder="Введите сумму" min="1" max="70000">
                    <div style="margin-top: 10px; font-size: 0.9rem; color: var(--text-gray);">
                        Максимальная сумма: 70,000 ₽
                    </div>
                </div>
                
                <button id="btn-deposit" class="btn btn-block">Пополнить</button>
            </div>
        </div>

        <!-- Вкладка "Вывод средств" -->
        <div id="withdraw" class="tab-content">
            <!-- ... (существующий код вывода средств без изменений) ... -->
            <div class="card">
                <h2 class="card-title">Вывод рублей на карту</h2>
                
                <div class="form-group">
                    <label class="form-label" for="withdraw-card-number">Номер карты</label>
                    <input type="text" id="withdraw-card-number" class="form-control" placeholder="XXXX XXXX XXXX XXXX" maxlength="19">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="withdraw-amount">Сумма вывода</label>
                    <input type="number" id="withdraw-amount" class="form-control" placeholder="Введите сумму" min="1">
                    <div style="margin-top: 10px; font-size: 0.9rem; color: var(--text-gray);">
                        Доступно: <span id="available-balance">5,000</span> ₽
                    </div>
                </div>
                
                <button id="btn-withdraw" class="btn btn-block">Вывести</button>
            </div>
        </div>

        <!-- Вкладка "Профиль" -->
        <div id="profile" class="tab-content">
            <!-- ... (существующий код профиля без изменений) ... -->
            <div class="card">
                <div class="profile-info">
                    <div class="profile-avatar" id="profile-avatar">U</div>
                    <h2 id="profile-username">Пользователь</h2>
                    <p style="color: var(--text-gray);">Аккаунт создан: <span id="profile-created">-</span></p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-wins">0</div>
                        <div class="stat-label">Всего побед</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-losses">0</div>
                        <div class="stat-label">Всего поражений</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-nfts">0</div>
                        <div class="stat-label">NFT в коллекции</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="crash-wins">0</div>
                        <div class="stat-label">Побед в Crash</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-upgrades">0</div>
                        <div class="stat-label">Улучшенных NFT</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-clicks">0</div>
                        <div class="stat-label">Всего кликов</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <button id="btn-logout" class="btn btn-outline btn-block">Выйти из аккаунта</button>
                </div>
                
                <div class="form-group">
                    <button id="btn-delete-account" class="btn btn-danger btn-block">Удалить аккаунт</button>
                </div>
            </div>
        </div>

        <!-- Вкладка "Админ" -->
        <div id="admin" class="tab-content">
            <!-- ... (существующий код админ панели без изменений) ... -->
            <div class="card">
                <h2 class="card-title">Админ панель</h2>
                <p style="color: var(--text-gray); margin-bottom: 24px;">Управление настройками системы</p>
                
                <div class="form-group">
                    <h3 style="margin-bottom: 16px;">Управление удачей</h3>
                    <div style="background: var(--gradient-primary); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span>Режим 2x удачи:</span>
                            <span id="double-luck-status" style="color: var(--success); font-weight: 600;">АКТИВЕН</span>
                        </div>
                        <p style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 16px;">
                            В этом режиме шанс выигрыша увеличивается до 90% для всех пользователей
                        </p>
                        <div style="display: flex; gap: 12px;">
                            <button id="btn-enable-luck" class="btn btn-success" style="flex: 1;">Включить 2x удачу</button>
                            <button id="btn-disable-luck" class="btn btn-danger" style="flex: 1;">Выключить 2x удачу</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <h3 style="margin-bottom: 16px;">Управление Catcoin</h3>
                    <div style="background: var(--gradient-primary); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span>Статус листинга:</span>
                            <span id="catcoin-listing-status" style="color: var(--danger); font-weight: 600;">НЕ В ЛИСТИНГЕ</span>
                        </div>
                        <p style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 16px;">
                            Когда Catcoin в листинге, его можно конвертировать в TON. После анлистинга конвертация прекращается.
                        </p>
                        <div style="display: flex; gap: 12px;">
                            <button id="btn-enable-catcoin" class="btn btn-success" style="flex: 1;">Добавить в листинг</button>
                            <button id="btn-disable-catcoin" class="btn btn-danger" style="flex: 1;">Убрать из листинга</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <h3 style="margin-bottom: 16px;">Статистика системы</h3>
                    <div style="background: var(--gradient-primary); padding: 20px; border-radius: 12px; color: white;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Всего пользователей:</span>
                            <span id="total-users">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Активных сессий:</span>
                            <span id="active-sessions">1</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Режим удачи:</span>
                            <span id="luck-mode-status">2x УДАЧА</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <h3 style="margin-bottom: 16px;">Баланс администратора</h3>
                    <div style="background: var(--gradient-primary); padding: 20px; border-radius: 12px; color: white;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                            <span>Комиссионный счет:</span>
                            <span id="admin-commission-balance" style="color: var(--primary); font-weight: 600;">0 ₽</span>
                        </div>
                        <p style="opacity: 0.9; font-size: 0.9rem;">
                            2% от всех конвертаций поступают на этот счет
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Вкладка "Банк" -->
        <div id="bank" class="tab-content">
            <div class="bank-container">
                <div class="container">
                    <div class="bank-header">
                        <h1 style="text-align: center; font-size: 3rem; margin-bottom: 12px;">🏦 Digital Bank</h1>
                        <p style="text-align: center; opacity: 0.9; font-size: 1.1rem;">Ваш надежный финансовый партнер</p>
                    </div>

                    <button class="btn back-to-trading" onclick="switchToTab('trade')">← Вернуться к трейдингу</button>

                    <div class="bank-tabs">
                        <div class="bank-tab active" data-bank-tab="main">Главная</div>
                        <div class="bank-tab" data-bank-tab="cards">Мои карты</div>
                        <div class="bank-tab" data-bank-tab="credit">Кредиты</div>
                        <div class="bank-tab" data-bank-tab="documents">Документы</div>
                        <div class="bank-tab" data-bank-tab="documents-shop">Магазин документов</div>
                        <div class="bank-tab" data-bank-tab="properties">Недвижимость</div>
                        <div class="bank-tab" data-bank-tab="yachts">Яхты</div>
                        <div class="bank-tab" data-bank-tab="paintings">Картины</div>
                    </div>

                    <!-- Главная вкладка банка -->
                    <div id="bank-main" class="bank-content active">
                        <div class="bank-card">
                            <h2 style="color: var(--bank-blue); margin-bottom: 24px;">Финансовый обзор</h2>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 36px;">
                                <div style="background: var(--gradient-success); color: white; padding: 24px; border-radius: 16px;">
                                    <h3 style="margin-bottom: 12px;">Баланс счета</h3>
                                    <div style="font-size: 2.5rem; font-weight: bold;" id="bank-balance">0 ₽</div>
                                </div>
                                
                                <div style="background: var(--gradient-danger); color: white; padding: 24px; border-radius: 16px;">
                                    <h3 style="margin-bottom: 12px;">Кредитный долг</h3>
                                    <div style="font-size: 2.5rem; font-weight: bold;" id="credit-debt">0 ₽</div>
                                </div>
                            </div>

                            <div class="form-group">
                                <h3 style="color: var(--bank-blue); margin-bottom: 16px;">Пополнить банковский счет</h3>
                                <div style="background-color: var(--bank-gray); padding: 24px; border-radius: 16px;">
                                    <div class="form-group">
                                        <label class="form-label" style="color: var(--bank-blue);">Начальный депозит</label>
                                        <input type="number" id="initial-deposit" class="form-control" placeholder="Введите сумму (макс. 1,000,000 ₽)" min="0" max="1000000">
                                        <div style="margin-top: 10px; font-size: 0.9rem; color: var(--text-gray);">
                                            Можно установить только один раз при первом посещении банка
                                            <span id="admin-deposit-note" style="color: var(--success); display: none;">Для администратора ограничений нет</span>
                                        </div>
                                    </div>
                                    <button id="btn-set-deposit" class="btn btn-bank btn-block">Установить начальный депозит</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Мои карты -->
                    <div id="bank-cards" class="bank-content">
                        <div class="bank-card">
                            <h2 style="color: var(--bank-blue); margin-bottom: 24px;">Мои банковские карты</h2>
                            
                            <div id="cards-list">
                                <!-- Карты будут загружены динамически -->
                            </div>

                            <div class="form-group" style="margin-top: 36px;">
                                <button id="btn-add-card" class="btn btn-bank btn-block">
                                    Добавить новую карту
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Кредиты -->
                    <div id="bank-credit" class="bank-content">
                        <div class="bank-card">
                            <h2 style="color: var(--bank-blue); margin-bottom: 24px;">Кредитные услуги</h2>
                            
                            <div id="credit-info">
                                <!-- Информация о кредите будет загружена динамически -->
                            </div>

                            <div class="form-group" style="margin-top: 36px;">
                                <div style="background-color: var(--bank-gray); padding: 24px; border-radius: 16px;">
                                    <h3 style="color: var(--bank-blue); margin-bottom: 16px;">Взять кредит</h3>
                                    <div class="form-group">
                                        <label class="form-label" style="color: var(--bank-blue);">Сумма кредита</label>
                                        <input type="number" id="credit-amount" class="form-control" placeholder="Введите сумму кредита" min="1000" max="500000">
                                    </div>
                                    <div style="color: var(--text-gray); font-size: 0.9rem; margin-bottom: 16px;">
                                        Процентная ставка: <span id="credit-interest-rate">15%</span> годовых. Максимальный срок: 12 месяцев
                                    </div>
                                    <button id="btn-take-credit" class="btn btn-bank btn-block">Взять кредит</button>
                                </div>
                            </div>

                            <!-- Погашение кредита частями -->
                            <div id="partial-repayment-section" style="display: none;">
                                <div class="form-group" style="margin-top: 36px;">
                                    <div style="background-color: var(--bank-gray); padding: 24px; border-radius: 16px;">
                                        <h3 style="color: var(--bank-blue); margin-bottom: 16px;">Погашение кредита</h3>
                                        <div class="form-group">
                                            <label class="form-label" style="color: var(--bank-blue);">Сумма погашения</label>
                                            <input type="number" id="repayment-amount" class="form-control" placeholder="Введите сумму для погашения">
                                        </div>
                                        <button id="btn-partial-repay" class="btn btn-bank btn-block">Погасить часть кредита</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Документы -->
                    <div id="bank-documents" class="bank-content">
                        <div class="bank-card">
                            <h2 style="color: var(--bank-blue); margin-bottom: 24px;">Документы на недвижимость</h2>
                            <p style="color: var(--text-gray); margin-bottom: 24px;">Для покупки недвижимости необходим подтвержденный документ соответствующего типа</p>
                            
                            <div id="documents-list">
                                <!-- Документы будут загружены динамически -->
                            </div>

                            <div class="form-group" style="margin-top: 36px;">
                                <div style="background-color: var(--bank-gray); padding: 24px; border-radius: 16px;">
                                    <h3 style="color: var(--bank-blue); margin-bottom: 16px;">Создать новый документ</h3>
                                    <div class="form-group">
                                        <label class="form-label" style="color: var(--bank-blue);">Имя владельца</label>
                                        <input type="text" id="document-owner" class="form-control" placeholder="Введите ваше полное имя">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" style="color: var(--bank-blue);">Тип недвижимости</label>
                                        <select id="document-type" class="form-control">
                                            <option value="car">Автомобиль</option>
                                            <option value="property">Недвижимость (дом/квартира/вилла)</option>
                                            <option value="yacht">Яхта</option>
                                        </select>
                                    </div>
                                    <button id="btn-create-document" class="btn btn-bank btn-block">Создать документ</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Магазин документов -->
                    <div id="bank-documents-shop" class="bank-content">
                        <div class="bank-card">
                            <h2 style="color: var(--bank-blue); margin-bottom: 24px;">Магазин документов</h2>
                            <p style="color: var(--text-gray); margin-bottom: 24px;">Приобретите дополнительные документы для покупки недвижимости</p>
                            
                            <div class="property-grid" id="documents-shop-list">
                                <!-- Товары магазина документов будут загружены динамически -->
                            </div>
                        </div>
                    </div>

                    <!-- Недвижимость -->
                    <div id="bank-properties" class="bank-content">
                        <div class="bank-card">
                            <h2 style="color: var(--bank-blue); margin-bottom: 24px;">Недвижимость и транспорт</h2>
                            <p style="color: var(--text-gray); margin-bottom: 24px;">Инвестируйте в недвижимость и транспортные средства</p>
                            
                            <div id="properties-requirements" style="background-color: #fff3cd; color: #856404; padding: 20px; border-radius: 12px; margin-bottom: 24px; display: none;">
                                <strong>Требование:</strong> Для покупки недвижимости необходим подтвержденный документ соответствующего типа. Перейдите во вкладку "Документы".
                            </div>
                            
                            <div class="property-grid" id="properties-list">
                                <!-- Недвижимость будет загружена динамически -->
                            </div>
                        </div>
                    </div>

                    <!-- Яхты -->
                    <div id="bank-yachts" class="bank-content">
                        <div class="bank-card">
                            <h2 style="color: var(--bank-blue); margin-bottom: 24px;">Яхты</h2>
                            <p style="color: var(--text-gray); margin-bottom: 24px;">Эксклюзивные яхты для настоящих ценителей роскоши</p>
                            
                            <div id="yachts-requirements" style="background-color: #fff3cd; color: #856404; padding: 20px; border-radius: 12px; margin-bottom: 24px; display: none;">
                                <strong>Требование:</strong> Для покупки яхты необходим подтвержденный документ типа "Яхта". Перейдите во вкладку "Документы".
                            </div>
                            
                            <div id="yachts-list">
                                <!-- Яхты будут загружены динамически -->
                            </div>
                        </div>
                    </div>

                    <!-- НОВАЯ Вкладка "Картины" -->
                    <div id="bank-paintings" class="bank-content">
                        <div class="bank-card">
                            <h2 style="color: var(--bank-blue); margin-bottom: 24px;">Эксклюзивные Картины</h2>
                            <p style="color: var(--text-gray); margin-bottom: 24px;">Самые дорогие и редкие произведения искусства. Не требуют документов для покупки.</p>
                            
                            <div class="paintings-grid" id="paintings-list">
                                <!-- Картины будут загружены динамически -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Вкладка "Fragment" -->
<div id="fragment" class="tab-content">
    <div class="fragment-container">
        <div class="fragment-header">
            <h1 style="text-align: center; font-size: 3rem; margin-bottom: 12px; background: linear-gradient(135deg, #8B5CF6, #7C3AED); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">✨ Fragment</h1>
            <p style="text-align: center; color: var(--text-gray); font-size: 1.1rem;">Покупка и продажа эксклюзивных ников и NFT</p>
        </div>

        <div class="fragment-tabs">
            <div class="fragment-tab active" data-fragment-tab="nicks">Ники</div>
            <div class="fragment-tab" data-fragment-tab="nft-market">Рынок NFT</div>
        </div>

        <!-- Вкладка "Ники" -->
        <div id="fragment-nicks" class="fragment-content active">
            <div class="card">
                <h2 class="card-title">Ваши ники</h2>
                
                <div class="profile-info" style="margin-bottom: 30px;">
                    <div class="profile-avatar" id="current-nick-avatar">U</div>
                    <h2 id="current-nick-display">@user</h2>
                    <p style="color: var(--text-gray); margin-top: 10px;" id="additional-nicks-display">
                        <!-- Дополнительные ники будут загружены динамически -->
                    </p>
                </div>

                <div class="card">
                    <h3 class="card-title">Доступные ники для покупки</h3>
                    <p style="color: var(--text-gray); margin-bottom: 24px;">Ники можно купить только за STARS и продать только за TON</p>
                    
                    <div class="nicks-grid" id="nicks-market-grid">
                        <!-- Ники будут загружены динамически -->
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Продажа ников</h3>
                    <div class="form-group">
                        <label class="form-label" for="sell-nick-select">Выберите ник для продажи</label>
                        <select id="sell-nick-select" class="form-control">
                            <!-- Ники для продажи будут загружены динамически -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Текущая цена продажи</label>
                        <input type="text" id="sell-nick-price" class="form-control" readonly>
                    </div>
                    
                    <button id="btn-sell-nick" class="btn btn-danger btn-block">Продать выбранный ник</button>
                </div>
            </div>
        </div>

        <!-- Вкладка "Рынок NFT" -->
        <div id="fragment-nft-market" class="fragment-content">
            <div class="card">
                <h2 class="card-title">Рынок улучшенных NFT</h2>
                <p style="color: var(--text-gray); margin-bottom: 24px;">Покупайте и продавайте улучшенные NFT на бирже</p>
                
                <div class="nft-grid" id="fragment-nft-grid">
                    <!-- Улучшенные NFT на рынке будут загружены динамически -->
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">Продать NFT на рынке</h2>
                
                <div class="form-group">
                    <label class="form-label">Выберите улучшенный NFT для продажи</label>
                    <div class="nft-selector" id="fragment-sell-nft-selector">
                        <!-- Улучшенные NFT для продажи будут загружены динамически -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Цена продажи (STARS)</label>
                    <input type="number" id="fragment-sell-price" class="form-control" placeholder="Введите цену">
                    <div style="margin-top: 10px; font-size: 0.9rem; color: var(--text-gray);">
                        Максимальная цена: <span id="max-sell-price">0</span> STARS (1.8x от рыночной)
                    </div>
                </div>
                
                <div class="form-group">
                    <div style="background: var(--gradient-primary); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white;">
                        <h4>📊 Вероятность продажи</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Без удачи:</span>
                            <span id="sell-chance-normal">45%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>С 2x удачей:</span>
                            <span id="sell-chance-luck">65%</span>
                        </div>
                        <div style="font-size: 0.9rem; margin-top: 10px; opacity: 0.9;">
                            Продажа занимает 2 минуты. Если не продастся, NFT вернется к вам
                        </div>
                    </div>
                </div>
                
                <button id="btn-sell-fragment-nft" class="btn btn-block">Выставить на рынок</button>
            </div>
        </div>
    </div>
</div>
    </div>

    <!-- Уведомление -->
    <div id="notification" class="notification"></div>

    <!-- Модальное окно подтверждения -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Подтверждение операции</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="confirm-message">
                Вы уверены, что хотите выполнить эту операцию?
            </div>
            <div class="modal-footer">
                <button id="confirm-cancel" class="btn btn-outline" style="flex: 1;">Отмена</button>
                <button id="confirm-ok" class="btn" style="flex: 1;">Подтвердить</button>
            </div>
        </div>
    </div>

    <script>
        
        // Функция для безопасного уничтожения всех графиков акций
function destroyAllStockCharts() {
    if (!state.stocks || !state.stocks.stockCharts) return;
    
    for (const key in state.stocks.stockCharts) {
        if (state.stocks.stockCharts[key]) {
            try {
                state.stocks.stockCharts[key].destroy();
            } catch (e) {
                console.log('Ошибка при уничтожении графика', key, ':', e);
            }
            state.stocks.stockCharts[key] = null;
        }
    }
    state.stocks.stockCharts = {};
}
        let chartInitialized = false;
        // Глобальные настройки системы
        const systemSettings = {
            doubleLuckMode: false,
            adminCommission: 0,
            catcoinListed: false
        };

        // Состояние приложения
        const state = {
            balances: {
                RUB: 5000,
                BTC: 0.005,
                ETH: 0.05,
                TON: 50,
                STARS: 0,
                CAT: 0,
                BROKER: 0 // НОВЫЙ брокерский счет
            },
            exchangeRates: {
                BTC: 45000,
                ETH: 2500,
                TON: 5,
                STARS: 100,
                CAT: 0.005 // 1 CAT = 0.001 TON
            },
            transactionHistory: [],
            currentCurrency: 'BTC',
            chart: null,
            priceHistory: {
                BTC: [],
                ETH: [],
                TON: [],
                STARS: [],
                CAT: []
            },
            isTrading: false,
            betAmount: 0,
            betDirection: null,
            nfts: [
                { id: 1, name: "Dog", price: 1500, emoji: "🐕", owned: 0, upgraded: [] },
                { id: 2, name: "Moneyman", price: 2500, emoji: "💼", owned: 0, upgraded: [] },
                { id: 3, name: "Pepe", price: 1800, emoji: "🐸", owned: 0, upgraded: [] },
                { id: 4, name: "Heart", price: 1200, emoji: "💖", owned: 0, upgraded: [] },
                { id: 5, name: "Clock", price: 2200, emoji: "⏰", owned: 0, upgraded: [] },
                { id: 6, name: "PC", price: 3000, emoji: "💻", owned: 0, upgraded: [] },
                { id: 7, name: "MVIDEO", price: 2800, emoji: "📺", owned: 0, upgraded: [] },
                { id: 8, name: "Micro Toy", price: 900, emoji: "🧸", owned: 0, upgraded: [] },
                { id: 9, name: "Burger Pink", price: 1600, emoji: "🍔", owned: 0, upgraded: [] },
                { id: 10, name: "Kitty", price: 1400, emoji: "🐱", owned: 0, upgraded: [] }
            ],
            user: null,
            isAdmin: false,
            bank: {
                balance: 0,
                initialDepositSet: false,
                cards: [],
                credit: {
                    amount: 0,
                    taken: false,
                    takenDate: null,
                    interestRate: 0.15,
                    remainingAmount: 0
                },
                properties: [],
                yachts: [],
                documents: [],
                documentTemplates: 0,
                paintings: [] // НОВЫЕ картины
            },
            // Состояние Crash Game
            crashGame: {
                isRunning: false,
                multiplier: 1.00,
                crashPoint: 0,
                isBetting: false,
                currentBet: 0,
                hasCashedOut: false,
                history: [],
                graphPoints: [],
                gameInterval: null,
                instantCrashChance: 0.5, // 5% шанс моментального краша
                earlyCrashChance: 0.3, // 25% шанс краша до 2x
                maxMultiplier: 10.0
            },
            // Состояние улучшения NFT
            nftUpgrade: {
                selectedNft: null,
                isUpgrading: false,
                upgradeAnimation: null,
                upgradeColors: [
                { name: "черный", class: "nft-black", multiplier: 4, chance: 0.005, rarity: "godlike" },
                { name: "оранжевый", class: "nft-orange", multiplier: 3, chance: 0.02, rarity: "legendary" },
                { name: "синий", class: "nft-blue", multiplier: 2.5, chance: 0.05, rarity: "epic" },
                { name: "красный", class: "nft-red", multiplier: 2, chance: 0.08, rarity: "rare" },
                { name: "зеленый", class: "nft-green", multiplier: 1.5, chance: 0.12, rarity: "uncommon" },
                { name: "фиолетовый", class: "nft-purple", multiplier: 1.3, chance: 0.15, rarity: "uncommon" },
                { name: "белый", class: "nft-white", multiplier: 1.2, chance: 0.20, rarity: "common" },
                { name: "голубой", class: "nft-cyan", multiplier: 1.1, chance: 0.15, rarity: "common" },
                { name: "коричневый", class: "nft-brown", multiplier: 1.05, chance: 0.10, rarity: "common" },
                { name: "желтый", class: "nft-yellow", multiplier: 1.0, chance: 0.10, rarity: "common" }
                ]
            },
            // Состояние кликера
            clicker: {
                coinsPerClick: 1,
                autoClickerRate: 0,
                autoClickerInterval: null,
                totalClicks: 0,
                lastClickTime: 0,
                clickDelay: 100,
                upgrades: {
                    click: { level: 0, basePrice: 10, priceMultiplier: 1.5 },
                    autoClicker: { level: 0, basePrice: 50, priceMultiplier: 2 }
                }
            },
            // Статистика пользователя
            userStats: {
                totalWins: 0,
                totalLosses: 0,
                totalNFTs: 0,
                crashWins: 0,
                totalUpgrades: 0,
                totalClicks: 0,
                slotsWins: 0,
                slotsLosses: 0,
                totalInvested: 0,
                dividendsEarned: 0
            },
            // НОВОЕ: Состояние слотов
            slots: {
                selectedNft: null,
                isSpinning: false,
                slotReels: [null, null, null],
                slotEmojis: ["🍒", "🍋", "🍊", "🍉", "⭐", "🔔", "7️⃣", "💎", "👑", "💖"],
                spinTimeout: null
            },
            // НОВОЕ: Состояние акций
stocks: {
    companies: [
        { id: 1, name: "Tesla", symbol: "TSLA", price: 8500, change: 0, totalShares: 500, ownedShares: 0, chartData: [], dividendRate: 0.02, lastChartUpdate: 0, lastTaxNotification: 0, lastTaxPayment: 0, lastTaxNotificationShown: false },
        { id: 2, name: "Burger King", symbol: "BKG", price: 3200, change: 0, totalShares: 1000, ownedShares: 0, chartData: [], dividendRate: 0.03, lastChartUpdate: 0, lastTaxNotification: 0, lastTaxPayment: 0, lastTaxNotificationShown: false },
        { id: 3, name: "Asus", symbol: "ASUS", price: 1500, change: 0, totalShares: 2500, ownedShares: 0, chartData: [], dividendRate: 0.015, lastChartUpdate: 0, lastTaxNotification: 0, lastTaxPayment: 0, lastTaxNotificationShown: false },
        { id: 4, name: "Google", symbol: "GOOGL", price: 12500, change: 0, totalShares: 250, ownedShares: 0, chartData: [], dividendRate: 0.01, lastChartUpdate: 0, lastTaxNotification: 0, lastTaxPayment: 0, lastTaxNotificationShown: false },
        { id: 5, name: "MasterCard", symbol: "MA", price: 4200, change: 0, totalShares: 750, ownedShares: 0, chartData: [], dividendRate: 0.025, lastChartUpdate: 0, lastTaxNotification: 0, lastTaxPayment: 0, lastTaxNotificationShown: false }
    ],
    stockCharts: {},
    selectedStock: null,
    dividendsTimer: null
},
            // НОВОЕ: Данные картин
            paintings: [
                { id: 1, name: "Мона Лиза", price: 2000000000, emoji: "🎨", description: "Леонардо да Винчи, 1503-1506", owned: false },
                { id: 2, name: "Спаситель мира", price: 1500000000, emoji: "👑", description: "Леонардо да Винчи, ок. 1500", owned: false },
                { id: 3, name: "Обмен", price: 1200000000, emoji: "💱", description: "Виллем де Кунинг, 1955", owned: false },
                { id: 4, name: "Игроки в карты", price: 1000000000, emoji: "♠️", description: "Поль Сезанн, 1894-1895", owned: false }
            ]
        };

                let currencyOptions = [];

        // Данные недвижимости
        const propertiesData = [
            { id: 1, name: "Lamborghini Aventador", price: 25000000, emoji: "🚗", type: "car", documentType: "car" },
            { id: 2, name: "Ferrari F8 Tributo", price: 18000000, emoji: "🏎️", type: "car", documentType: "car" },
            { id: 3, name: "Mercedes S-Class", price: 8000000, emoji: "🚙", type: "car", documentType: "car" },
            { id: 4, name: "Вилла на берегу моря", price: 50000000, emoji: "🏖️", type: "villa", documentType: "property" },
            { id: 5, name: "Пентхаус в центре", price: 35000000, emoji: "🏙️", type: "apartment", documentType: "property" },
            { id: 6, name: "Загородный дом", price: 15000000, emoji: "🏡", type: "house", documentType: "property" }
        ];

        // Данные яхт
        const yachtsData = [
            { id: 1, name: "Luxury Yacht Ocean", price: 120000000, emoji: "🛥️", type: "yacht", length: "45m", documentType: "yacht" },
            { id: 2, name: "Super Yacht Royal", price: 250000000, emoji: "🚤", type: "yacht", length: "65m", documentType: "yacht" },
            { id: 3, name: "Mega Yacht Emperor", price: 500000000, emoji: "⛵", type: "yacht", length: "85m", documentType: "yacht" }
        ];

        // Магазин документов
        const documentsShopData = [
            { id: 1, name: "Базовый пакет документов", price: 50000, description: "Позволяет оформить 1 документ на недвижимость", emoji: "📄" },
            { id: 2, name: "Расширенный пакет", price: 120000, description: "Позволяет оформить 3 документа на недвижимость", emoji: "📑" },
            { id: 3, name: "Премиум пакет", price: 250000, description: "Позволяет оформить 7 документов на недвижимость", emoji: "📂" }
        ];

        // Инициализация приложения
// В конце документа, в DOMContentLoaded, убедитесь что initTradeTab() вызывается правильно:
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM загружен, начинаем инициализацию...');
        // Инициализация вкладки Fragment
    setTimeout(() => {
        initFragmentTab();
    }, 1000);
    
    // Запуск симуляции цен ников
    setTimeout(() => {
        startNickPriceSimulation();
    }, 5000);
    
    // Загрузка системных настроек
    loadSystemSettings();
    
    // Проверка авторизации
    checkAuth();
    
    // Инициализация навигации
    setTimeout(() => {
        initNavigation();
    }, 100);
    
    // Инициализация аутентификации
    initAuth();
    
    // Инициализация вкладки "Игра" (с задержкой для DOM)
    setTimeout(() => {
        initTradeTab();
    }, 500);
    
    // Инициализация графика (сначала не создаем, создадим при переходе на вкладку)
    // initChart(); // ЗАКОММЕНТИРУЙТЕ ЭТУ СТРОКУ
    
    // Инициализация других вкладок
    initCrashGame();
    initSlotsTab();
    initStocksTab();
    initWalletsTab();
    initConversionTab();
    initNFTMarket();
    initInventory();
    initUpgradeTab();
    initClickerTab();
    initDepositTab();
    initWithdrawTab();
    initProfileTab();
    initAdminTab();
    initBankTab();
    
    // Обновление интерфейса
    updateUI();
    
    // Запуск симуляции изменения цен (теперь с задержкой)
    setTimeout(() => {
        startPriceSimulation();
    }, 1000);
    
    // Запуск других симуляций
    setTimeout(() => {
        startNFTPriceSimulation();
        startStockPriceSimulation();
        startAutoCreditRepayment();
        startInterestRateIncrease();
        startAutoClicker();
        startDividendsPayment();
    }, 2000);
    setTimeout(() => {
        console.log('Начинаем инициализацию Fragment...');
        try {
            initFragmentTab();
            
            // Очищаем устаревшие продажи
            setTimeout(() => {
                cleanupOldSales();
            }, 2000);
            
            console.log('Fragment успешно инициализирован');
        } catch (error) {
            console.error('Ошибка инициализации Fragment:', error);
        }
    }, 1500);
    
    // Запуск симуляции цен ников
    setTimeout(() => {
        console.log('Запуск симуляции цен ников...');
        try {
            startNickPriceSimulation();
            console.log('Симуляция цен ников запущена');
        } catch (error) {
            console.error('Ошибка запуска симуляции цен ников:', error);
        }
    }, 6000);

    console.log('Инициализация завершена');
});

        // ==================== НОВЫЕ ФУНКЦИИ ДЛЯ СЛОТОВ ====================

        // Инициализация вкладки "Слоты"
        function initSlotsTab() {
            document.getElementById('btn-spin-slots').addEventListener('click', spinSlots);
            updateSlotsNFTSelector();
        }

        // Обновление селектора NFT для слотов
// Обновление селектора NFT для слотов
function updateSlotsNFTSelector() {
    const selector = document.getElementById('slots-nft-selector');
    selector.innerHTML = '';
    
    // **ИСПРАВЛЕНИЕ: Проверяем не просто owned > 0, а наличие улучшенных NFT**
    const availableNFTs = state.nfts.filter(nft => 
        nft.owned > 0 && nft.upgraded && nft.upgraded.length > 0
    );
    
    if (availableNFTs.length === 0) {
        selector.innerHTML = '<div style="text-align: center; padding: 40px; color: #AAAAAA; grid-column: 1 / -1;">У вас пока нет улучшенных NFT для игры в слотах</div>';
        document.getElementById('btn-spin-slots').disabled = true;
        return;
    }
    
    availableNFTs.forEach(nft => {
        const upgradedCount = nft.upgraded.length;
        
        // **ИСПРАВЛЕНИЕ: Проверяем, что есть хотя бы один улучшенный NFT**
        if (upgradedCount <= 0) return;
        
        const nftItem = document.createElement('div');
        nftItem.className = `slot-nft-item ${state.slots.selectedNft === nft.id ? 'selected' : ''}`;
        nftItem.setAttribute('data-nft-id', nft.id);
        
        // Берем первый улучшенный NFT для отображения
        const upgrade = nft.upgraded[0];
        
        nftItem.innerHTML = `
            <div class="nft-emoji" style="background: ${getColorFromClass(upgrade.colorClass)}; color: white; border-radius: 12px; padding: 10px;">
                ${nft.emoji}
            </div>
            <div style="font-weight: bold; margin-top: 10px;">${nft.name}</div>
            <div style="font-size: 0.9rem; color: #AAAAAA; margin-top: 5px;">
                <span class="nft-upgrade-indicator upgrade-${upgrade.rarity}" style="display: inline-block; margin-bottom: 5px;">
                    ${upgrade.rarity.toUpperCase()}
                </span>
            </div>
            <div style="font-size: 0.8rem; color: var(--primary); margin-top: 5px;">
                Можно использовать: ${upgradedCount}
            </div>
        `;
        
        nftItem.addEventListener('click', function() {
            if (state.slots.isSpinning) return;
            
            document.querySelectorAll('.slot-nft-item').forEach(item => item.classList.remove('selected'));
            this.classList.add('selected');
            state.slots.selectedNft = nft.id;
            document.getElementById('btn-spin-slots').disabled = false;
        });
        
        selector.appendChild(nftItem);
    });
    
    if (selector.children.length === 0) {
        selector.innerHTML = '<div style="text-align: center; padding: 40px; color: #AAAAAA; grid-column: 1 / -1;">Нет доступных NFT для игры</div>';
        document.getElementById('btn-spin-slots').disabled = true;
    }
}

        // Получение цвета из класса
        function getColorFromClass(colorClass) {
            const colors = {
                'nft-black': 'linear-gradient(135deg, #000000, #434343)',
                'nft-orange': 'linear-gradient(135deg, #FF6B35, #FFA62E)',
                'nft-blue': 'linear-gradient(135deg, #1E3A8A, #3B82F6)',
                'nft-red': 'linear-gradient(135deg, #DC2626, #EF4444)',
                'nft-green': 'linear-gradient(135deg, #059669, #10B981)',
                'nft-purple': 'linear-gradient(135deg, #7C3AED, #8B5CF6)',
                'nft-white': 'linear-gradient(135deg, #FFFFFF, #E5E5E5)',
                'nft-cyan': 'linear-gradient(135deg, #0891B2, #06B6D4)',
                'nft-brown': 'linear-gradient(135deg, #78350F, #92400E)',
                'nft-yellow': 'linear-gradient(135deg, #F59E0B, #FBBF24)'
            };
            return colors[colorClass] || 'var(--gradient-primary)';
        }

        // Кручение слотов
        function spinSlots() {
            if (state.slots.isSpinning) return;
            
            const nftId = state.slots.selectedNft;
            if (!nftId) {
                showNotification('Выберите NFT для игры', 'error');
                return;
            }
            
            const nft = state.nfts.find(n => n.id === nftId);
            if (!nft || nft.owned <= 0 || !nft.upgraded || nft.upgraded.length === 0) {
                showNotification('NFT не найден или не улучшен', 'error');
                return;
            }
            
            // Начинаем вращение
            state.slots.isSpinning = true;
            document.getElementById('btn-spin-slots').disabled = true;
            
            // Анимация вращения
            const reels = [
                document.getElementById('slot-reel-1'),
                document.getElementById('slot-reel-2'),
                document.getElementById('slot-reel-3')
            ];
            
            reels.forEach(reel => {
                reel.classList.add('spinning');
                reel.textContent = '';
            });
            
            // Генерация результатов
            setTimeout(() => {
                const results = generateSlotResults();
                stopSlotAnimation(reels, results);
            }, 2000);
        }

        // Генерация результатов слотов
        function generateSlotResults() {
            const results = [];
            for (let i = 0; i < 3; i++) {
                // Увеличиваем шанс выигрыша в режиме удачи
                let winChance = 0.25; // 15% шанс на удачный символ
                if (systemSettings.doubleLuckMode) {
                    winChance = 0.5; // 30% в режиме удачи
                }
                
                if (Math.random() < winChance) {
                    // Шанс на 777 (1%)
                    if (Math.random() < 0.01) {
                        results.push('7️⃣');
                    } else {
                        // Выбираем случайный смайл
                        results.push(state.slots.slotEmojis[Math.floor(Math.random() * (state.slots.slotEmojis.length - 1))]);
                    }
                } else {
                    // Обычный символ
                    results.push(state.slots.slotEmojis[Math.floor(Math.random() * state.slots.slotEmojis.length)]);
                }
            }
            
            // Гарантируем что результаты сохраняются для проверки
            state.slots.slotReels = results;
            return results;
        }

        // Остановка анимации слотов
        function stopSlotAnimation(reels, results) {
            reels.forEach((reel, index) => {
                setTimeout(() => {
                    reel.classList.remove('spinning');
                    
                    // Создаем элемент смайла
                    const emoji = document.createElement('div');
                    emoji.className = 'slot-emoji';
                    emoji.textContent = results[index];
                    emoji.style.animationDelay = `${index * 0.2}s`;
                    
                    reel.innerHTML = '';
                    reel.appendChild(emoji);
                    
                    // Если это последний барабан, обрабатываем результат
                    if (index === 2) {
                        setTimeout(() => {
                            processSlotResult(results);
                        }, 500);
                    }
                }, index * 300);
            });
        }

        // Обработка результата слотов
// Обработка результата слотов - ИСПРАВЛЕН БАГ С УДАЛЕНИЕМ NFT
function processSlotResult(results) {
    const nftId = state.slots.selectedNft;
    const nft = state.nfts.find(n => n.id === nftId);
    const upgrade = nft.upgraded[0]; // Берем первый улучшенный NFT
    
    let resultElement = document.getElementById('slot-result');
    resultElement.style.display = 'block';
    
    // Проверка на 777
    if (results[0] === '7️⃣' && results[1] === '7️⃣' && results[2] === '7️⃣') {
        // ... существующий код для джекпота ...
        resultElement.innerHTML = `
            <h3 style="color: #FFD700;">🎉 ДЖЕКПОТ 777! 🎉</h3>
            <p>Вы получаете NFT "${nft.name}" с ЧЕРНЫМ фоном (самое ценное улучшение)!</p>
        `;
        resultElement.style.background = 'linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1))';
        resultElement.style.border = '2px solid #FFD700';
        resultElement.style.color = '#FFD700';
        
        // Добавляем черный улучшенный NFT
        nft.upgraded.push({
            color: "черный",
            colorClass: "nft-black",
            multiplier: 4,
            rarity: "godlike",
            price: Math.floor(nft.price * 4),
            upgradedAt: new Date().toLocaleString('ru-RU')
        });
        
        // Обновляем статистику
        state.userStats.slotsWins++;
        
        showNotification('ДЖЕКПОТ! Вы получили NFT с черным фоном!', 'success');
    }
    // Проверка на 3 одинаковых символа
    else if (results[0] === results[1] && results[1] === results[2]) {
        // ... существующий код для выигрыша 3 символа ...
        resultElement.innerHTML = `
            <h3 style="color: var(--success);">🎰 ВЫИГРЫШ! 🎰</h3>
            <p>3 одинаковых символа! Вы получаете 2 таких же улучшенных NFT "${nft.name}"</p>
        `;
        resultElement.style.background = 'linear-gradient(135deg, rgba(0, 200, 81, 0.2), rgba(0, 168, 68, 0.1))';
        resultElement.style.border = '2px solid var(--success)';
        resultElement.style.color = 'var(--success)';
        
        // Добавляем 2 копии улучшенного NFT
        nft.upgraded.push({...upgrade});
        nft.upgraded.push({...upgrade});
        nft.owned += 2; // Увеличиваем общее количество
        
        // Обновляем статистику
        state.userStats.slotsWins++;
        
        showNotification('Выигрыш! Вы получили 2 улучшенных NFT!', 'success');
    }
    // Проверка на 2 одинаковых символа
    else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
        // ... существующий код для ничьи ...
        resultElement.innerHTML = `
            <h3 style="color: var(--text-light);">🤝 НИЧЬЯ</h3>
            <p>2 одинаковых символа! Ваш NFT сохраняется.</p>
        `;
        resultElement.style.background = 'linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(200, 200, 200, 0.1))';
        resultElement.style.border = '2px solid var(--text-light)';
        resultElement.style.color = 'var(--text-light)';
        
        showNotification('Ничья! Ваш NFT сохранен.', 'info');
    }
    else {
        // Проигрыш - теряем NFT
        resultElement.innerHTML = `
            <h3 style="color: var(--danger);">💥 ПРОИГРЫШ</h3>
            <p>Символы не совпали. Вы теряете улучшенный NFT "${nft.name}"</p>
        `;
        resultElement.style.background = 'linear-gradient(135deg, rgba(255, 68, 68, 0.2), rgba(245, 87, 108, 0.1))';
        resultElement.style.border = '2px solid var(--danger)';
        resultElement.style.color = 'var(--danger)';
        
        // **ИСПРАВЛЕНИЕ: Удаляем улучшенный NFT и уменьшаем общее количество**
        // Сначала удаляем улучшенный NFT
        nft.upgraded.shift();
        
        // Уменьшаем общее количество NFT
        nft.owned--;
        
        // Если общее количество стало 0, удаляем NFT полностью
        if (nft.owned <= 0) {
            nft.owned = 0;
            // Можно также очистить массив upgraded, если он пуст
            if (nft.upgraded.length === 0) {
                nft.upgraded = [];
            }
        }
        
        // Обновляем статистику
        state.userStats.slotsLosses++;
        
        showNotification('Проигрыш! NFT утерян.', 'error');
    }
    
    // Сбрасываем состояние
    state.slots.isSpinning = false;
    state.slots.selectedNft = null;
    
    // Сохраняем данные
    saveUserData();
    
    // Обновляем UI
    updateUI();
    updateSlotsNFTSelector();
    
    // Скрываем результат через 5 секунд
    setTimeout(() => {
        resultElement.style.display = 'none';
    }, 5000);
}

        // ==================== НОВЫЕ ФУНКЦИИ ДЛЯ АКЦИЙ ====================

        // Инициализация вкладки "Акции"
        function initStocksTab() {
            // Инициализация графиков акций
            initStockCharts();
            
            // Обработчики кнопок перевода денег
            document.getElementById('btn-transfer-to-broker').addEventListener('click', transferToBroker);
            document.getElementById('btn-transfer-from-broker').addEventListener('click', transferFromBroker);
            
            // Обновление интерфейса акций
            updateStocksUI();
            setInterval(processStockTaxes, 300000); // 300000 мс = 5 минут
        }

        // Инициализация графиков акций
        function initStockCharts() {
            state.stocks.companies.forEach(company => {
                // Создание начальных данных для графика
                const now = Date.now();
                company.chartData = [];
                for (let i = 0; i < 20; i++) {
                    const time = now - (20 - i) * 60000; // 20 точек с интервалом 1 минута
                    company.chartData.push({ time, price: company.price });
                }
            });
        }

        // Перевод денег на брокерский счет
        function transferToBroker() {
            const amount = parseInt(document.getElementById('transfer-to-broker').value);
            
            if (!amount || amount <= 0) {
                showNotification('Введите корректную сумму', 'error');
                return;
            }
            
            if (amount > state.balances.RUB) {
                showNotification('Недостаточно средств на рублевом счете', 'error');
                return;
            }
            
            showConfirmModal(
                `Вы уверены, что хотите перевести ${formatNumber(amount)} ₽ на брокерский счет?`,
                () => {
                    state.balances.RUB -= amount;
                    state.balances.BROKER += amount;
                    
                    // Добавляем в историю транзакций
                    addTransaction('broker_transfer', 'RUB', -amount, amount, 'BROKER');
                    
                    // Сохраняем данные
                    saveUserData();
                    
                    // Обновляем UI
                    updateUI();
                    updateStocksUI();
                    
                    // Сбрасываем поле ввода
                    document.getElementById('transfer-to-broker').value = '';
                    
                    showNotification(`Успешно переведено ${formatNumber(amount)} ₽ на брокерский счет`, 'success');
                }
            );
        }

        // Перевод денег с брокерского счета
        function transferFromBroker() {
            const amount = parseInt(document.getElementById('transfer-to-broker').value);
            
            if (!amount || amount <= 0) {
                showNotification('Введите корректную сумму', 'error');
                return;
            }
            
            if (amount > state.balances.BROKER) {
                showNotification('Недостаточно средств на брокерском счете', 'error');
                return;
            }
            
            showConfirmModal(
                `Вы уверены, что хотите перевести ${formatNumber(amount)} ₽ с брокерского счета на рублевый?`,
                () => {
                    state.balances.BROKER -= amount;
                    state.balances.RUB += amount;
                    
                    // Добавляем в историю транзакций
                    addTransaction('broker_withdraw', 'BROKER', -amount, amount, 'RUB');
                    
                    // Сохраняем данные
                    saveUserData();
                    
                    // Обновляем UI
                    updateUI();
                    updateStocksUI();
                    
                    // Сбрасываем поле ввода
                    document.getElementById('transfer-to-broker').value = '';
                    
                    showNotification(`Успешно переведено ${formatNumber(amount)} ₽ на рублевый счет`, 'success');
                }
            );
        }

        // Покупка акций
// Замените функции buyStock() и sellStock():

// Покупка акций
// Покупка акций
function buyStock(stockId, amount) {
    const stock = state.stocks.companies.find(s => s.id === stockId);
    
    amount = parseInt(amount);
    
    if (!amount || amount <= 0) {
        showNotification('Введите корректное количество акций', 'error');
        return;
    }
    
    const totalCost = stock.price * amount;
    
    if (totalCost > state.balances.BROKER) {
        showNotification('Недостаточно средств на брокерском счете', 'error');
        return;
    }
    
    if (amount > stock.totalShares - stock.ownedShares) {
        showNotification('Недостаточно акций в продаже', 'error');
        return;
    }
    
    showConfirmModal(
        `Вы уверены, что хотите купить ${amount} акций ${stock.name} за ${formatNumber(totalCost)} ₽?`,
        () => {
            state.balances.BROKER -= totalCost;
            stock.ownedShares += amount;
            
            // Обновляем общую сумму инвестиций
            state.userStats.totalInvested += totalCost;
            
            // Добавляем в историю транзакций
            addTransaction('stock_buy', `${stock.symbol}`, -totalCost, amount, 'shares');
            
            // Сохраняем данные
            saveUserData();
            
            // Обновляем UI - ИСПРАВЛЕНИЕ: не очищаем поле сразу
            updateUI();
            
            // Показываем уведомление
            showNotification(`Успешно куплено ${amount} акций ${stock.name}`, 'success');
        }
    );
}

// Продажа акций
// Замените функцию sellStock на эту исправленную версию
// Продажа акций - ИСПРАВЛЕННАЯ ВЕРСИЯ
function sellStock(stockId, amount) {
    const stock = state.stocks.companies.find(s => s.id === stockId);
    if (!stock) {
        showNotification('Акция не найдена', 'error');
        return;
    }
    
    amount = parseInt(amount);
    
    if (!amount || amount <= 0 || isNaN(amount)) {
        showNotification('Введите корректное количество акций', 'error');
        return;
    }
    
    if (!Number.isInteger(amount)) {
        showNotification('Количество акций должно быть целым числом', 'error');
        return;
    }
    
    // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Проверяем, что продаем не больше, чем у нас есть
    if (amount > stock.ownedShares) {
        showNotification(`Недостаточно акций для продажи. У вас: ${stock.ownedShares}`, 'error');
        return;
    }
    
    // ИСПРАВЛЕНИЕ БАГА 2: Используем ТЕКУЩУЮ цену из состояния, а не из DOM
    const currentPrice = stock.price; // Берем из состояния, которое обновляется в реальном времени
    const totalValue = currentPrice * amount;
    
    // Показываем подтверждение с реальной ценой
    showConfirmModal(
        `Продать ${amount} акций ${stock.name} по ${formatNumber(currentPrice)} ₽ за акцию? Итого: ${formatNumber(totalValue)} ₽`,
        () => {
            try {
                // Выполняем продажу
                state.balances.BROKER = safeAdd(state.balances.BROKER, totalValue);
                stock.ownedShares -= amount;
                
                // ГАРАНТИЯ: ownedShares никогда не должен быть меньше 0
                if (stock.ownedShares < 0) {
                    console.error('Ошибка: ownedShares стал отрицательным для', stock.name);
                    stock.ownedShares = 0;
                }
                
                // ГАРАНТИЯ: ownedShares никогда не должен быть больше totalShares
                if (stock.ownedShares > stock.totalShares) {
                    console.error('Ошибка: ownedShares превысил totalShares для', stock.name);
                    stock.ownedShares = stock.totalShares;
                }
                
                // Добавляем в историю
                addTransaction('stock_sell', stock.symbol, totalValue, -amount, 'акций');
                
                // Сохраняем данные
                saveUserData();
                
                // Обновляем UI
                updateUI();
                updateStocksUI();
                
                // Показываем уведомление
                showNotification(`Продано ${amount} акций ${stock.name} за ${formatNumber(totalValue)} ₽`, 'success');
                
            } catch (error) {
                console.error('Ошибка при продаже акций:', error);
                showNotification('Произошла ошибка при продаже акций', 'error');
            }
        }
    );
}

        // Симуляция изменения цен акций
function startStockPriceSimulation() {
    setInterval(() => {
        state.stocks.companies.forEach(company => {
            // Изменение цены от -2% до +3%
            const change = (Math.random() * 0.05) - 0.02;
            const oldPrice = company.price;
            company.price = Math.max(500, company.price * (1 + change)); // Минимальная цена 500 ₽
            company.change = ((company.price - oldPrice) / oldPrice) * 100;
            
            // Добавление точки в график (только если прошло больше 30 секунд с последнего обновления)
            const now = Date.now();
            if (!company.lastChartUpdate || now - company.lastChartUpdate > 30000) {
                company.chartData.push({
                    time: now,
                    price: company.price
                });
                
                // Ограничение истории до 20 точек
                if (company.chartData.length > 20) {
                    company.chartData.shift();
                }
                company.lastChartUpdate = now;
            }
        });
        
        // ИСПРАВЛЕНИЕ: Обновление UI всегда когда открыта вкладка акций
        if (document.getElementById('stocks').classList.contains('active')) {
            updateStocksUI();
        }
    }, 30000); // 30 секунд - изменение цен
}

        // Выплата дивидендов
        function startDividendsPayment() {
            state.stocks.dividendsTimer = setInterval(() => {
                let totalDividends = 0;
                
                state.stocks.companies.forEach(company => {
                    if (company.ownedShares > 0) {
                        // Расчет дивидендов: ownedShares * price * dividendRate / 12 (месячные дивиденды, выплачиваем каждые 2 минуты как 1/15 месяца)
                        const dividends = company.ownedShares * company.price * company.dividendRate / 15;
                        totalDividends += dividends;
                    }
                });
                
                if (totalDividends > 0) {
                    state.balances.BROKER += totalDividends;
                    state.userStats.dividendsEarned += totalDividends;
                    
                    // Обновляем UI
                    updateStocksUI();
                    
                    // Показываем уведомление каждые 4 выплаты (8 минут)
                    if (Math.random() < 0.25) {
                        showNotification(`Получены дивиденды: ${formatNumber(totalDividends)} ₽`, 'success');
                    }
                }
            }, 120000); // 2 минуты
        }

        // Обновление UI акций
function updateStocksUI() {
    // Обновление баланса брокерского счета
    document.getElementById('broker-balance').textContent = formatNumber(state.balances.BROKER) + ' ₽';
    document.getElementById('broker-balance-wallet').textContent = formatNumber(state.balances.BROKER) + ' ₽';
    
    // Обновление списка акций - ИСПРАВЛЕНИЕ: всегда обновляем
    updateStocksList();
    
    // Обновление информации о дивидендах
    updateDividendsInfo();
}

        // Обновление списка акций
// Замените функцию updateStocksList() на эту исправленную версию:

// Обновление списка акций
// Обновление списка акций
// Обновление списка акций
// Обновление списка акций - ИСПРАВЛЕННАЯ ВЕРСИЯ
function updateStocksList() {
    const stocksList = document.getElementById('stocks-list');
    const ownedStocksList = document.getElementById('owned-stocks-list');
    
    if (!stocksList || !ownedStocksList) {
        console.error('Элементы списка акций не найдены');
        return;
    }
    
    // Сохраняем текущие значения полей ввода ДО перерисовки
    const oldValues = {};
    document.querySelectorAll('#stocks-list input[type="number"]').forEach(input => {
        if (input.id) {
            oldValues[input.id] = input.value;
        }
    });
    
    stocksList.innerHTML = '';
    ownedStocksList.innerHTML = '';
    
    let hasOwnedStocks = false;
    let totalDividends = 0;
    
    state.stocks.companies.forEach(company => {
        // Валидация данных компании
        if (!company || typeof company.price !== 'number' || company.price <= 0) {
            console.warn('Некорректные данные компании:', company);
            return;
        }
        
        // Расчет дивидендов для этой компании
        if (company.ownedShares > 0) {
            hasOwnedStocks = true;
            const dividends = company.ownedShares * company.price * company.dividendRate / 15;
            totalDividends += dividends;
            
            // Добавляем в список владения
            const ownedStockItem = document.createElement('div');
            ownedStockItem.className = 'stock-ownership';
            
            const ownershipPercent = (company.ownedShares / company.totalShares) * 100;
            
            ownedStockItem.innerHTML = `
                <div style="flex: 1;">
                    <div style="font-weight: bold;">${company.name}</div>
                    <div style="font-size: 0.9rem; color: var(--text-gray);">
                        ${company.ownedShares} акций (${formatNumber(company.ownedShares * company.price)} ₽)
                    </div>
                </div>
                <div class="ownership-bar">
                    <div class="ownership-fill" style="width: ${Math.min(100, ownershipPercent)}%"></div>
                </div>
                <div class="ownership-percent">
                    ${ownershipPercent.toFixed(1)}%
                </div>
            `;
            
            ownedStocksList.appendChild(ownedStockItem);
            
            // Проверка на налоги (75%+ владение) - ТОЛЬКО ИНФОРМАЦИОННОЕ УВЕДОМЛЕНИЕ
            if (ownershipPercent >= 75) {
                const taxAmount = company.ownedShares * company.price * 0.01; // 1% налог
                
                // Проверяем, когда был последний платеж налога
                const now = Date.now();
                const lastPaymentTime = company.lastTaxPayment || 0;
                const timeSinceLastPayment = now - lastPaymentTime;
                
                // Только если еще не было платежа или прошло больше 4.5 минут
                if (lastPaymentTime === 0 || timeSinceLastPayment > 270000) { // 4.5 минуты = 270000 мс
                    const timeRemaining = Math.max(0, 300000 - timeSinceLastPayment);
                    const minutes = Math.floor(timeRemaining / 60000);
                    const seconds = Math.floor((timeRemaining % 60000) / 1000);
                    
                    // Показываем уведомление только раз в 30 секунд, когда осталось мало времени
                    if (timeRemaining <= 60000) { // Меньше минуты осталось
                        // Показываем уведомление с 10% шансом, чтобы не спамить
                        if (Math.random() < 0.1 && !company.lastTaxNotificationShown) {
                            showNotification(
                                `Следующий налог ${company.name}: ${formatNumber(taxAmount)} ₽ через ${minutes}:${seconds.toString().padStart(2, '0')}`, 
                                'info'
                            );
                            company.lastTaxNotificationShown = true;
                        }
                    }
                } else {
                    // Сбрасываем флаг уведомления
                    company.lastTaxNotificationShown = false;
                }
            }
        }
        
        // Восстанавливаем старое значение или используем пустое
        const buyInputId = `buy-amount-${company.id}`;
        const sellInputId = `sell-amount-${company.id}`;
        const oldBuyValue = oldValues[buyInputId] || '';
        const oldSellValue = oldValues[sellInputId] || '';
        
        // Создаем карточку акции
        const stockCard = document.createElement('div');
        stockCard.className = `stock-card ${company.change >= 0 ? 'positive' : 'negative'}`;
        
        stockCard.innerHTML = `
            <div class="stock-header">
                <div>
                    <div class="stock-name">${company.name} (${company.symbol})</div>
                    <div style="font-size: 0.9rem; color: var(--text-gray);">
                        Всего акций: ${formatNumber(company.totalShares)}
                        <br>Свободно: ${formatNumber(company.totalShares - company.ownedShares)}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div class="stock-price">${formatNumber(company.price)} ₽</div>
                    <div class="stock-change ${company.change >= 0 ? 'positive' : 'negative'}">
                        ${company.change >= 0 ? '↗' : '↘'} ${Math.abs(company.change).toFixed(2)}%
                    </div>
                </div>
            </div>
            
            <div class="stock-chart-container">
                <canvas id="stock-chart-${company.id}" height="100"></canvas>
            </div>
            
            <div class="stock-info">
                <div>
                    <div>Дивиденды:</div>
                    <div style="color: var(--stocks-green); font-weight: bold;">
                        ${(company.dividendRate * 100).toFixed(1)}%
                    </div>
                </div>
                <div>
                    <div>Ваши акции:</div>
                    <div style="font-weight: bold;">${company.ownedShares}</div>
                </div>
            </div>
            
            <div class="stock-actions">
                <div style="flex: 1;">
                    <input type="number" id="${buyInputId}" class="form-control stock-input" 
                           placeholder="Кол-во" min="1" max="${Math.max(0, company.totalShares - company.ownedShares)}" 
                           value="${oldBuyValue}" style="transition: none !important;">
                </div>
                <button class="btn btn-success" style="flex: 1;" 
                        onclick="buyStock(${company.id}, document.getElementById('${buyInputId}').value)"
                        data-current-price="${company.price}">
                    Купить
                </button>
            </div>
            
            ${company.ownedShares > 0 ? `
                <div class="stock-actions" style="margin-top: 12px;">
                    <div style="flex: 1;">
                        <input type="number" id="${sellInputId}" class="form-control stock-input" 
                               placeholder="Кол-во" min="1" max="${company.ownedShares}" 
                               value="${oldSellValue}" style="transition: none !important;">
                    </div>
                    <button class="btn btn-danger" style="flex: 1;" 
                            onclick="sellStock(${company.id}, document.getElementById('${sellInputId}').value)"
                            data-current-price="${company.price}">
                        Продать
                    </button>
                </div>
            ` : ''}
        `;
        
        stocksList.appendChild(stockCard);
        
        // Создаем график для акции
        setTimeout(() => {
            const chartElement = document.getElementById(`stock-chart-${company.id}`);
            if (chartElement) {
                createStockChart(company);
            }
        }, 100);
    });
    
    // Показываем или скрываем информацию о дивидендах
    const dividendsInfo = document.getElementById('dividends-info');
    if (dividendsInfo) {
        if (hasOwnedStocks) {
            dividendsInfo.style.display = 'block';
            document.getElementById('dividends-amount').textContent = formatNumber(totalDividends) + ' ₽/2мин';
        } else {
            dividendsInfo.style.display = 'none';
        }
    }
    
    // Валидация всех балансов акций
    validateStockOwnership();
}

// Функция для валидации владения акциями
function validateStockOwnership() {
    let fixed = false;
    
    state.stocks.companies.forEach(company => {
        // Исправление: ownedShares не может быть отрицательным
        if (company.ownedShares < 0) {
            console.warn(`Исправляю отрицательные акции для ${company.name}: было ${company.ownedShares}`);
            company.ownedShares = 0;
            fixed = true;
        }
        
        // Исправление: ownedShares не может быть больше totalShares
        if (company.ownedShares > company.totalShares) {
            console.warn(`Исправляю избыточные акции для ${company.name}: было ${company.ownedShares}, максимум ${company.totalShares}`);
            company.ownedShares = company.totalShares;
            fixed = true;
        }
        
        // Исправление: price должен быть положительным
        if (company.price <= 0) {
            console.warn(`Исправляю цену для ${company.name}: было ${company.price}`);
            company.price = company.basePrice || 1000; // Базовая цена
            fixed = true;
        }
    });
    
    if (fixed) {
        saveUserData();
        console.log('Владение акциями проверено и исправлено');
    }
}

        // Создание графика акции
// Создание графика акции
// Создание графика акции
// Создание графика акции
// Создание графика акции
// Создание графика акции - ИСПРАВЛЕННАЯ ВЕРСИЯ
function createStockChart(company) {
    const canvasId = `stock-chart-${company.id}`;
    const canvas = document.getElementById(canvasId);
    
    if (!canvas) {
        return;
    }
    
    // Уничтожаем старый график
    if (state.stocks.stockCharts[company.id]) {
        try {
            state.stocks.stockCharts[company.id].destroy();
        } catch (e) {
            // Игнорируем ошибки
        }
        state.stocks.stockCharts[company.id] = null;
    }
    
    // Инициализируем данные если нужно
    if (!company.chartData || company.chartData.length === 0) {
        const now = Date.now();
        company.chartData = [];
        for (let i = 0; i < 20; i++) {
            company.chartData.push({
                time: now - (20 - i) * 60000,
                price: company.price
            });
        }
    }
    
    try {
        const ctx = canvas.getContext('2d');
        const chartColors = company.change >= 0 ? 
            { border: '#10B981', background: 'rgba(16, 185, 129, 0.1)' } :
            { border: '#EF4444', background: 'rgba(239, 68, 68, 0.1)' };
        
        state.stocks.stockCharts[company.id] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: company.chartData.map((_, i) => i + 'м'),
                datasets: [{
                    label: company.symbol,
                    data: company.chartData.map(p => p.price),
                    borderColor: chartColors.border,
                    backgroundColor: chartColors.background,
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 0, // Убираем точки
                    pointHoverRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false } // Отключаем tooltips
                },
                scales: {
                    x: { display: false },
                    y: { 
                        display: true,
                        ticks: {
                            callback: function(value) {
                                return formatNumber(value) + ' ₽';
                            }
                        }
                    }
                },
                animation: false // Отключаем анимацию
            }
        });
    } catch (error) {
        console.error('Ошибка при создании графика акции:', company.name, error);
        state.stocks.stockCharts[company.id] = null;
    }
}

        // Обновление информации о дивидендах
        function updateDividendsInfo() {
            // Функция вызывается из updateStocksUI
        }

        // ==================== НОВЫЕ ФУНКЦИИ ДЛЯ КАРТИН ====================

        // Обновление списка картин
        function updatePaintingsList() {
            const paintingsList = document.getElementById('paintings-list');
            paintingsList.innerHTML = '';
            
            state.paintings.forEach(painting => {
                const isOwned = state.bank.paintings.some(p => p.id === painting.id);
                const paintingCard = document.createElement('div');
                paintingCard.className = `painting-card painting-${painting.name.toLowerCase().replace(' ', '-')}`;
                
                let buttonText = 'Купить картину';
                if (isOwned) {
                    buttonText = '✓ Уже куплено';
                }
                
                paintingCard.innerHTML = `
                    <div class="painting-image">${painting.emoji}</div>
                    <h3 style="margin-bottom: 12px; font-size: 1.6rem;">${painting.name}</h3>
                    <div style="color: rgba(255, 255, 255, 0.8); margin-bottom: 16px; font-size: 0.9rem;">
                        ${painting.description}
                    </div>
                    <div class="painting-price">${formatNumber(painting.price)} ₽</div>
                    ${isOwned ? 
                        '<div class="painting-owned">В вашей коллекции</div>' :
                        `<button class="btn ${isOwned ? 'btn-outline' : 'btn-bank'}" 
                                data-painting-id="${painting.id}" 
                                ${isOwned ? 'disabled' : ''}
                                style="background: white; color: var(--bank-blue); font-weight: bold;">
                            ${buttonText}
                        </button>`
                    }
                `;
                paintingsList.appendChild(paintingCard);
            });
            
            // Добавляем обработчики для кнопок покупки
            document.querySelectorAll('#paintings-list .btn').forEach(btn => {
                if (!btn.disabled) {
                    btn.addEventListener('click', function() {
                        const paintingId = parseInt(this.getAttribute('data-painting-id'));
                        buyPainting(paintingId);
                    });
                }
            });
        }

        // Покупка картины
        function buyPainting(paintingId) {
            const painting = state.paintings.find(p => p.id === paintingId);
            if (!painting) return;

            if (state.bank.balance < painting.price) {
                showNotification('Недостаточно средств на банковском счете', 'error');
                return;
            }

            const isOwned = state.bank.paintings.some(p => p.id === paintingId);
            if (isOwned) {
                showNotification('Эта картина уже в вашей коллекции', 'error');
                return;
            }

            showConfirmModal(
                `Вы уверены, что хотите купить картину "${painting.name}" за ${formatNumber(painting.price)} ₽?`,
                () => {
                    state.bank.balance -= painting.price;
                    state.bank.paintings.push({
                        id: painting.id,
                        name: painting.name,
                        price: painting.price,
                        emoji: painting.emoji,
                        description: painting.description,
                        purchaseDate: new Date().toLocaleDateString('ru-RU')
                    });
                    
                    saveUserData();
                    updateUI();
                    showNotification(`${painting.name} успешно куплена! Самая дорогая покупка в игре!`, 'success');
                }
            );
        }

        // ==================== ОБНОВЛЕННЫЕ СУЩЕСТВУЮЩИЕ ФУНКЦИИ ====================

        // Загрузка данных пользователя - ОБНОВЛЕНА
// Загрузка данных пользователя - ОБНОВЛЕНА с исправлением циклических ссылок
function loadUserData() {
    
    if (state.chart) {
    try {
        state.chart.destroy();
    } catch (e) {
        // Игнорируем
    }
    state.chart = null;
    function validateStocksData() {
    if (!state.stocks || !state.stocks.companies) return;
    
    state.stocks.companies.forEach(company => {
        // Исправление: ownedShares не может быть отрицательным
        if (company.ownedShares < 0) {
            console.warn(`Исправляю отрицательные акции для ${company.name}: было ${company.ownedShares}`);
            company.ownedShares = 0;
        }
        
        // Исправление: ownedShares не может быть больше totalShares
        if (company.ownedShares > company.totalShares) {
            console.warn(`Исправляю избыточные акции для ${company.name}: было ${company.ownedShares}, максимум ${company.totalShares}`);
            company.ownedShares = company.totalShares;
        }
        
        // Исправление: price должен быть положительным
        if (company.price <= 0) {
            console.warn(`Исправляю цену для ${company.name}: было ${company.price}`);
            company.price = 1000; // Базовая цена
        }
    });
}
}

// Очищаем графики акций
if (state.stocks && state.stocks.stockCharts) {
    destroyAllStockCharts();
}
    if (!state.user) return;
    
    const userData = localStorage.getItem(`cryptoExchangeData_${state.user.username}`);
    if (userData) {
        try {
            const parsedData = JSON.parse(userData);
            
            // Восстанавливаем все данные пользователя
            if (parsedData.balances) {
                Object.assign(state.balances, parsedData.balances);
                // ИСПРАВЛЕНИЕ: Добавляем брокерский счет если его нет
                if (typeof state.balances.BROKER === 'undefined') state.balances.BROKER = 0;
                // ИСПРАВЛЕНИЕ: Убеждаемся что рублевый счет есть
                if (typeof state.balances.RUB === 'undefined') state.balances.RUB = 5000;
            } else {
                // Если нет данных о балансах, устанавливаем значения по умолчанию
                state.balances = {
                    RUB: 5000,
                    BTC: 0.005,
                    ETH: 0.05,
                    TON: 50,
                    STARS: 0,
                    CAT: 0,
                    BROKER: 0
                };
            }
            
            if (parsedData.exchangeRates) {
                Object.assign(state.exchangeRates, parsedData.exchangeRates);
            }
            if (parsedData.transactionHistory) {
                state.transactionHistory = parsedData.transactionHistory;
            }
            if (parsedData.currentCurrency) {
                state.currentCurrency = parsedData.currentCurrency;
            }
            if (parsedData.priceHistory) {
                Object.assign(state.priceHistory, parsedData.priceHistory);
            }
            if (parsedData.nfts) {
                state.nfts = parsedData.nfts;
            }
            if (parsedData.bank) {
                state.bank = parsedData.bank;
                
                // ИСПРАВЛЕНИЕ: Убеждаемся что банковский баланс есть
                if (typeof state.bank.balance === 'undefined') state.bank.balance = 0;
                
                if (!state.bank.properties) state.bank.properties = [];
                if (!state.bank.yachts) state.bank.yachts = [];
                if (!state.bank.documents) state.bank.documents = [];
                if (!state.bank.documentTemplates) state.bank.documentTemplates = 0;
                if (!state.bank.paintings) state.bank.paintings = [];
                
                if (state.bank.credit.taken && !state.bank.credit.remainingAmount) {
                    state.bank.credit.remainingAmount = state.bank.credit.amount * (1 + state.bank.credit.interestRate);
                }
            } else {
                // ИСПРАВЛЕНИЕ: Инициализация банка если данных нет
                state.bank = {
                    balance: 0,
                    initialDepositSet: false,
                    cards: [],
                    credit: {
                        amount: 0,
                        taken: false,
                        takenDate: null,
                        interestRate: 0.15,
                        remainingAmount: 0
                    },
                    properties: [],
                    yachts: [],
                    documents: [],
                    documentTemplates: 0,
                    paintings: []
                };
            }
            
            // Восстановление состояния Crash Game
            if (parsedData.crashGame) {
                Object.assign(state.crashGame, parsedData.crashGame);
                // Сбрасываем ссылки на таймеры
                state.crashGame.gameInterval = null;
            }
            
            // Восстановление состояния кликера
            if (parsedData.clicker) {
                Object.assign(state.clicker, parsedData.clicker);
                // Сбрасываем ссылку на интервал
                state.clicker.autoClickerInterval = null;
            }
            
            // Восстановление состояния улучшения NFT
            if (parsedData.nftUpgrade) {
                Object.assign(state.nftUpgrade, parsedData.nftUpgrade);
            }
            
            // Восстановление статистики пользователя
            if (parsedData.userStats) {
                Object.assign(state.userStats, parsedData.userStats);
            }
            
            // Восстановление состояния слотов
            if (parsedData.slots) {
                Object.assign(state.slots, parsedData.slots);
                // Сбрасываем таймеры
                state.slots.spinTimeout = null;
            }
            
            // Восстановление состояния акций
            if (parsedData.stocks) {
                state.stocks = parsedData.stocks;
                // Сбрасываем ссылки на графики и таймеры
                state.stocks.stockCharts = {};
                state.stocks.dividendsTimer = null;
                // Обновляем цены если графики пустые
                if (state.stocks.companies && state.stocks.companies[0] && !state.stocks.companies[0].chartData) {
                    initStockCharts();
                }
            } else {
                // Инициализация графиков акций если их нет
                initStockCharts();
            }
            
            // Восстановление картин
            if (parsedData.paintings) {
                state.paintings = parsedData.paintings;
            }
            
            console.log('Данные пользователя загружены:', state.user.username);
            
            // ПЕРЕИНИЦИАЛИЗАЦИЯ ГРАФИКОВ ПОСЛЕ ЗАГРУЗКИ ДАННЫХ
            setTimeout(() => {
                if (state.chart) {
                    state.chart.destroy();
                    state.chart = null;
                }
                // Инициализируем заново
                initChart();
                
                // Запускаем пересоздание графиков акций при открытии вкладки
                if (state.stocks && state.stocks.companies) {
                    setTimeout(() => {
                        if (document.getElementById('stocks').classList.contains('active')) {
                            state.stocks.stockCharts = {};
                            state.stocks.companies.forEach(company => {
                                createStockChart(company);
                            });
                        }
                    }, 500);
                }
            }, 100);
            
        } catch (e) {
            console.error('Ошибка загрузки данных пользователя:', e);
            // ИСПРАВЛЕНИЕ: При ошибке устанавливаем значения по умолчанию
            state.balances.RUB = 5000;
            state.balances.BROKER = 0;
            state.bank.balance = 0;
        }
    } else {
        // ИСПРАВЛЕНИЕ: Устанавливаем правильные значения по умолчанию для нового пользователя
        state.balances.RUB = 5000;
        state.balances.BROKER = 0;
        state.bank.balance = 0;
        
        // Инициализация графиков акций для нового пользователя
        initStockCharts();
        
        saveUserData();
    }
    loadFragmentData();
}

        // Сохранение данных пользователя - ОБНОВЛЕНА
// Сохранение данных пользователя - ОБНОВЛЕНА с исправлением циклических ссылок
function saveUserData() {
    if (!state.user) return;
    
    try {
        // Создаем копию данных без циклических ссылок
        const saveData = {
            balances: {...state.balances},
            exchangeRates: {...state.exchangeRates},
            transactionHistory: [...state.transactionHistory],
            currentCurrency: state.currentCurrency,
            priceHistory: {...state.priceHistory},
            nfts: state.nfts.map(nft => ({
                ...nft,
                upgraded: nft.upgraded ? [...nft.upgraded] : []
            })),
            bank: {
                ...state.bank,
                cards: [...state.bank.cards],
                credit: {...state.bank.credit},
                properties: [...state.bank.properties],
                yachts: [...state.bank.yachts],
                documents: [...state.bank.documents],
                paintings: [...state.bank.paintings]
            },
            crashGame: {
                ...state.crashGame,
                history: [...state.crashGame.history],
                graphPoints: [...state.crashGame.graphPoints]
            },
            clicker: {...state.clicker},
            nftUpgrade: {...state.nftUpgrade},
            userStats: {...state.userStats},
            slots: {...state.slots},
            stocks: {
                ...state.stocks,
                companies: state.stocks.companies.map(company => ({
                    ...company,
                    chartData: [...company.chartData]
                }))
            },
            paintings: [...state.paintings]
        };
        
        // Удаляем циклические ссылки на графики (Chart.js объекты)
        delete state.chart; // Удаляем ссылку на основной график
        if (state.stocks.stockCharts) {
            // Очищаем объект с графиками акций
            for (const key in state.stocks.stockCharts) {
                delete state.stocks.stockCharts[key];
            }
        }
        
        localStorage.setItem(`cryptoExchangeData_${state.user.username}`, JSON.stringify(saveData));
        saveFragmentData();
    } catch (e) {
        console.error('Ошибка сохранения данных пользователя:', e);
    }
}

        // Обновление интерфейса - ОБНОВЛЕНА
        function updateUI() {
            // Существующие обновления балансов...
            document.getElementById('rub-balance').textContent = formatNumber(state.balances.RUB) + ' ₽';
            document.getElementById('btc-balance').textContent = formatNumber(state.balances.BTC, 6) + ' BTC';
            document.getElementById('eth-balance').textContent = formatNumber(state.balances.ETH, 4) + ' ETH';
            document.getElementById('ton-balance').textContent = formatNumber(state.balances.TON, 2) + ' TON';
            document.getElementById('stars-balance').textContent = Math.floor(state.balances.STARS) + ' STARS';
            document.getElementById('broker-balance-wallet').textContent = formatNumber(state.balances.BROKER) + ' ₽';
            
            // Обновление значений в долларах
            document.getElementById('btc-value').textContent = '$' + formatNumber(state.balances.BTC * state.exchangeRates.BTC, 2);
            document.getElementById('eth-value').textContent = '$' + formatNumber(state.balances.ETH * state.exchangeRates.ETH, 2);
            document.getElementById('ton-value').textContent = '$' + formatNumber(state.balances.TON * state.exchangeRates.TON, 2);
            document.getElementById('stars-value').textContent = formatNumber(Math.floor(state.balances.STARS) * state.exchangeRates.STARS) + ' ₽';
            
            // Обновление текущей цены
            document.getElementById('current-price').textContent = 
                `${state.currentCurrency}: $${formatNumber(state.exchangeRates[state.currentCurrency], 2)}`;
            
            // Обновление доступного баланса для вывода
            document.getElementById('available-balance').textContent = formatNumber(state.balances.RUB);
            
            // Обновление истории транзакций
            updateTransactionHistory();
            
            // Обновление максимальной ставки
            updateMaxBet();
            
            // Обновление профиля
            updateProfile();
            
            // Обновление NFT маркета
            updateNFTMarket();
            
            // Обновление инвентаря
            updateInventory();
            
            // Обновление админ панели
            updateAdminPanel();
            
            // Обновление банка
            updateBankUI();
            
            // Обновление Crash Game
            updateCrashUI();
            
            // Обновление кликера
            updateClickerUI();
            
            // Обновление статистики профиля
            updateProfileStats();
                if (document.getElementById('fragment') && document.getElementById('fragment').classList.contains('active')) {
        updateFragmentUI();
    }
            
            // НОВОЕ: Обновление селектора слотов если вкладка активна
            if (document.getElementById('slots').classList.contains('active')) {
                updateSlotsNFTSelector();
            }
            
            // НОВОЕ: Обновление акций если вкладка активна
            if (document.getElementById('stocks').classList.contains('active')) {
                updateStocksUI();
            }
            
            // Сохраняем данные при обновлении UI
            saveUserData();
        }

        // Обновление статистики профиля - ОБНОВЛЕНА
        function updateProfileStats() {
            // Подсчет NFT в коллекции
            const totalNFTs = state.nfts.reduce((sum, nft) => sum + nft.owned, 0);
            state.userStats.totalNFTs = totalNFTs;
            
            // Подсчет улучшенных NFT
            const totalUpgrades = state.nfts.reduce((sum, nft) => sum + (nft.upgraded ? nft.upgraded.length : 0), 0);
            state.userStats.totalUpgrades = totalUpgrades;
            
            // Обновление элементов статистики
            document.getElementById('total-wins').textContent = state.userStats.totalWins;
            document.getElementById('total-losses').textContent = state.userStats.totalLosses;
            document.getElementById('total-nfts').textContent = state.userStats.totalNFTs;
            document.getElementById('crash-wins').textContent = state.userStats.crashWins;
            document.getElementById('total-upgrades').textContent = state.userStats.totalUpgrades;
            document.getElementById('total-clicks').textContent = state.userStats.totalClicks;
            
            // НОВОЕ: Добавляем статистику слотов и акций в профиль
            const statsGrid = document.querySelector('#profile .stats-grid');
            if (statsGrid) {
                // Проверяем, есть ли уже статистика слотов
                if (!document.getElementById('slots-wins')) {
                    // Добавляем новую статистику
                    const newStats = `
                        <div class="stat-card">
                            <div class="stat-value" id="slots-wins">${state.userStats.slotsWins}</div>
                            <div class="stat-label">Побед в слотах</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="slots-losses">${state.userStats.slotsLosses}</div>
                            <div class="stat-label">Поражений в слотах</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-invested">${formatNumber(state.userStats.totalInvested)}</div>
                            <div class="stat-label">Вложено в акции</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="dividends-earned">${formatNumber(state.userStats.dividendsEarned)}</div>
                            <div class="stat-label">Заработано дивидендов</div>
                        </div>
                    `;
                    statsGrid.innerHTML += newStats;
                } else {
                    // Обновляем существующую статистику
                    document.getElementById('slots-wins').textContent = state.userStats.slotsWins;
                    document.getElementById('slots-losses').textContent = state.userStats.slotsLosses;
                    document.getElementById('total-invested').textContent = formatNumber(state.userStats.totalInvested);
                    document.getElementById('dividends-earned').textContent = formatNumber(state.userStats.dividendsEarned);
                }
            }
        }

        // Обновление интерфейса банка - ОБНОВЛЕНА
        function updateBankUI() {
            // Существующие обновления...
            document.getElementById('bank-balance').textContent = formatNumber(state.bank.balance) + ' ₽';
            document.getElementById('credit-debt').textContent = formatNumber(state.bank.credit.remainingAmount) + ' ₽';
            document.getElementById('credit-interest-rate').textContent = (state.bank.credit.interestRate * 100) + '%';
            
            updateCardsList();
            updateCreditInfo();
            updatePropertiesList();
            updateYachtsList();
            updateDocumentsList();
            updateDocumentsShop();
            
            // НОВОЕ: Обновление списка картин
            updatePaintingsList();
            
            document.getElementById('btn-add-card').disabled = state.bank.cards.length >= 3;
            document.getElementById('btn-add-card').textContent = state.bank.cards.length >= 3 ? 'Максимум 3 карты' : 'Добавить новую карту';
            
            if (state.isAdmin) {
                document.getElementById('initial-deposit').disabled = false;
                document.getElementById('btn-set-deposit').disabled = false;
                document.getElementById('admin-deposit-note').style.display = 'block';
                document.getElementById('btn-set-deposit').textContent = 'Пополнить счет';
            } else {
                document.getElementById('initial-deposit').disabled = state.bank.initialDepositSet;
                document.getElementById('btn-set-deposit').disabled = state.bank.initialDepositSet;
                document.getElementById('admin-deposit-note').style.display = 'none';
                if (state.bank.initialDepositSet) {
                    document.getElementById('btn-set-deposit').textContent = 'Депозит установлен';
                }
            }
        }

        // Переключение на вкладку - ОБНОВЛЕНА
// Переключение на вкладку - ОБНОВЛЕНА с исправлением графиков
// Переключение на вкладку - ОБНОВЛЕНА с исправлением графиков
// Переключение на вкладку - ОБНОВЛЕНА с безопасным уничтожением графиков
// Переключение на вкладку - ОБНОВЛЕНА с правильной работой графиков
// Переключение на вкладку - ПОЛНОСТЬЮ ИСПРАВЛЕННАЯ ВЕРСИЯ
function switchToTab(tabName) {
// В функции switchToTab() обновите обработку вкладки trade:
if (tabName === 'trade') {
    console.log('Переход на вкладку Trade');
    
    setTimeout(() => {
        // Если currencyOptions пуст, инициализируем заново
        if (!currencyOptions || currencyOptions.length === 0) {
            console.log('currencyOptions пуст, инициализируем вкладку заново');
            initTradeTab();
        } else {
            console.log('currencyOptions уже инициализирован, обновляем UI');
            updateCurrencyUI();
        }
        
        // Создаем/обновляем график
        setTimeout(() => {
            initChart();
        }, 150);
        
    }, 100);
}
    // Запоминаем текущую активную вкладку
    const currentActiveTab = document.querySelector('.tab-content.active');
    
    // 1. Уничтожаем графики при уходе со вкладок
    if (currentActiveTab) {
        // Уходим с вкладки stocks - уничтожаем графики акций
        if (currentActiveTab.id === 'stocks' && tabName !== 'stocks') {
            destroyAllStockCharts();
        }
        
        // Уходим с вкладки trade - уничтожаем основной график
        if (currentActiveTab.id === 'trade' && tabName !== 'trade') {
            if (state.chart) {
                try {
                    state.chart.destroy();
                } catch (e) {
                    // Игнорируем ошибки при уничтожении
                }
                state.chart = null;
            }
        }
    }
    
    // 2. Снимаем выделение со всех вкладок навигации
    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
    
    // 3. Скрываем все содержимое вкладок
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    // 4. Находим и активируем выбранную вкладку навигации
    const targetNavTab = document.querySelector(`[data-tab="${tabName}"]`);
    if (targetNavTab) {
        targetNavTab.classList.add('active');
    }
    
    // 5. Находим и показываем содержимое выбранной вкладки
    const targetContent = document.getElementById(tabName);
    if (targetContent) {
        targetContent.classList.add('active');
    }
    
    // 6. Обновляем основной интерфейс
    updateUI();
    
    // 7. Специальная обработка для каждой вкладки
    switch(tabName) {
        case 'trade':
            // Торговая вкладка - создаем график
            setTimeout(() => {
                initChart();
            }, 100);
            break;
            
        case 'crash-game':
            // Crash Game - обновляем интерфейс
            setTimeout(() => {
                updateCrashUI();
            }, 100);
            break;
            
        case 'slots':
            // Слоты - обновляем селектор NFT
            setTimeout(() => {
                updateSlotsNFTSelector();
            }, 100);
            break;
            
        case 'stocks':
            // Акции - создаем графики акций
            setTimeout(() => {
                if (state.stocks && state.stocks.companies) {
                    // Создаем графики для всех компаний
                    state.stocks.companies.forEach(company => {
                        createStockChart(company);
                    });
                    
                    // Обновляем UI акций
                    updateStocksUI();
                }
            }, 200);
            break;
            
        case 'wallets':
            // Кошельки - обновляем историю транзакций
            setTimeout(() => {
                updateTransactionHistory();
            }, 100);
            break;
            
        case 'conversion':
            // Конвертация - обновляем результат
            setTimeout(() => {
                updateConversionResult();
            }, 100);
            break;
            
        case 'nft-market':
            // NFT Маркет - обновляем маркет
            setTimeout(() => {
                updateNFTMarket();
            }, 100);
            break;
            
        case 'inventory':
            // Инвентарь - обновляем инвентарь
            setTimeout(() => {
                updateInventory();
            }, 100);
            break;
            
        case 'upgrade':
            // Улучшение NFT - обновляем селектор
            setTimeout(() => {
                updateNFTUpgradeSelector();
            }, 100);
            break;
            
        case 'clicker':
            // Кликер - обновляем интерфейс
            setTimeout(() => {
                updateClickerUI();
            }, 100);
            break;
            
        case 'deposit':
            // Ввод средств - ничего особенного
            break;
            
        case 'withdraw':
            // Вывод средств - ничего особенного
            break;
            
        case 'profile':
            // Профиль - обновляем статистику
            setTimeout(() => {
                updateProfileStats();
            }, 100);
            break;
            
        case 'admin':
            // Админка - показываем только если админ
            if (state.isAdmin) {
                setTimeout(() => {
                    updateAdminPanel();
                }, 100);
            }
            break;
                    case 'fragment':
            // Fragment - обновляем интерфейс
            setTimeout(() => {
                updateFragmentUI();
            }, 100);
            break;
        case 'bank':
            // Банк - обновляем интерфейс банка
            setTimeout(() => {
                updateBankUI();
            }, 100);
            break;
            
        default:
            // Для других вкладок просто обновляем UI
            console.log('Переключение на вкладку:', tabName);
    }
    
    // 8. Обновляем текущую цену в верхней панели
    setTimeout(() => {
        updateCurrentPrice();
    }, 50);
    
    // 9. Обновляем все балансы
    setTimeout(() => {
        updateAllBalancesDisplay();
    }, 50);
}

// Вспомогательная функция для обновления всех балансов на дисплее
// В функции updateAllBalancesDisplay добавьте защиту от отрицательных значений
function updateAllBalancesDisplay() {
    // Рублевый счет
    const rubBalance = Math.max(0, state.balances.RUB);
    document.getElementById('rub-balance').textContent = formatNumber(rubBalance) + ' ₽';
    
    // Криптовалюты (защита от отрицательных значений)
    const btcBalance = Math.max(0, state.balances.BTC);
    const ethBalance = Math.max(0, state.balances.ETH);
    const tonBalance = Math.max(0, state.balances.TON);
    const starsBalance = Math.max(0, state.balances.STARS);
    const catBalance = Math.max(0, state.balances.CAT);
    const brokerBalance = Math.max(0, state.balances.BROKER);
    
    document.getElementById('btc-balance').textContent = formatNumber(btcBalance, 6) + ' BTC';
    document.getElementById('eth-balance').textContent = formatNumber(ethBalance, 4) + ' ETH';
    document.getElementById('ton-balance').textContent = formatNumber(tonBalance, 2) + ' TON';
    document.getElementById('stars-balance').textContent = Math.floor(starsBalance) + ' STARS';
    document.getElementById('broker-balance-wallet').textContent = formatNumber(brokerBalance) + ' ₽';
    
    // Catcoins
    const catBalanceCard = document.getElementById('catcoin-balance-card');
    const catBalanceElement = document.getElementById('cat-balance');
    if (catBalanceCard && catBalanceElement) {
        if (catBalance > 0) {
            catBalanceCard.style.display = 'flex';
            catBalanceElement.textContent = Math.floor(catBalance) + ' CAT';
        } else {
            catBalanceCard.style.display = 'none';
        }
    }
}

// Функция для обновления текущей цены
function updateCurrentPrice() {
    const currentPriceElement = document.getElementById('current-price');
    if (currentPriceElement) {
        const price = state.exchangeRates[state.currentCurrency] || 0;
        currentPriceElement.textContent = `${state.currentCurrency}: $${formatNumber(price, 2)}`;
    }
}

// Функция для уничтожения всех графиков акций
function destroyAllStockCharts() {
    if (!state.stocks || !state.stocks.stockCharts) return;
    
    for (const key in state.stocks.stockCharts) {
        if (state.stocks.stockCharts[key]) {
            try {
                state.stocks.stockCharts[key].destroy();
            } catch (e) {
                // Игнорируем ошибки при уничтожении
                console.log('Ошибка при уничтожении графика акции', key, ':', e);
            }
            state.stocks.stockCharts[key] = null;
        }
    }
    state.stocks.stockCharts = {};
}

// Вспомогательная функция для обновления всех балансов
function updateAllBalances() {
    // Обновляем отображение всех балансов
    document.getElementById('rub-balance').textContent = formatNumber(state.balances.RUB) + ' ₽';
    document.getElementById('btc-balance').textContent = formatNumber(state.balances.BTC, 6) + ' BTC';
    document.getElementById('eth-balance').textContent = formatNumber(state.balances.ETH, 4) + ' ETH';
    document.getElementById('ton-balance').textContent = formatNumber(state.balances.TON, 2) + ' TON';
    document.getElementById('stars-balance').textContent = Math.floor(state.balances.STARS) + ' STARS';
    document.getElementById('cat-balance').textContent = Math.floor(state.balances.CAT) + ' CAT';
    document.getElementById('broker-balance-wallet').textContent = formatNumber(state.balances.BROKER) + ' ₽';
}

// Функция для безопасного уничтожения всех графиков акций
function destroyAllStockCharts() {
    if (!state.stocks || !state.stocks.stockCharts) return;
    
    for (const key in state.stocks.stockCharts) {
        if (state.stocks.stockCharts[key]) {
            try {
                state.stocks.stockCharts[key].destroy();
            } catch (e) {
                console.log('Ошибка при уничтожении графика', key, ':', e);
            }
            state.stocks.stockCharts[key] = null;
        }
    }
    state.stocks.stockCharts = {};
}
        // Инициализация навигации - ОБНОВЛЕНА
        function initNavigation() {
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(targetTab).classList.add('active');
                    
                    updateUI();
                    
                    if (targetTab === 'upgrade') {
                        updateNFTUpgradeSelector();
                    } else if (targetTab === 'slots') {
                        updateSlotsNFTSelector();
                    } else if (targetTab === 'stocks') {
                        updateStocksUI();
                    }
                });
            });
        }

        // Добавление транзакции в историю - ОБНОВЛЕНА
        function addTransaction(type, currency, amount, result = null, resultCurrency = null) {
            const transaction = {
                id: Date.now(),
                type,
                currency,
                amount,
                result,
                resultCurrency,
                timestamp: new Date().toLocaleString('ru-RU')
            };
            
            state.transactionHistory.unshift(transaction);
            
            if (state.transactionHistory.length > 20) {
                state.transactionHistory = state.transactionHistory.slice(0, 20);
            }
            
            updateTransactionHistory();
        }

        // Обновление истории транзакций - ОБНОВЛЕНА
        function updateTransactionHistory() {
            const historyElement = document.getElementById('transaction-history');
            historyElement.innerHTML = '';
            
            if (state.transactionHistory.length === 0) {
                historyElement.innerHTML = '<div style="text-align: center; padding: 20px; color: #AAAAAA;">История операций пуста</div>';
                return;
            }
            
            state.transactionHistory.forEach(transaction => {
                const item = document.createElement('div');
                item.className = 'transaction-item';
                
                let description = '';
                let amountText = '';
                
                switch (transaction.type) {
                    // Существующие типы...
                    case 'win':
                        description = `Выигрыш в торговле (${transaction.currency})`;
                        amountText = `<span class="transaction-amount positive">+${formatNumber(transaction.amount, 6)} ${transaction.currency}</span>`;
                        break;
                    case 'loss':
                        description = `Проигрыш в торговле (${transaction.currency})`;
                        amountText = `<span class="transaction-amount negative">-${formatNumber(Math.abs(transaction.amount), 6)} ${transaction.currency}</span>`;
                        break;
                    case 'conversion':
                        description = `Конвертация ${transaction.currency}`;
                        amountText = `<span class="transaction-amount negative">-${formatNumber(Math.abs(transaction.amount), 6)} ${transaction.currency}</span><br><span class="transaction-amount positive">+${formatNumber(transaction.result, 6)} ${transaction.resultCurrency || ''}</span>`;
                        break;
                    case 'deposit':
                        description = 'Пополнение счета';
                        amountText = `<span class="transaction-amount positive">+${formatNumber(transaction.amount)} ₽</span>`;
                        break;
                    case 'withdrawal':
                        description = 'Вывод средств';
                        amountText = `<span class="transaction-amount negative">-${formatNumber(Math.abs(transaction.amount))} ₽</span>`;
                        break;
                    case 'nft_buy':
                        description = `Покупка NFT (${transaction.currency})`;
                        amountText = `<span class="transaction-amount negative">-${formatNumber(Math.abs(transaction.amount))} ${transaction.resultCurrency || ''}</span>`;
                        break;
                    case 'nft_sell':
                        description = `Продажа NFT (${transaction.currency})`;
                        amountText = `<span class="transaction-amount positive">+${formatNumber(transaction.amount)} ${transaction.resultCurrency || ''}</span>`;
                        break;
                    case 'crash_win':
                        description = 'Выигрыш в Crash Game';
                        amountText = `<span class="transaction-amount positive">+${formatNumber(transaction.amount)} STARS</span>`;
                        break;
                    case 'crash_loss':
                        description = 'Проигрыш в Crash Game';
                        amountText = `<span class="transaction-amount negative">-${formatNumber(Math.abs(transaction.amount))} STARS</span>`;
                        break;
                    case 'clicker_upgrade':
                        description = 'Улучшение кликера';
                        amountText = `<span class="transaction-amount negative">-${formatNumber(Math.abs(transaction.amount))} TON</span>`;
                        break;
                    case 'autoclicker_buy':
                        description = 'Покупка автокликера';
                        amountText = `<span class="transaction-amount negative">-${formatNumber(Math.abs(transaction.amount))} TON</span>`;
                        break;
                    case 'catcoin_convert':
                        description = 'Конвертация Catcoin';
                        amountText = `<span class="transaction-amount negative">-${formatNumber(Math.abs(transaction.amount))} CAT</span><br><span class="transaction-amount positive">+${formatNumber(transaction.result, 6)} TON</span>`;
                        break;
                    // НОВЫЕ типы транзакций
                    case 'broker_transfer':
                        description = 'Перевод на брокерский счет';
                        amountText = `<span class="transaction-amount negative">-${formatNumber(Math.abs(transaction.amount))} RUB</span><br><span class="transaction-amount positive">+${formatNumber(transaction.result)} BROKER</span>`;
                        break;
                    case 'broker_withdraw':
                        description = 'Вывод с брокерского счета';
                        amountText = `<span class="transaction-amount negative">-${formatNumber(Math.abs(transaction.amount))} BROKER</span><br><span class="transaction-amount positive">+${formatNumber(transaction.result)} RUB</span>`;
                        break;
                    case 'stock_buy':
                        description = `Покупка акций ${transaction.currency}`;
                        amountText = `<span class="transaction-amount negative">-${formatNumber(Math.abs(transaction.amount))} RUB</span><br><span class="transaction-amount positive">+${formatNumber(transaction.result)} акций</span>`;
                        break;
                    case 'stock_sell':
                        description = `Продажа акций ${transaction.currency}`;
                        amountText = `<span class="transaction-amount positive">+${formatNumber(transaction.amount)} RUB</span><br><span class="transaction-amount negative">-${formatNumber(Math.abs(transaction.result))} акций</span>`;
                        break;
                    case 'slot_win':
                        description = 'Выигрыш в слотах';
                        amountText = `<span class="transaction-amount positive">+${formatNumber(transaction.amount)} NFT</span>`;
                        break;
                    case 'slot_loss':
                        description = 'Проигрыш в слотах';
                        amountText = `<span class="transaction-amount negative">-1 NFT</span>`;
                        break;
                }
                
                item.innerHTML = `
                    <div>
                        <div>${description}</div>
                        <div style="font-size: 0.9rem; color: #AAAAAA;">${transaction.timestamp}</div>
                    </div>
                    <div style="text-align: right;">
                        ${amountText}
                    </div>
                `;
                
                historyElement.appendChild(item);
            });
        }

        // Остальные существующие функции остаются без изменений...

        // Загрузка системных настроек
        function loadSystemSettings() {
            const savedSettings = localStorage.getItem('cryptoExchangeSystemSettings');
            if (savedSettings) {
                Object.assign(systemSettings, JSON.parse(savedSettings));
            }
            
            const savedCommission = localStorage.getItem('cryptoExchangeAdminCommission');
            if (savedCommission) {
                systemSettings.adminCommission = parseFloat(savedCommission);
            }
        }

        // Сохранение системных настроек
        function saveSystemSettings() {
            localStorage.setItem('cryptoExchangeSystemSettings', JSON.stringify(systemSettings));
            localStorage.setItem('cryptoExchangeAdminCommission', systemSettings.adminCommission.toString());
        }

        // Проверка авторизации
        function checkAuth() {
            const savedUser = localStorage.getItem('cryptoExchangeUser');
            if (savedUser) {
                state.user = JSON.parse(savedUser);
                state.isAdmin = (state.user.username === 'admin');
                showMainApp();
                loadUserData();
            } else {
                showAuth();
            }
        }

        // Показать основное приложение
        function showMainApp() {
            document.getElementById('auth').style.display = 'none';
            document.getElementById('main-nav').style.display = 'flex';
            
            if (state.isAdmin) {
                document.getElementById('admin-tab').style.display = 'block';
            }
        }

        // Показать авторизацию
        function showAuth() {
            document.getElementById('auth').style.display = 'block';
            document.getElementById('main-nav').style.display = 'none';
        }

        // Инициализация аутентификации
        function initAuth() {
            const authTabs = document.querySelectorAll('.auth-tab');
            authTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const authType = this.getAttribute('data-auth');
                    
                    authTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.auth-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(`${authType}-form`).classList.add('active');
                });
            });
            
            document.getElementById('btn-login').addEventListener('click', function() {
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                
                if (!username || !password) {
                    showNotification('Заполните все поля', 'error');
                    return;
                }
                
                if (username === 'admin' && password === '74829') {
                    state.user = { username: 'admin', created: new Date().toLocaleDateString('ru-RU') };
                    state.isAdmin = true;
                    localStorage.setItem('cryptoExchangeUser', JSON.stringify(state.user));
                    showMainApp();
                    loadUserData();
                    updateUI();
                    showNotification('Успешный вход как Администратор!', 'success');
                    return;
                }
                
                const users = JSON.parse(localStorage.getItem('cryptoExchangeUsers') || '{}');
                const user = users[username];
                
                if (!user || user.password !== password) {
                    showNotification('Неверный логин или пароль', 'error');
                    return;
                }
                
                state.user = { username, created: user.created };
                state.isAdmin = false;
                localStorage.setItem('cryptoExchangeUser', JSON.stringify(state.user));
                showMainApp();
                loadUserData();
                updateUI();
                showNotification('Успешный вход!', 'success');
            });
            
            document.getElementById('btn-register').addEventListener('click', function() {
                const username = document.getElementById('register-username').value;
                const password = document.getElementById('register-password').value;
                const confirm = document.getElementById('register-confirm').value;
                
                if (!username || !password || !confirm) {
                    showNotification('Заполните все поля', 'error');
                    return;
                }
                
                if (password !== confirm) {
                    showNotification('Пароли не совпадают', 'error');
                    return;
                }
                
                if (password.length < 4) {
                    showNotification('Пароль должен быть не менее 4 символов', 'error');
                    return;
                }
                
                if (username === 'admin') {
                    showNotification('Логин "admin" зарезервирован', 'error');
                    return;
                }
                
                const users = JSON.parse(localStorage.getItem('cryptoExchangeUsers') || '{}');
                
                if (users[username]) {
                    showNotification('Пользователь с таким логином уже существует', 'error');
                    return;
                }
                
                users[username] = {
                    password: password,
                    created: new Date().toLocaleDateString('ru-RU')
                };
                
                localStorage.setItem('cryptoExchangeUsers', JSON.stringify(users));
                
                state.user = { username, created: users[username].created };
                state.isAdmin = false;
                localStorage.setItem('cryptoExchangeUser', JSON.stringify(state.user));
                showMainApp();
                saveUserData();
                updateUI();
                showNotification('Аккаунт успешно создан!', 'success');
            });
        }

        // Инициализация вкладки "Админ"
        function initAdminTab() {
            document.getElementById('btn-enable-luck').addEventListener('click', function() {
                systemSettings.doubleLuckMode = true;
                saveSystemSettings();
                updateUI();
                showNotification('Режим 2x удачи активирован для всех пользователей!', 'success');
            });
            
            document.getElementById('btn-disable-luck').addEventListener('click', function() {
                systemSettings.doubleLuckMode = false;
                saveSystemSettings();
                updateUI();
                showNotification('Режим 2x удачи отключен', 'info');
            });
            
            document.getElementById('btn-enable-catcoin').addEventListener('click', function() {
                systemSettings.catcoinListed = true;
                saveSystemSettings();
                updateUI();
                showNotification('Catcoin добавлен в листинг! Теперь его можно конвертировать в TON.', 'success');
            });
            
            document.getElementById('btn-disable-catcoin').addEventListener('click', function() {
                systemSettings.catcoinListed = false;
                saveSystemSettings();
                updateUI();
                showNotification('Catcoin убран из листинга. Конвертация больше недоступна.', 'info');
            });
        }

        // Инициализация вкладки "Crash Game"
        function initCrashGame() {
            document.getElementById('btn-crash-bet').addEventListener('click', placeCrashBet);
            document.getElementById('btn-crash-cashout').addEventListener('click', cashOutCrash);
            updateCrashUI();
        }

        // Размещение ставки в Crash Game
        function placeCrashBet() {
            if (state.crashGame.isBetting) {
                showNotification('У вас уже есть активная ставка', 'error');
                return;
            }
            
            if (state.crashGame.isRunning) {
                showNotification('Дождитесь окончания текущей игры', 'error');
                return;
            }
            
            const amount = parseInt(document.getElementById('crash-bet-amount').value);
            
            if (!amount || amount <= 0) {
                showNotification('Введите корректную сумму ставки', 'error');
                return;
            }
            
            if (amount > state.balances.STARS) {
                showNotification('Недостаточно STARS для ставки', 'error');
                return;
            }
            
            if (amount < 1) {
                showNotification('Минимальная ставка: 1 STAR', 'error');
                return;
            }
            
            startCrashGame();
            
            state.crashGame.isBetting = true;
            state.crashGame.currentBet = amount;
            state.crashGame.hasCashedOut = false;
            state.balances.STARS -= amount;
            
            document.getElementById('btn-crash-bet').disabled = true;
            document.getElementById('btn-crash-cashout').disabled = false;
            document.getElementById('crash-bet-amount').disabled = true;
            
            saveUserData();
            updateUI();
            showNotification(`Ставка ${amount} STARS размещена!`, 'success');
        }

        // Забрать выигрыш в Crash Game
        function cashOutCrash() {
            if (!state.crashGame.isBetting || state.crashGame.hasCashedOut) {
                showNotification('Нет активной ставки для вывода', 'error');
                return;
            }
            
            if (state.crashGame.multiplier < 1.20) {
                showNotification('Минимальный множитель для вывода: 1.20x', 'error');
                return;
            }
            
            const winAmount = Math.floor(state.crashGame.currentBet * state.crashGame.multiplier);
            state.balances.STARS += winAmount;
            state.crashGame.hasCashedOut = true;
            
            state.crashGame.history.unshift({
                multiplier: state.crashGame.multiplier.toFixed(2),
                bet: state.crashGame.currentBet,
                win: winAmount,
                type: 'win',
                timestamp: new Date().toLocaleTimeString('ru-RU')
            });
            
            state.userStats.crashWins++;
            
            if (state.crashGame.history.length > 10) {
                state.crashGame.history = state.crashGame.history.slice(0, 10);
            }
            
            endCrashGame();
            
            addTransaction('crash_win', 'STARS', winAmount - state.crashGame.currentBet);
            
            saveUserData();
            updateUI();
            showNotification(`Вы успешно забрали ${winAmount} STARS (${state.crashGame.multiplier.toFixed(2)}x)!`, 'success');
        }

        // Запуск игры Crash
        function startCrashGame() {
            if (state.crashGame.isRunning) {
                return;
            }
            
            state.crashGame.isRunning = true;
            state.crashGame.multiplier = 1.00;
            state.crashGame.graphPoints = [];
            
            let crashPoint;
            
            if (Math.random() < state.crashGame.instantCrashChance) {
                crashPoint = 1.00;
                showNotification('💥 МОМЕНТАЛЬНЫЙ КРАШ!', 'error');
            } else if (Math.random() < state.crashGame.earlyCrashChance) {
                crashPoint = 1.0 + Math.random() * 1.0;
            } else if (systemSettings.doubleLuckMode) {
                crashPoint = 2.0 + Math.random() * 8.0;
            } else {
                crashPoint = 1.5 + Math.random() * 3.5;
            }
            
            state.crashGame.crashPoint = crashPoint;
            
            state.crashGame.gameInterval = setInterval(updateCrashGame, 100);
        }

        // Обновление игры Crash
        function updateCrashGame() {
            if (!state.crashGame.isRunning) return;
            
            const increment = 0.01 + (state.crashGame.multiplier * 0.001);
            state.crashGame.multiplier += increment;
            
            state.crashGame.graphPoints.push(state.crashGame.multiplier);
            
            updateCrashUI();
            
            if (state.crashGame.multiplier >= state.crashGame.crashPoint) {
                endCrashGame();
            }
        }

        // Завершение игры Crash
        function endCrashGame() {
            state.crashGame.isRunning = false;
            clearInterval(state.crashGame.gameInterval);
            
            if (state.crashGame.isBetting && !state.crashGame.hasCashedOut) {
                state.crashGame.isBetting = false;
                state.crashGame.hasCashedOut = false;
                
                state.crashGame.history.unshift({
                    multiplier: state.crashGame.multiplier.toFixed(2),
                    bet: state.crashGame.currentBet,
                    win: 0,
                    type: 'loss',
                    timestamp: new Date().toLocaleTimeString('ru-RU')
                });
                
                if (state.crashGame.history.length > 10) {
                    state.crashGame.history = state.crashGame.history.slice(0, 10);
                }
                
                addTransaction('crash_loss', 'STARS', -state.crashGame.currentBet);
                
                showNotification(`Краш на ${state.crashGame.multiplier.toFixed(2)}x! Вы проиграли ${state.crashGame.currentBet} STARS`, 'error');
            }
            
            document.getElementById('btn-crash-bet').disabled = false;
            document.getElementById('btn-crash-cashout').disabled = true;
            document.getElementById('crash-bet-amount').disabled = false;
            
            state.crashGame.multiplier = 1.00;
            state.crashGame.isBetting = false;
            state.crashGame.hasCashedOut = false;
            state.crashGame.currentBet = 0;
            
            setTimeout(() => {
                state.crashGame.graphPoints = [];
                updateCrashUI();
            }, 3000);
            
            saveUserData();
            updateUI();
        }

        // Обновление UI Crash Game
        function updateCrashUI() {
            const multiplierElement = document.getElementById('crash-multiplier');
            const availableStarsElement = document.getElementById('available-stars');
            
            multiplierElement.textContent = state.crashGame.multiplier.toFixed(2) + 'x';
            availableStarsElement.textContent = Math.floor(state.balances.STARS);
            
            document.getElementById('instant-crash-chance').textContent = (state.crashGame.instantCrashChance * 100) + '%';
            document.getElementById('early-crash-chance').textContent = (state.crashGame.earlyCrashChance * 100) + '%';
            document.getElementById('max-multiplier').textContent = state.crashGame.maxMultiplier.toFixed(1) + 'x';
            
            updateCrashGraph();
            updateCrashHistory();
        }

        // Обновление графика Crash Game
        function updateCrashGraph() {
            const graphElement = document.getElementById('crash-graph');
            const lineElement = document.getElementById('crash-line');
            
            graphElement.querySelectorAll('.crash-point').forEach(point => point.remove());
            
            if (state.crashGame.graphPoints.length === 0) {
                lineElement.style.transform = 'scaleX(0)';
                return;
            }
            
            const progress = Math.min(1, state.crashGame.graphPoints.length / 100);
            lineElement.style.transform = `scaleX(${progress})`;
            
            state.crashGame.graphPoints.forEach((point, index) => {
                if (index % 10 === 0) {
                    const pointElement = document.createElement('div');
                    pointElement.className = 'crash-point';
                    pointElement.style.left = `${(index / 100) * 100}%`;
                    pointElement.style.top = `${100 - (point * 10)}%`;
                    graphElement.appendChild(pointElement);
                }
            });
        }

        // Обновление истории Crash Game
        function updateCrashHistory() {
            const historyElement = document.getElementById('crash-history');
            historyElement.innerHTML = '';
            
            state.crashGame.history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = `crash-history-item ${item.type}`;
                historyItem.textContent = `${item.multiplier}x`;
                historyElement.appendChild(historyItem);
            });
        }

        // Инициализация вкладки "Улучшение"
        function initUpgradeTab() {
            document.getElementById('btn-upgrade-nft').addEventListener('click', upgradeNFT);
        }

        // Обновление селектора NFT для улучшения
        function updateNFTUpgradeSelector() {
            const selector = document.getElementById('nft-upgrade-selector');
            selector.innerHTML = '';
            
            const ownedNFTs = state.nfts.filter(nft => nft.owned > 0);
            
            if (ownedNFTs.length === 0) {
                selector.innerHTML = '<div style="text-align: center; padding: 40px; color: #AAAAAA; grid-column: 1 / -1;">У вас пока нет NFT для улучшения</div>';
                document.getElementById('btn-upgrade-nft').disabled = true;
                return;
            }
            
            ownedNFTs.forEach(nft => {
                const totalOwned = nft.owned;
                const upgradedCount = nft.upgraded ? nft.upgraded.length : 0;
                const availableForUpgrade = totalOwned - upgradedCount;
                
                if (availableForUpgrade <= 0) return;
                
                const nftItem = document.createElement('div');
                nftItem.className = `nft-selector-item ${state.nftUpgrade.selectedNft === nft.id ? 'selected' : ''}`;
                nftItem.setAttribute('data-nft-id', nft.id);
                nftItem.innerHTML = `
                    <div class="nft-emoji">${nft.emoji}</div>
                    <div>${nft.name}</div>
                    <div style="font-size: 0.9rem; color: #AAAAAA;">
                        Можно улучшить: ${availableForUpgrade}/${totalOwned}
                    </div>
                    ${nft.upgraded && nft.upgraded.length > 0 ? 
                        `<div style="font-size: 0.8rem; margin-top: 4px;">Улучшено: ${nft.upgraded.length}</div>` : ''}
                `;
                
                nftItem.addEventListener('click', function() {
                    if (availableForUpgrade <= 0) return;
                    
                    document.querySelectorAll('.nft-selector-item').forEach(item => item.classList.remove('selected'));
                    this.classList.add('selected');
                    state.nftUpgrade.selectedNft = nft.id;
                    document.getElementById('btn-upgrade-nft').disabled = false;
                });
                
                selector.appendChild(nftItem);
            });
            
            if (selector.children.length === 0) {
                selector.innerHTML = '<div style="text-align: center; padding: 40px; color: #AAAAAA; grid-column: 1 / -1;">Все ваши NFT уже улучшены</div>';
                document.getElementById('btn-upgrade-nft').disabled = true;
            }
        }

        // Улучшение NFT
        function upgradeNFT() {
            if (state.nftUpgrade.isUpgrading) return;
            
            const nftId = state.nftUpgrade.selectedNft;
            if (!nftId) {
                showNotification('Выберите NFT для улучшения', 'error');
                return;
            }
            
            const nft = state.nfts.find(n => n.id === nftId);
            if (!nft || nft.owned <= 0) {
                showNotification('NFT не найден', 'error');
                return;
            }
            
            const upgradedCount = nft.upgraded ? nft.upgraded.length : 0;
            if (upgradedCount >= nft.owned) {
                showNotification('Все экземпляры этого NFT уже улучшены', 'error');
                return;
            }
            
            state.nftUpgrade.isUpgrading = true;
            document.getElementById('btn-upgrade-nft').disabled = true;
            
            showUpgradeAnimation();
            
            setTimeout(() => {
                determineUpgradeResult(nft);
            }, 3000);
        }

        // Показать анимацию улучшения
        function showUpgradeAnimation() {
            const animationContainer = document.getElementById('upgrade-animation');
            const animationContent = document.getElementById('upgrade-animation-content');
            
            animationContent.innerHTML = '';
            
            for (let i = 0; i < 20; i++) {
                const color = state.nftUpgrade.upgradeColors[Math.floor(Math.random() * state.nftUpgrade.upgradeColors.length)];
                const nftItem = document.createElement('div');
                nftItem.className = 'upgrade-nft-item';
                nftItem.classList.add(color.class);
                nftItem.innerHTML = `
                    <div style="font-size: 2.5rem;">${state.nfts.find(n => n.id === state.nftUpgrade.selectedNft).emoji}</div>
                    <div style="font-size: 0.9rem; margin-top: 8px;">${color.name}</div>
                `;
                animationContent.appendChild(nftItem);
            }
            
            animationContainer.style.display = 'block';
            animationContent.style.animation = 'scrollAnimation 3s linear';
        }

        // Определить результат улучшения
        function determineUpgradeResult(nft) {
            const random = Math.random();
            let cumulativeChance = 0;
            let selectedColor = null;
            
            for (const color of state.nftUpgrade.upgradeColors) {
                cumulativeChance += color.chance;
                if (random <= cumulativeChance) {
                    selectedColor = color;
                    break;
                }
            }
            
            if (!selectedColor) {
                selectedColor = state.nftUpgrade.upgradeColors[state.nftUpgrade.upgradeColors.length - 1];
            }
            
            const newPrice = Math.floor(nft.price * selectedColor.multiplier);
            
            if (!nft.upgraded) {
                nft.upgraded = [];
            }
            
            nft.upgraded.push({
                color: selectedColor.name,
                colorClass: selectedColor.class,
                multiplier: selectedColor.multiplier,
                rarity: selectedColor.rarity,
                price: newPrice,
                upgradedAt: new Date().toLocaleString('ru-RU')
            });
            
            state.userStats.totalUpgrades++;
            
            document.getElementById('upgrade-animation').style.display = 'none';
            
            showUpgradeResult(nft, selectedColor, newPrice);
            
            saveUserData();
            
            updateUI();
            updateNFTUpgradeSelector();
            
            state.nftUpgrade.isUpgrading = false;
            document.getElementById('btn-upgrade-nft').disabled = false;
        }

        // Показать результат улучшения
        function showUpgradeResult(nft, color, newPrice) {
            const resultElement = document.getElementById('upgrade-result');
            resultElement.className = 'upgrade-result';
            
            const isProfitable = color.multiplier > 1;
            
            if (isProfitable) {
                resultElement.classList.add('success');
                resultElement.innerHTML = `
                    <h3>🎉 Успешное улучшение!</h3>
                    <p>Вы получили ${color.name.toUpperCase()} фон (x${color.multiplier})</p>
                    <p>Новая цена NFT: ${formatNumber(newPrice)} STARS</p>
                    <p><span class="nft-upgrade-indicator upgrade-${color.rarity}">${color.rarity.toUpperCase()}</span></p>
                `;
                showNotification(`NFT "${nft.name}" успешно улучшен до ${color.name} фона! Цена: x${color.multiplier}`, 'success');
            } else {
                resultElement.classList.add('failure');
                resultElement.innerHTML = `
                    <h3>😔 Не очень удачное улучшение</h3>
                    <p>Вы получили ${color.name.toUpperCase()} фон (x${color.multiplier})</p>
                    <p>Новая цена NFT: ${formatNumber(newPrice)} STARS</p>
                    <p><span class="nft-upgrade-indicator upgrade-${color.rarity}">${color.rarity.toUpperCase()}</span></p>
                `;
                showNotification(`NFT "${nft.name}" улучшен до ${color.name} фона. Увы, не окупилось`, 'info');
            }
            
            resultElement.style.display = 'block';
            
            setTimeout(() => {
                resultElement.style.display = 'none';
            }, 5000);
        }

        // Инициализация вкладки "Кликер"
        function initClickerTab() {
            document.getElementById('clicker-button').addEventListener('click', handleClickerClick);
            document.getElementById('btn-upgrade-click').addEventListener('click', upgradeClick);
            document.getElementById('btn-buy-auto-clicker').addEventListener('click', buyAutoClicker);
            document.getElementById('btn-convert-catcoin').addEventListener('click', convertCatcoin);
        }

        // Обработчик клика по кликеру
        function handleClickerClick() {
            const now = Date.now();
            
            if (now - state.clicker.lastClickTime < state.clicker.clickDelay) {
                return;
            }
            
            state.clicker.lastClickTime = now;
            
            state.balances.CAT += state.clicker.coinsPerClick;
            state.clicker.totalClicks++;
            state.userStats.totalClicks++;
            
            updateClickerUI();
            
            saveUserData();
            
            const clickerButton = document.getElementById('clicker-button');
            clickerButton.style.transform = 'scale(0.95)';
            setTimeout(() => {
                clickerButton.style.transform = 'scale(1)';
            }, 100);
        }

        // Улучшение клика
        function upgradeClick() {
            const upgrade = state.clicker.upgrades.click;
            const currentPrice = Math.floor(upgrade.basePrice * Math.pow(upgrade.priceMultiplier, upgrade.level));
            
            if (state.balances.TON < currentPrice) {
                showNotification('Недостаточно TON для улучшения', 'error');
                return;
            }
            
            showConfirmModal(
                `Вы уверены, что хотите улучшить клик за ${formatNumber(currentPrice)} TON?`,
                () => {
                    state.balances.TON -= currentPrice;
                    state.clicker.coinsPerClick += 1;
                    state.clicker.upgrades.click.level++;
                    
                    addTransaction('clicker_upgrade', 'TON', -currentPrice);
                    
                    saveUserData();
                    
                    updateUI();
                    updateClickerUI();
                    
                    showNotification(`Клик улучшен! Теперь вы получаете ${state.clicker.coinsPerClick} коинов за клик`, 'success');
                }
            );
        }

        // Покупка автокликера
        function buyAutoClicker() {
            const upgrade = state.clicker.upgrades.autoClicker;
            const currentPrice = Math.floor(upgrade.basePrice * Math.pow(upgrade.priceMultiplier, upgrade.level));
            
            if (state.balances.TON < currentPrice) {
                showNotification('Недостаточно TON для покупки автокликера', 'error');
                return;
            }
            
            showConfirmModal(
                `Вы уверены, что хотите купить автокликер за ${formatNumber(currentPrice)} TON?`,
                () => {
                    state.balances.TON -= currentPrice;
                    state.clicker.autoClickerRate += 1;
                    state.clicker.upgrades.autoClicker.level++;
                    
                    if (!state.clicker.autoClickerInterval) {
                        startAutoClicker();
                    }
                    
                    addTransaction('autoclicker_buy', 'TON', -currentPrice);
                    
                    saveUserData();
                    
                    updateUI();
                    updateClickerUI();
                    
                    showNotification(`Автокликер куплен! Теперь вы получаете ${state.clicker.autoClickerRate} коинов в секунду`, 'success');
                }
            );
        }

        // Запуск автокликера
        function startAutoClicker() {
            if (state.clicker.autoClickerInterval) {
                clearInterval(state.clicker.autoClickerInterval);
            }
            
            state.clicker.autoClickerInterval = setInterval(() => {
                if (state.clicker.autoClickerRate > 0) {
                    state.balances.CAT += state.clicker.autoClickerRate;
                    updateClickerUI();
                    saveUserData();
                }
            }, 1000);
        }

        // Конвертация Catcoins
        function convertCatcoin() {
            if (!systemSettings.catcoinListed) {
                showNotification('Конвертация Catcoin недоступна', 'error');
                return;
            }
            
            const amount = parseInt(document.getElementById('catcoin-convert-amount').value);
            
            if (!amount || amount <= 0) {
                showNotification('Введите корректное количество CAT', 'error');
                return;
            }
            
            if (amount > state.balances.CAT) {
                showNotification('Недостаточно Catcoins для конвертации', 'error');
                return;
            }
            
            const result = amount * 0.001;
            
            showConfirmModal(
                `Вы уверены, что хотите конвертировать ${formatNumber(amount)} CAT в ${formatNumber(result, 6)} TON?`,
                () => {
                    state.balances.CAT -= amount;
                    state.balances.TON += result;
                    
                    addTransaction('catcoin_convert', 'CAT', -amount, result, 'TON');
                    
                    saveUserData();
                    
                    updateUI();
                    updateClickerUI();
                    
                    document.getElementById('catcoin-convert-amount').value = '';
                    
                    showNotification(`Успешно конвертировано ${formatNumber(amount)} CAT в ${formatNumber(result, 6)} TON`, 'success');
                }
            );
        }

        // Обновление UI кликера
        function updateClickerUI() {
            document.getElementById('catcoin-amount').textContent = Math.floor(state.balances.CAT) + ' CAT';
            document.getElementById('cat-balance').textContent = Math.floor(state.balances.CAT) + ' CAT';
            document.getElementById('cat-value').textContent = formatNumber(state.balances.CAT * state.exchangeRates.CAT, 6) + ' TON';
            
            document.getElementById('catcoin-balance-card').style.display = state.balances.CAT > 0 ? 'flex' : 'none';
            
            document.getElementById('clicker-per-click').textContent = state.clicker.coinsPerClick;
            document.getElementById('clicker-auto-rate').textContent = state.clicker.autoClickerRate;
            document.getElementById('clicker-total-clicks').textContent = state.clicker.totalClicks;
            
            const clickUpgrade = state.clicker.upgrades.click;
            const autoClickerUpgrade = state.clicker.upgrades.autoClicker;
            
            const clickPrice = Math.floor(clickUpgrade.basePrice * Math.pow(clickUpgrade.priceMultiplier, clickUpgrade.level));
            const autoClickerPrice = Math.floor(autoClickerUpgrade.basePrice * Math.pow(autoClickerUpgrade.priceMultiplier, autoClickerUpgrade.level));
            
            document.getElementById('click-upgrade-price').textContent = formatNumber(clickPrice) + ' TON';
            document.getElementById('auto-clicker-price').textContent = formatNumber(autoClickerPrice) + ' TON';
            
            document.getElementById('btn-upgrade-click').disabled = state.balances.TON < clickPrice;
            document.getElementById('btn-buy-auto-clicker').disabled = state.balances.TON < autoClickerPrice;
            
            const conversionStatus = document.getElementById('conversion-status');
            const convertInput = document.getElementById('catcoin-convert-amount');
            const convertButton = document.getElementById('btn-convert-catcoin');
            
            if (systemSettings.catcoinListed) {
                conversionStatus.innerHTML = '✅ Конвертация доступна. 1 CAT = 0.001 TON';
                conversionStatus.style.color = 'var(--success)';
                convertInput.disabled = false;
                convertButton.disabled = false;
            } else {
                conversionStatus.innerHTML = '⚠️ Конвертация недоступна. Администратор должен добавить Catcoin в листинг.';
                conversionStatus.style.color = 'var(--warning)';
                convertInput.disabled = true;
                convertButton.disabled = true;
            }
            
            const catFromOption = document.getElementById('cat-from-option');
            const catToOption = document.getElementById('cat-to-option');
            
            if (systemSettings.catcoinListed) {
                catFromOption.style.display = 'block';
                catToOption.style.display = 'block';
            } else {
                catFromOption.style.display = 'none';
                catToOption.style.display = 'none';
            }
        }

        // Инициализация вкладки "Банк"
        function initBankTab() {
            const bankTabs = document.querySelectorAll('.bank-tab');
            bankTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const bankTab = this.getAttribute('data-bank-tab');
                    
                    bankTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.bank-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(`bank-${bankTab}`).classList.add('active');
                    
                    if (bankTab === 'documents') {
                        updateDocumentsList();
                    } else if (bankTab === 'documents-shop') {
                        updateDocumentsShop();
                    } else if (bankTab === 'properties') {
                        updatePropertiesList();
                    } else if (bankTab === 'yachts') {
                        updateYachtsList();
                    } else if (bankTab === 'paintings') {
                        updatePaintingsList();
                    }
                });
            });

            document.getElementById('btn-set-deposit').addEventListener('click', function() {
                const amount = parseInt(document.getElementById('initial-deposit').value);
                
                if (!amount || amount <= 0) {
                    showNotification('Введите корректную сумму', 'error');
                    return;
                }
                
                if (!state.isAdmin && amount > 1000000) {
                    showNotification('Максимальная сумма депозита - 1,000,000 ₽', 'error');
                    return;
                }
                
                if (!state.isAdmin && state.bank.initialDepositSet) {
                    showNotification('Начальный депозит можно установить только один раз', 'error');
                    return;
                }
                
                state.bank.balance = amount;
                state.bank.initialDepositSet = true;
                saveUserData();
                updateUI();
                showNotification(`Начальный депозит ${formatNumber(amount)} ₽ успешно установлен!`, 'success');
            });

            document.getElementById('btn-add-card').addEventListener('click', function() {
                if (state.bank.cards.length >= 3) {
                    showNotification('Максимум можно иметь 3 карты', 'error');
                    return;
                }

                const newCard = generateBankCard();
                state.bank.cards.push(newCard);
                saveUserData();
                updateUI();
                showNotification('Новая карта успешно добавлена!', 'success');
            });

            document.getElementById('btn-take-credit').addEventListener('click', function() {
                const amount = parseInt(document.getElementById('credit-amount').value);
                
                if (!amount || amount < 1000) {
                    showNotification('Минимальная сумма кредита - 1,000 ₽', 'error');
                    return;
                }
                
                if (amount > 500000) {
                    showNotification('Максимальная сумма кредита - 500,000 ₽', 'error');
                    return;
                }
                
                if (state.bank.credit.taken) {
                    showNotification('У вас уже есть активный кредит', 'error');
                    return;
                }

                const totalAmount = amount * (1 + state.bank.credit.interestRate);
                state.bank.credit.amount = amount;
                state.bank.credit.remainingAmount = totalAmount;
                state.bank.credit.taken = true;
                state.bank.credit.takenDate = new Date();
                state.bank.balance += amount;
                
                saveUserData();
                updateUI();
                showNotification(`Кредит на сумму ${formatNumber(amount)} ₽ успешно получен! Общая сумма к возврату: ${formatNumber(totalAmount)} ₽`, 'success');
            });

            document.getElementById('btn-partial-repay').addEventListener('click', function() {
                const amount = parseInt(document.getElementById('repayment-amount').value);
                
                if (!amount || amount <= 0) {
                    showNotification('Введите корректную сумму для погашения', 'error');
                    return;
                }
                
                if (amount > state.bank.balance) {
                    showNotification('Недостаточно средств на банковском счете', 'error');
                    return;
                }
                
                if (amount > state.bank.credit.remainingAmount) {
                    showNotification('Сумма погашения превышает остаток долга', 'error');
                    return;
                }
                
                state.bank.balance -= amount;
                state.bank.credit.remainingAmount -= amount;
                
                if (state.bank.credit.remainingAmount <= 0) {
                    state.bank.credit.amount = 0;
                    state.bank.credit.taken = false;
                    state.bank.credit.takenDate = null;
                    state.bank.credit.remainingAmount = 0;
                    showNotification('Кредит полностью погашен!', 'success');
                } else {
                    showNotification(`Часть кредита в размере ${formatNumber(amount)} ₽ успешно погашена! Остаток долга: ${formatNumber(state.bank.credit.remainingAmount)} ₽`, 'success');
                }
                
                saveUserData();
                updateUI();
            });

            document.getElementById('btn-create-document').addEventListener('click', function() {
                const owner = document.getElementById('document-owner').value;
                const type = document.getElementById('document-type').value;
                
                if (!owner) {
                    showNotification('Введите имя владельца', 'error');
                    return;
                }
                
                if (state.bank.documentTemplates <= 0) {
                    showNotification('У вас нет доступных шаблонов документов. Приобретите их в магазине документов.', 'error');
                    return;
                }
                
                const newDocument = {
                    id: Date.now(),
                    owner: owner,
                    type: type,
                    status: 'pending',
                    created: new Date(),
                    verified: false
                };
                
                state.bank.documents.push(newDocument);
                state.bank.documentTemplates--;
                
                setTimeout(() => {
                    newDocument.status = 'verified';
                    newDocument.verified = true;
                    saveUserData();
                    updateUI();
                    showNotification(`Документ на имя ${owner} успешно верифицирован!`, 'success');
                }, 60000);
                
                saveUserData();
                updateUI();
                showNotification('Документ создан! Верификация займет 1 минуту.', 'success');
            });
        }

        // Генерация банковской карты
        function generateBankCard() {
            const generateCardNumber = () => {
                let number = '';
                for (let i = 0; i < 16; i++) {
                    number += Math.floor(Math.random() * 10);
                    if ((i + 1) % 4 === 0 && i !== 15) number += ' ';
                }
                return number;
            };

            const generateExpiry = () => {
                const month = String(Math.floor(Math.random() * 12) + 1).padStart(2, '0');
                const year = String(new Date().getFullYear() + Math.floor(Math.random() * 5) + 1).slice(-2);
                return `${month}/${year}`;
            };

            const generateCVV = () => {
                return String(Math.floor(Math.random() * 900) + 100);
            };

            return {
                number: generateCardNumber(),
                expiry: generateExpiry(),
                cvv: generateCVV(),
                type: ['Visa', 'MasterCard'][Math.floor(Math.random() * 2)]
            };
        }

        // Покупка недвижимости
// НАЙДИ ЭТУ ФУНКЦИЮ И ЗАМЕНИ ВСЮ:
function buyProperty(propertyId) {
    const property = propertiesData.find(p => p.id === propertyId);
    if (!property) return;

    const hasVerifiedDocument = state.bank.documents.some(doc => 
        doc.status === 'verified' && doc.verified === true && doc.type === property.documentType
    );

    if (!hasVerifiedDocument) {
        const docTypeName = getDocumentTypeName(property.documentType);
        showNotification(`Для покупки ${property.name} необходим подтвержденный документ типа "${docTypeName}"`, 'error');
        return;
    }

    if (state.bank.balance < property.price) {
        showNotification('Недостаточно средств на банковском счете', 'error');
        return;
    }

    // ИСПРАВЛЕНИЕ: Проверяем, не куплено ли уже это имущество
    const isAlreadyOwned = state.bank.properties.some(p => p.id === propertyId);
    if (isAlreadyOwned) {
        showNotification(`Вы уже владеете ${property.name}!`, 'error');
        return;
    }

    showConfirmModal(
        `Вы уверены, что хотите купить ${property.name} за ${formatNumber(property.price)} ₽?`,
        () => {
            state.bank.balance -= property.price;
            state.bank.properties.push({
                id: property.id,
                name: property.name,
                price: property.price,
                emoji: property.emoji,
                type: property.type,
                purchaseDate: new Date().toLocaleDateString('ru-RU')
            });
            
            saveUserData();
            updateUI();
            showNotification(`${property.name} успешно куплен(а)!`, 'success');
        }
    );
}

        // Покупка яхты
        function buyYacht(yachtId) {
            const yacht = yachtsData.find(y => y.id === yachtId);
            if (!yacht) return;

            const hasVerifiedYachtDocument = state.bank.documents.some(doc => 
                doc.status === 'verified' && doc.verified === true && doc.type === 'yacht'
            );

            if (!hasVerifiedYachtDocument) {
                showNotification('Для покупки яхты необходим подтвержденный документ типа "Яхта"', 'error');
                return;
            }

            if (state.bank.balance < yacht.price) {
                showNotification('Недостаточно средств на банковском счете', 'error');
                return;
            }

            showConfirmModal(
                `Вы уверены, что хотите купить ${yacht.name} за ${formatNumber(yacht.price)} ₽?`,
                () => {
                    state.bank.balance -= yacht.price;
                    state.bank.yachts.push({
                        id: yacht.id,
                        name: yacht.name,
                        price: yacht.price,
                        emoji: yacht.emoji,
                        type: yacht.type,
                        length: yacht.length,
                        purchaseDate: new Date().toLocaleDateString('ru-RU')
                    });
                    
                    saveUserData();
                    updateUI();
                    showNotification(`${yacht.name} успешно куплена!`, 'success');
                }
            );
        }

        // Покупка документов в магазине
        function buyDocumentTemplate(itemId) {
            const item = documentsShopData.find(d => d.id === itemId);
            if (!item) return;

            if (state.bank.balance < item.price) {
                showNotification('Недостаточно средств на банковском счете', 'error');
                return;
            }

            let templatesToAdd = 0;
            if (itemId === 1) templatesToAdd = 1;
            else if (itemId === 2) templatesToAdd = 3;
            else if (itemId === 3) templatesToAdd = 7;

            showConfirmModal(
                `Вы уверены, что хотите купить ${item.name} за ${formatNumber(item.price)} ₽?`,
                () => {
                    state.bank.balance -= item.price;
                    state.bank.documentTemplates += templatesToAdd;
                    
                    saveUserData();
                    updateUI();
                    showNotification(`${item.name} успешно куплен! Доступно шаблонов: ${state.bank.documentTemplates}`, 'success');
                }
            );
        }

        // Обновление списка карт
        function updateCardsList() {
            const cardsList = document.getElementById('cards-list');
            cardsList.innerHTML = '';
            
            if (state.bank.cards.length === 0) {
                cardsList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-gray);">У вас пока нет банковских карт</div>';
                return;
            }
            
            state.bank.cards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card-item';
                cardElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;">${card.type}</h3>
                        <span style="font-size: 0.9rem; opacity: 0.8;">Карта ${index + 1}</span>
                    </div>
                    <div class="card-number">${card.number}</div>
                    <div class="card-details">
                        <div>
                            <div style="font-size: 0.8rem; opacity: 0.8;">Срок действия</div>
                            <div>${card.expiry}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; opacity: 0.8;">CVV</div>
                            <div>${card.cvv}</div>
                        </div>
                    </div>
                `;
                cardsList.appendChild(cardElement);
            });
        }

        // Обновление информации о кредите
        function updateCreditInfo() {
            const creditInfo = document.getElementById('credit-info');
            const partialRepaymentSection = document.getElementById('partial-repayment-section');
            
            if (!state.bank.credit.taken) {
                creditInfo.innerHTML = `
                    <div style="background-color: var(--bank-gray); padding: 24px; border-radius: 16px; text-align: center;">
                        <h3 style="color: var(--bank-blue); margin-bottom: 12px;">Кредит не активен</h3>
                        <p style="color: var(--text-gray);">У вас нет активных кредитов</p>
                    </div>
                `;
                document.getElementById('btn-take-credit').disabled = false;
                document.getElementById('btn-take-credit').textContent = 'Взять кредит';
                partialRepaymentSection.style.display = 'none';
            } else {
                const totalDebt = state.bank.credit.remainingAmount;
                creditInfo.innerHTML = `
                    <div style="background-color: var(--bank-gray); padding: 24px; border-radius: 16px;">
                        <h3 style="color: var(--bank-blue); margin-bottom: 16px;">Активный кредит</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                            <div>
                                <div style="font-size: 0.9rem; color: var(--text-gray);">Основной долг</div>
                                <div style="font-size: 1.4rem; font-weight: bold;">${formatNumber(state.bank.credit.amount)} ₽</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: var(--text-gray);">Остаток долга</div>
                                <div style="font-size: 1.4rem; font-weight: bold; color: var(--danger);">${formatNumber(totalDebt)} ₽</div>
                            </div>
                        </div>
                        <button id="btn-repay-credit" class="btn btn-bank btn-block">Погасить кредит полностью</button>
                    </div>
                `;
                
                document.getElementById('btn-take-credit').disabled = true;
                document.getElementById('btn-take-credit').textContent = 'Кредит активен';
                partialRepaymentSection.style.display = 'block';
                
                document.getElementById('btn-repay-credit').addEventListener('click', function() {
                    const totalDebt = state.bank.credit.remainingAmount;
                    
                    if (state.bank.balance < totalDebt) {
                        showNotification('Недостаточно средств для погашения кредита', 'error');
                        return;
                    }
                    
                    showConfirmModal(
                        `Вы уверены, что хотите погасить кредит на сумму ${formatNumber(totalDebt)} ₽?`,
                        () => {
                            state.bank.balance -= totalDebt;
                            state.bank.credit.amount = 0;
                            state.bank.credit.taken = false;
                            state.bank.credit.takenDate = null;
                            state.bank.credit.remainingAmount = 0;
                            
                            saveUserData();
                            updateUI();
                            showNotification('Кредит успешно погашен!', 'success');
                        }
                    );
                });
            }
        }

        // Обновление списка документов
        function updateDocumentsList() {
            const documentsList = document.getElementById('documents-list');
            documentsList.innerHTML = '';
            
            if (state.bank.documents.length === 0) {
                documentsList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-gray);">У вас пока нет документов</div>';
                return;
            }
            
            state.bank.documents.forEach(doc => {
                const docElement = document.createElement('div');
                docElement.className = 'property-card';
                
                let statusText = '';
                let statusClass = '';
                let badgeClass = '';
                let badgeText = '';
                
                if (doc.type === 'car') {
                    badgeClass = 'badge-car';
                    badgeText = 'Авто';
                } else if (doc.type === 'property') {
                    badgeClass = 'badge-property';
                    badgeText = 'Недвижимость';
                } else if (doc.type === 'yacht') {
                    badgeClass = 'badge-yacht';
                    badgeText = 'Яхта';
                }
                
                if (doc.status === 'pending') {
                    statusText = 'Ожидает верификации';
                    statusClass = 'document-pending';
                    
                    const createdTime = new Date(doc.created).getTime();
                    const currentTime = new Date().getTime();
                    const timePassed = currentTime - createdTime;
                    const timeLeft = Math.max(0, 60000 - timePassed);
                    const secondsLeft = Math.ceil(timeLeft / 1000);
                    
                    statusText += ` (${secondsLeft}с)`;
                } else if (doc.status === 'verified') {
                    statusText = 'Проверен и действителен';
                    statusClass = 'document-verified';
                }
                
                docElement.innerHTML = `
                    <div class="property-image">📄</div>
                    <h3 style="color: var(--bank-blue); margin-bottom: 12px;">
                        Документ на ${getDocumentTypeName(doc.type)}
                        <span class="document-badge ${badgeClass}">${badgeText}</span>
                    </h3>
                    <div style="color: var(--text-gray); margin-bottom: 12px;">Владелец: ${doc.owner}</div>
                    <div class="document-status ${statusClass}">${statusText}</div>
                `;
                documentsList.appendChild(docElement);
            });
            
            const templatesInfo = document.createElement('div');
            templatesInfo.style.marginTop = '20px';
            templatesInfo.style.padding = '20px';
            templatesInfo.style.backgroundColor = '#e7f3ff';
            templatesInfo.style.borderRadius = '12px';
            templatesInfo.style.textAlign = 'center';
            templatesInfo.innerHTML = `<strong>Доступно шаблонов документов: ${state.bank.documentTemplates}</strong>`;
            documentsList.appendChild(templatesInfo);
        }

        // Обновление магазина документов
        function updateDocumentsShop() {
            const shopList = document.getElementById('documents-shop-list');
            shopList.innerHTML = '';
            
            documentsShopData.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'property-card';
                itemElement.innerHTML = `
                    <div class="property-image">${item.emoji}</div>
                    <h3 style="color: var(--bank-blue); margin-bottom: 12px;">${item.name}</h3>
                    <div style="color: var(--text-gray); margin-bottom: 16px;">${item.description}</div>
                    <div style="color: var(--bank-blue); font-weight: bold; margin-bottom: 16px;">${formatNumber(item.price)} ₽</div>
                    <button class="btn btn-bank btn-block" data-doc-item-id="${item.id}">
                        Купить
                    </button>
                `;
                shopList.appendChild(itemElement);
            });
            
            document.querySelectorAll('#documents-shop-list .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = parseInt(this.getAttribute('data-doc-item-id'));
                    buyDocumentTemplate(itemId);
                });
            });
        }

        // Обновление списка недвижимости
        function updatePropertiesList() {
            const propertiesList = document.getElementById('properties-list');
            const requirementsInfo = document.getElementById('properties-requirements');
            propertiesList.innerHTML = '';
            
            const hasCarDocument = state.bank.documents.some(doc => 
                doc.status === 'verified' && doc.verified === true && doc.type === 'car'
            );
            
            const hasPropertyDocument = state.bank.documents.some(doc => 
                doc.status === 'verified' && doc.verified === true && doc.type === 'property'
            );
            
            if (!hasCarDocument || !hasPropertyDocument) {
                requirementsInfo.style.display = 'block';
            } else {
                requirementsInfo.style.display = 'none';
            }
            
            propertiesData.forEach(property => {
                const isOwned = state.bank.properties.some(p => p.id === property.id);
                
                const hasRequiredDocument = state.bank.documents.some(doc => 
                    doc.status === 'verified' && doc.verified === true && doc.type === property.documentType
                );
                
                const propertyCard = document.createElement('div');
                propertyCard.className = 'property-card';
                
                let buttonText = 'Купить';
                if (isOwned) {
                    buttonText = '✓ Уже куплено';
                } else if (!hasRequiredDocument) {
                    buttonText = `Требуется ${getDocumentTypeName(property.documentType)}`;
                }
                
                propertyCard.innerHTML = `
                    <div class="property-image">${property.emoji}</div>
                    <h3 style="color: var(--bank-blue); margin-bottom: 12px;">${property.name}</h3>
                    <div style="color: var(--text-gray); margin-bottom: 16px;">${formatNumber(property.price)} ₽</div>
                    <div style="color: var(--text-gray); font-size: 0.9rem; margin-bottom: 12px;">
                        Требуется: <span class="document-badge badge-${property.documentType}">${getDocumentTypeName(property.documentType)}</span>
                    </div>
                    <button class="btn ${isOwned ? 'btn-outline' : (hasRequiredDocument ? 'btn-bank' : 'btn-outline')}" 
                            data-property-id="${property.id}" 
                            ${isOwned || !hasRequiredDocument ? 'disabled' : ''}>
                        ${buttonText}
                    </button>
                `;
                propertiesList.appendChild(propertyCard);
            });
            
            document.querySelectorAll('#properties-list .btn').forEach(btn => {
                if (!btn.disabled) {
                    btn.addEventListener('click', function() {
                        const propertyId = parseInt(this.getAttribute('data-property-id'));
                        buyProperty(propertyId);
                    });
                }
            });
        }

        // Обновление списка яхт
        function updateYachtsList() {
            const yachtsList = document.getElementById('yachts-list');
            const requirementsInfo = document.getElementById('yachts-requirements');
            yachtsList.innerHTML = '';
            
            const hasVerifiedYachtDocument = state.bank.documents.some(doc => 
                doc.status === 'verified' && doc.verified === true && doc.type === 'yacht'
            );
            
            if (!hasVerifiedYachtDocument) {
                requirementsInfo.style.display = 'block';
            } else {
                requirementsInfo.style.display = 'none';
            }
            
            yachtsData.forEach(yacht => {
                const isOwned = state.bank.yachts.some(y => y.id === yacht.id);
                const yachtCard = document.createElement('div');
                yachtCard.className = 'yacht-card';
                
                let buttonText = 'Купить яхту';
                if (isOwned) {
                    buttonText = '✓ Уже куплено';
                } else if (!hasVerifiedYachtDocument) {
                    buttonText = 'Требуется Яхта';
                }
                
                yachtCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0;">${yacht.name}</h3>
                        <div style="font-size: 2.5rem;">${yacht.emoji}</div>
                    </div>
                    <div style="margin-bottom: 12px;">Длина: ${yacht.length}</div>
                    <div style="margin-bottom: 16px; font-size: 1.6rem; font-weight: bold;">${formatNumber(yacht.price)} ₽</div>
                    <div style="color: white; font-size: 0.9rem; margin-bottom: 12px;">
                        Требуется: <span class="document-badge badge-yacht">Яхта</span>
                    </div>
                    <button class="btn ${isOwned ? 'btn-outline' : (hasVerifiedYachtDocument ? 'btn-bank' : 'btn-outline')}" 
                            data-yacht-id="${yacht.id}" 
                            ${isOwned || !hasVerifiedYachtDocument ? 'disabled' : ''}>
                        ${buttonText}
                    </button>
                `;
                yachtsList.appendChild(yachtCard);
            });
            
            document.querySelectorAll('#yachts-list .btn').forEach(btn => {
                if (!btn.disabled && hasVerifiedYachtDocument) {
                    btn.addEventListener('click', function() {
                        const yachtId = parseInt(this.getAttribute('data-yacht-id'));
                        buyYacht(yachtId);
                    });
                }
            });
        }

        // Получение названия типа документа
        function getDocumentTypeName(type) {
            const types = {
                'car': 'Автомобиль',
                'property': 'Недвижимость',
                'yacht': 'Яхта'
            };
            return types[type] || 'Документ';
        }

        // Автоматическое погашение кредита
        function startAutoCreditRepayment() {
            setInterval(() => {
                if (state.bank.credit.taken && state.bank.credit.remainingAmount > 0) {
                    const autoRepayment = state.bank.credit.remainingAmount * 0.02;
                    
                    if (state.bank.balance >= autoRepayment) {
                        state.bank.balance -= autoRepayment;
                        state.bank.credit.remainingAmount -= autoRepayment;
                        
                        if (state.bank.credit.remainingAmount <= 0) {
                            state.bank.credit.amount = 0;
                            state.bank.credit.taken = false;
                            state.bank.credit.takenDate = null;
                            state.bank.credit.remainingAmount = 0;
                        }
                        
                        saveUserData();
                        updateUI();
                        showNotification(`Автоматическое погашение кредита: ${formatNumber(autoRepayment)} ₽`, 'info');
                    }
                }
            }, 120000);
        }

        // Увеличение процентных ставок
        function startInterestRateIncrease() {
            setInterval(() => {
                if (state.bank.credit.taken) {
                    state.bank.credit.interestRate += 0.005;
                    state.bank.credit.remainingAmount = state.bank.credit.amount * (1 + state.bank.credit.interestRate);
                    
                    saveUserData();
                    updateUI();
                    showNotification(`Процентная ставка по кредиту увеличена до ${(state.bank.credit.interestRate * 100).toFixed(1)}%`, 'warning');
                }
            }, 300000);
        }

        // Инициализация графика
// Инициализация графика
// Инициализация графика
// Инициализация графика с безопасным уничтожением
// Инициализация графика с полным пересозданием canvas
let chartIsDestroying = false;

// Безопасная инициализация графика
// Инициализация графика - ИСПРАВЛЕННАЯ ВЕРСИЯ
// В функции initChart() убедитесь что используется правильная валюта:
function initChart() {
    const chartContainer = document.querySelector('.chart-container');
    
    if (!chartContainer) {
        console.log('Контейнер графика не найден');
        return;
    }
    
    // Удаляем старый canvas если есть
    const oldCanvas = document.getElementById('price-chart');
    if (oldCanvas) {
        oldCanvas.remove();
    }
    
    // Уничтожаем старый график если существует
    if (state.chart) {
        try {
            state.chart.destroy();
        } catch (e) {
            // Игнорируем ошибки при уничтожении
        }
        state.chart = null;
    }
    
    // Создаем новый canvas
    const canvas = document.createElement('canvas');
    canvas.id = 'price-chart';
    canvas.style.width = '100%';
    canvas.style.height = '100%';
    chartContainer.appendChild(canvas);
    
    // Убедимся что есть данные для текущей валюты
    const currency = state.currentCurrency;
    const now = Date.now();
    
    if (!state.priceHistory[currency] || state.priceHistory[currency].length === 0) {
        state.priceHistory[currency] = [];
        for (let i = 0; i < 50; i++) {
            const time = now - (50 - i) * 1000;
            const price = state.exchangeRates[currency] || 1;
            state.priceHistory[currency].push({ time, price });
        }
    }
    
    // Создаем график
    try {
        const ctx = canvas.getContext('2d');
        
        state.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: state.priceHistory[currency].slice(-50).map((_, i) => i + 'с'),
                datasets: [{
                    label: currency,
                    data: state.priceHistory[currency].slice(-50).map(p => p.price),
                    borderColor: '#C8FF00',
                    backgroundColor: 'rgba(200, 255, 0, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 0,
                    pointHoverRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { 
                        enabled: true, // Включаем tooltips
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: { 
                        display: true,
                        grid: { display: false },
                        ticks: { color: '#AAAAAA' }
                    },
                    y: { 
                        display: true,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { 
                            color: '#AAAAAA',
                            callback: function(value) {
                                return '$' + formatNumber(value, 2);
                            }
                        }
                    }
                },
                animation: false
            }
        });
        
        console.log('График создан для валюты:', currency);
    } catch (error) {
        console.error('Ошибка при создании графика:', error);
        state.chart = null;
    }
}

// Безопасное обновление графика
function updateChart() {
    // Если график не существует или уничтожается
    if (!state.chart || chartIsDestroying) {
        return;
    }
    
    // Проверяем, что canvas все еще существует
    if (!state.chart.canvas || !document.body.contains(state.chart.canvas)) {
        state.chart = null;
        return;
    }
    
    const currency = state.currentCurrency;
    
    if (!state.priceHistory[currency] || state.priceHistory[currency].length === 0) {
        return;
    }
    
    try {
        // Проверяем, что график все еще валиден
        if (state.chart && state.chart.data && state.chart.data.datasets) {
            state.chart.data.datasets[0].data = state.priceHistory[currency].map(p => p.price);
            state.chart.data.datasets[0].label = currency;
            state.chart.data.labels = state.priceHistory[currency].map((_, i) => i + 'с');
            
            // Обновляем без анимации
            state.chart.update('none');
        }
    } catch (error) {
        console.error('Безопасная ошибка при обновлении графика:', error);
        state.chart = null;
    }
}

// Безопасное уничтожение графика
function safeDestroyChart() {
    if (!state.chart) return;
    
    chartIsDestroying = true;
    
    try {
        const oldChart = state.chart;
        state.chart = null;
        
        setTimeout(() => {
            try {
                oldChart.destroy();
            } catch (e) {
                // Игнорируем ошибки при уничтожении
            }
            chartIsDestroying = false;
        }, 100);
    } catch (e) {
        console.log('Ошибка при подготовке к уничтожению:', e);
        chartIsDestroying = false;
    }
}

        // Инициализация вкладки "Игра"
// Инициализация вкладки "Игра" - ИСПРАВЛЕННАЯ ВЕРСИЯ
// Инициализация вкладки "Игра" - ИСПРАВЛЕННАЯ ВЕРСИЯ
// Инициализация вкладки "Игра" - БЕЗОПАСНАЯ ВЕРСИЯ
function initTradeTab() {
    console.log('Начинаем инициализацию вкладки "Игра"...');
    
    // Сбрасываем переменную
    currencyOptions = [];
    
    // Попытка найти элементы
    const options = document.querySelectorAll('.currency-option');
    console.log('Найдено элементов .currency-option:', options.length);
    
    if (options.length === 0) {
        console.warn('Элементы .currency-option не найдены, пробуем снова...');
        setTimeout(initTradeTab, 500);
        return;
    }
    
    // Копируем элементы в массив
    currencyOptions = Array.from(options);
    console.log('Скопировано в currencyOptions:', currencyOptions.length);
    
    // 1. Инициализируем активную валюту
    initializeCurrencySelector();
    
    // 2. Инициализируем кнопки торговли
    initializeTradeButtons();
    
    // 3. Инициализируем поле ввода ставки
    initializeBetInput();
    
    console.log('Вкладка "Игра" успешно инициализирована');
}

// Инициализация селектора валют
// В функции initializeCurrencySelector() добавьте проверку:
function initializeCurrencySelector() {
    if (!currencyOptions || currencyOptions.length === 0) {
        console.warn('currencyOptions пуст, пропускаем инициализацию селектора');
        return;
    }
    
    currencyOptions.forEach((option, index) => {
        const currency = option.getAttribute('data-currency');
        
        // Устанавливаем активный класс
        if (currency === state.currentCurrency) {
            option.classList.add('active');
        } else {
            option.classList.remove('active');
        }
        
        // Добавляем обработчик события
        option.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // БЛОКИРОВКА: если идет торговля, нельзя менять валюту
            if (state.isTrading) {
                showNotification('Нельзя менять валюту во время торговли!', 'warning');
                return;
            }
            
            const clickedCurrency = this.getAttribute('data-currency');
            
            if (state.currentCurrency !== clickedCurrency) {
                switchToCurrency(clickedCurrency);
            }
        });
    });
}
// Переключение валюты
// В функции switchToCurrency() добавьте вызов:
// В функции switchToCurrency() добавьте:
// Переключение валюты с проверкой
function switchToCurrency(newCurrency) {
    // Проверяем, не идет ли торговля
    if (state.isTrading) {
        showNotification('Завершите текущую торговлю перед сменой валюты!', 'warning');
        return;
    }
    
    console.log('Переключаем валюту с', state.currentCurrency, 'на', newCurrency);
    
    // Обновляем состояние
    state.currentCurrency = newCurrency;
    
    // Обновляем UI
    updateCurrencyUI();
    
    // Очищаем поле ввода
    const betAmountInput = document.getElementById('bet-amount');
    if (betAmountInput) {
        betAmountInput.value = '';
    }
    
    // Пересоздаем график
    recreateChart();
    
    // Обновляем максимальную ставку
    updateMaxBet();
    
    saveUserData();
}

// Обновление UI валюты
function updateCurrencyUI() {
    // Обновляем отображение текущей цены
    updateCurrentPrice();
    
    // Обновляем активные кнопки валют
    if (currencyOptions && currencyOptions.length > 0) {
        currencyOptions.forEach(option => {
            const currency = option.getAttribute('data-currency');
            if (currency === state.currentCurrency) {
                option.classList.add('active');
            } else {
                option.classList.remove('active');
            }
        });
    }
}

// Пересоздание графика
function recreateChart() {
    console.log('Пересоздаем график для валюты', state.currentCurrency);
    
    // Уничтожаем старый график
    if (state.chart) {
        try {
            state.chart.destroy();
        } catch (e) {
            console.log('Ошибка при уничтожении графика:', e);
        }
        state.chart = null;
    }
    
    // Создаем новый график
    setTimeout(() => {
        try {
            initChart();
        } catch (error) {
            console.error('Ошибка при создании графика:', error);
        }
    }, 200);
}

// Инициализация кнопок торговли
function initializeTradeButtons() {
    const btnUp = document.getElementById('btn-up');
    const btnDown = document.getElementById('btn-down');
    
    console.log('Кнопка UP найдена:', !!btnUp);
    console.log('Кнопка DOWN найдена:', !!btnDown);
    
    if (btnUp) {
        btnUp.addEventListener('click', function() {
            console.log('Нажата кнопка ВВЕРХ');
            if (!state.isTrading) {
                placeBet('up');
            } else {
                console.log('Торговля уже идет...');
            }
        });
    }
    
    if (btnDown) {
        btnDown.addEventListener('click', function() {
            console.log('Нажата кнопка ВНИЗ');
            if (!state.isTrading) {
                placeBet('down');
            } else {
                console.log('Торговля уже идет...');
            }
        });
    }
}

// Инициализация поля ввода ставки
// В функции initializeBetInput() добавьте:
// Инициализация поля ввода ставки - ПОЛНОСТЬЮ ПЕРЕПИСАНА
function initializeBetInput() {
    const betAmountInput = document.getElementById('bet-amount');
    
    if (!betAmountInput) {
        console.error('Поле ввода ставки не найдено!');
        return;
    }
    
    console.log('Инициализация поля ввода ставки');
    
    // 1. Полностью сбрасываем все атрибуты
    betAmountInput.removeAttribute('min');
    betAmountInput.removeAttribute('max');
    betAmountInput.removeAttribute('step');
    
    // 2. Устанавливаем базовые атрибуты
    betAmountInput.setAttribute('step', 'any'); // Любой шаг
    betAmountInput.value = ''; // Очищаем значение
    
    // 3. Обработчик ввода с динамической проверкой
    betAmountInput.addEventListener('input', function() {
        const value = this.value;
        console.log('Ввод ставки:', value);
        
        if (!value || value === '') {
            return;
        }
        
        const numValue = parseFloat(value);
        
        if (isNaN(numValue)) {
            this.value = '';
            return;
        }
        
        // Проверка минимума
        if (numValue < 0.001) {
            this.value = '0.001';
            return;
        }
        
        // Проверка максимума (динамическая)
        const currency = state.currentCurrency;
        const balance = parseFloat(state.balances[currency]) || 0;
        
        if (numValue > balance) {
            this.value = balance.toFixed(6);
            return;
        }
        
        // Ограничиваем 6 знаками после запятой
        const fixedValue = parseFloat(numValue.toFixed(6));
        if (numValue !== fixedValue) {
            this.value = fixedValue;
        }
    });
    
    // 4. Обработчик изменения (когда поле теряет фокус)
    betAmountInput.addEventListener('change', function() {
        console.log('Изменение ставки:', this.value);
        
        const value = this.value;
        if (!value) return;
        
        const numValue = parseFloat(value);
        
        if (isNaN(numValue)) {
            this.value = '';
            return;
        }
        
        // Принудительная проверка при потере фокуса
        if (numValue < 0.001) {
            this.value = '0.001';
        }
        
        const currency = state.currentCurrency;
        const balance = parseFloat(state.balances[currency]) || 0;
        
        if (numValue > balance) {
            this.value = balance.toFixed(6);
        }
    });
    
    // 5. Обработчик вставки
    betAmountInput.addEventListener('paste', function(e) {
        e.preventDefault();
        const pastedText = e.clipboardData.getData('text');
        const numValue = parseFloat(pastedText);
        
        if (!isNaN(numValue) && numValue >= 0.001) {
            this.value = numValue;
        }
    });
    
    // 6. Первоначальное обновление
    updateMaxBet();
}

// Обработчик смены валюты
function handleCurrencyChange(clickedElement) {
    // Снимаем выделение со всех валют
    if (currencyOptions) {
        currencyOptions.forEach(o => o.classList.remove('active'));
    }
    
    // Выделяем выбранную валюту
    clickedElement.classList.add('active');
    
    const newCurrency = clickedElement.getAttribute('data-currency');
    
    // Если валюта уже выбрана, ничего не делаем
    if (state.currentCurrency === newCurrency) return;
    
    state.currentCurrency = newCurrency;
    
    // Обновляем отображение текущей цены
    updateCurrentPrice();
    
    // Уничтожаем старый график
    if (state.chart) {
        try {
            state.chart.destroy();
        } catch (e) {
            // Игнорируем ошибки
        }
        state.chart = null;
    }
    
    // Создаем новый график для новой валюты
    setTimeout(() => {
        initChart();
    }, 150);
    
    updateMaxBet();
}

// Инициализация кнопок торговли
function initTradeButtons() {
    const btnUp = document.getElementById('btn-up');
    const btnDown = document.getElementById('btn-down');
    const betAmountInput = document.getElementById('bet-amount');
    
    if (btnUp) {
        btnUp.addEventListener('click', function() {
            if (!state.isTrading) {
                placeBet('up');
            }
        });
    }
    
    if (btnDown) {
        btnDown.addEventListener('click', function() {
            if (!state.isTrading) {
                placeBet('down');
            }
        });
    }
    
    if (betAmountInput) {
        betAmountInput.addEventListener('input', function() {
            updateMaxBet();
        });
    }
}
        // Инициализация вкладки "Кошельки"
        function initWalletsTab() {
            updateTransactionHistory();
        }

        // Инициализация вкладки "Конвертация"
        function initConversionTab() {
            document.getElementById('conversion-amount').addEventListener('input', updateConversionResult);
            document.getElementById('from-currency').addEventListener('change', updateConversionResult);
            document.getElementById('to-currency').addEventListener('change', updateConversionResult);
            document.getElementById('btn-convert').addEventListener('click', performConversion);
            updateConversionResult();
        }

        // Инициализация вкладки "NFT Маркет"
        function initNFTMarket() {
            updateNFTMarket();
        }

        // Инициализация вкладки "Инвентарь"
        function initInventory() {
            updateInventory();
        }

        // Инициализация вкладки "Ввод средств"
        function initDepositTab() {
            document.getElementById('card-number').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = '';
                
                for (let i = 0; i < value.length; i++) {
                    if (i > 0 && i % 4 === 0) {
                        formattedValue += ' ';
                    }
                    formattedValue += value[i];
                }
                
                e.target.value = formattedValue;
            });
            
            document.getElementById('card-expiry').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\//g, '').replace(/[^0-9]/gi, '');
                
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2);
                }
                
                e.target.value = value.substring(0, 5);
            });
            
            document.getElementById('card-cvc').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/gi, '').substring(0, 3);
            });
            
            document.getElementById('btn-deposit').addEventListener('click', performDeposit);
        }

        // Инициализация вкладки "Вывод средств"
        function initWithdrawTab() {
            document.getElementById('withdraw-card-number').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = '';
                
                for (let i = 0; i < value.length; i++) {
                    if (i > 0 && i % 4 === 0) {
                        formattedValue += ' ';
                    }
                    formattedValue += value[i];
                }
                
                e.target.value = formattedValue;
            });
            
            document.getElementById('btn-withdraw').addEventListener('click', performWithdrawal);
        }

        // Инициализация вкладки "Профиль"
        function initProfileTab() {
            document.getElementById('btn-logout').addEventListener('click', function() {
                state.user = null;
                state.isAdmin = false;
                localStorage.removeItem('cryptoExchangeUser');
                showAuth();
                showNotification('Вы вышли из аккаунта', 'info');
            });
            
            document.getElementById('btn-delete-account').addEventListener('click', function() {
                showConfirmModal(
                    'Вы уверены, что хотите удалить аккаунт? Все ваши данные будут безвозвратно удалены.',
                    function() {
                        if (state.user) {
                            localStorage.removeItem(`cryptoExchangeData_${state.user.username}`);
                            
                            const users = JSON.parse(localStorage.getItem('cryptoExchangeUsers') || '{}');
                            delete users[state.user.username];
                            localStorage.setItem('cryptoExchangeUsers', JSON.stringify(users));
                            
                            localStorage.removeItem('cryptoExchangeUser');
                            
                            state.user = null;
                            state.isAdmin = false;
                            showAuth();
                            showNotification('Аккаунт успешно удален', 'info');
                        }
                    }
                );
            });
        }

        // Обновление максимальной ставки
// Обновление максимальной ставки с проверками
// Обновление максимальной ставки - ВЕРНУЛ КАК БЫЛО
// Обновление максимальной ставки - ИСПРАВЛЕННАЯ ВЕРСИЯ
// Обновление максимальной ставки - УПРОЩЕННАЯ
function updateMaxBet() {
    const currency = state.currentCurrency;
    const balance = parseFloat(state.balances[currency]) || 0;
    
    const maxBetElement = document.getElementById('max-bet');
    if (maxBetElement) {
        maxBetElement.textContent = formatNumber(balance, 6);
    }
    
    console.log(`Максимальная ставка для ${currency}: ${balance}`);
}

        // Размещение ставки
// Размещение ставки - ВЕРНУЛ КАК БЫЛО
// Размещение ставки - С ДОПОЛНИТЕЛЬНОЙ ПРОВЕРКОЙ
// Размещение ставки - ПРОСТАЯ ПРОВЕРКА
// Размещение ставки - С БЛОКИРОВКОЙ СМЕНЫ ВАЛЮТЫ
function placeBet(direction) {
    const betAmountInput = document.getElementById('bet-amount');
    const value = betAmountInput.value;
    
    if (!value || value.trim() === '') {
        showNotification('Введите сумму ставки', 'error');
        betAmountInput.focus();
        return;
    }
    
    const amount = parseFloat(value);
    
    if (isNaN(amount) || amount <= 0) {
        showNotification('Введите корректную сумму ставки', 'error');
        betAmountInput.focus();
        return;
    }
    
    if (amount < 0.001) {
        showNotification('Минимальная ставка: 0.001', 'error');
        betAmountInput.value = '0.001';
        betAmountInput.focus();
        return;
    }
    
    const currency = state.currentCurrency;
    const balance = parseFloat(state.balances[currency]) || 0;
    
    if (amount > balance) {
        showNotification(`Недостаточно средств. Доступно: ${formatNumber(balance, 6)} ${currency}`, 'error');
        betAmountInput.value = balance.toFixed(6);
        betAmountInput.focus();
        return;
    }
    
    console.log(`Ставка размещена: ${amount} ${currency}, направление: ${direction}`);
    
    // 1. Начинаем торговлю
    state.isTrading = true;
    state.betAmount = amount;
    state.betDirection = direction;
    state.betCurrency = currency; // ЗАПОМИНАЕМ ВАЛЮТУ СТАВКИ
    
    // 2. Блокируем элементы
    document.getElementById('btn-up').disabled = true;
    document.getElementById('btn-down').disabled = true;
    betAmountInput.disabled = true;
    
    // 3. Блокируем смену валют
    blockCurrencySwitching(true);
    
    startCountdown();
}

        // Запуск обратного отсчета
// Запуск обратного отсчета с защитой
function startCountdown() {
    let countdown = 5;
    const timerElement = document.getElementById('timer');
    
    if (!timerElement) {
        console.error('Элемент timer не найден');
        resetTradingState();
        return;
    }
    
    timerElement.style.display = 'block';
    timerElement.textContent = countdown;
    
    const countdownInterval = setInterval(() => {
        countdown--;
        timerElement.textContent = countdown;
        
        if (countdown <= 0) {
            clearInterval(countdownInterval);
            determineBetResult();
        }
        
        // Дополнительная проверка: если валюта изменилась во время отсчета
        if (state.betCurrency && state.currentCurrency !== state.betCurrency) {
            console.warn('Валюта изменилась во время торговли! Возвращаем обратно...');
            // Возвращаем исходную валюту
            switchToCurrency(state.betCurrency);
        }
    }, 1000);
}

        // Определение результата ставки
// Определение результата ставки - ИСПРАВЛЕННАЯ
function determineBetResult() {
    let winChance = 0.45;
    
    if (systemSettings.doubleLuckMode) {
        winChance = 0.9;
    }
    
    const isWin = Math.random() < winChance;
    
    const resultElement = document.getElementById('bet-result');
    resultElement.className = 'result';
    
    // ИСПОЛЬЗУЕМ ЗАПОМНЕННУЮ ВАЛЮТУ, А НЕ ТЕКУЩУЮ
    const betCurrency = state.betCurrency || state.currentCurrency;
    const betAmount = state.betAmount;
    
    if (isWin) {
        state.balances[betCurrency] += betAmount;
        resultElement.classList.add('success');
        resultElement.textContent = `Поздравляем! Вы выиграли ${formatNumber(betAmount, 6)} ${betCurrency}`;
        
        state.userStats.totalWins++;
        
        addTransaction('win', betCurrency, betAmount);
    } else {
        state.balances[betCurrency] -= betAmount;
        resultElement.classList.add('failure');
        resultElement.textContent = `К сожалению, вы проиграли ${formatNumber(betAmount, 6)} ${betCurrency}`;
        
        state.userStats.totalLosses++;
        
        addTransaction('loss', betCurrency, -betAmount);
    }
    
    saveUserData();
    
    setTimeout(() => {
        resetTradingState();
    }, 3000);
}

        // Сброс состояния торговли
// Сброс состояния торговли
function resetTradingState() {
    // Разблокируем смену валют
    blockCurrencySwitching(false);
    
    // Сбрасываем состояние
    state.isTrading = false;
    state.betAmount = 0;
    state.betDirection = null;
    state.betCurrency = null;
    
    // Разблокируем элементы
    document.getElementById('btn-up').disabled = false;
    document.getElementById('btn-down').disabled = false;
    
    const betAmountInput = document.getElementById('bet-amount');
    if (betAmountInput) {
        betAmountInput.disabled = false;
        betAmountInput.value = '';
    }
    
    document.getElementById('timer').style.display = 'none';
    document.getElementById('bet-result').className = 'result';
    
    updateUI();
}

        // Обновление результата конвертации
        function updateConversionResult() {
            const fromCurrency = document.getElementById('from-currency').value;
            const toCurrency = document.getElementById('to-currency').value;
            const amount = parseFloat(document.getElementById('conversion-amount').value) || 0;
            
            if (fromCurrency === toCurrency) {
                document.getElementById('conversion-result').value = formatNumber(amount);
                document.getElementById('conversion-rate').textContent = `1 ${fromCurrency} = 1 ${toCurrency}`;
                document.getElementById('conversion-fee').textContent = '0';
                return;
            }
            
            if (fromCurrency === 'STARS' && toCurrency !== 'RUB') {
                document.getElementById('conversion-result').value = 'Невозможно';
                document.getElementById('conversion-rate').textContent = 'STARS можно конвертировать только в RUB';
                document.getElementById('conversion-fee').textContent = '0';
                return;
            }
            
            if (toCurrency === 'STARS' && fromCurrency === 'RUB') {
                document.getElementById('conversion-result').value = 'Невозможно';
                document.getElementById('conversion-rate').textContent = 'RUB нельзя конвертировать в STARS';
                document.getElementById('conversion-fee').textContent = '0';
                return;
            }
            
            if (fromCurrency === 'CAT' && toCurrency !== 'TON') {
                document.getElementById('conversion-result').value = 'Невозможно';
                document.getElementById('conversion-rate').textContent = 'CAT можно конвертировать только в TON';
                document.getElementById('conversion-fee').textContent = '0';
                return;
            }
            
            if (toCurrency === 'CAT' && fromCurrency !== 'TON') {
                document.getElementById('conversion-result').value = 'Невозможно';
                document.getElementById('conversion-rate').textContent = 'В CAT можно конвертировать только из TON';
                document.getElementById('conversion-fee').textContent = '0';
                return;
            }
            
            if ((fromCurrency === 'CAT' || toCurrency === 'CAT') && !systemSettings.catcoinListed) {
                document.getElementById('conversion-result').value = 'Невозможно';
                document.getElementById('conversion-rate').textContent = 'Catcoin не в листинге';
                document.getElementById('conversion-fee').textContent = '0';
                return;
            }
            
            let rate;
            if (fromCurrency === 'RUB') {
                rate = 1 / state.exchangeRates[toCurrency];
            } else if (toCurrency === 'RUB') {
                rate = state.exchangeRates[fromCurrency];
            } else if (toCurrency === 'STARS') {
                rate = state.exchangeRates[fromCurrency] / state.exchangeRates.STARS;
            } else if (fromCurrency === 'STARS') {
                rate = state.exchangeRates.STARS / state.exchangeRates[toCurrency];
            } else if (toCurrency === 'CAT') {
                rate = state.exchangeRates[fromCurrency] / state.exchangeRates.CAT;
            } else if (fromCurrency === 'CAT') {
                rate = state.exchangeRates.CAT / state.exchangeRates[toCurrency];
            } else {
                rate = state.exchangeRates[fromCurrency] / state.exchangeRates[toCurrency];
            }
            
            const fee = amount * 0.02;
            const amountAfterFee = amount - fee;
            let result = amountAfterFee * rate;
            
            if (toCurrency === 'STARS' || toCurrency === 'CAT') {
                result = Math.floor(result);
            }
            
            document.getElementById('conversion-result').value = toCurrency === 'STARS' || toCurrency === 'CAT' ? Math.floor(result) + ' ' + toCurrency : formatNumber(result, 6);
            
            if (fromCurrency === 'RUB') {
                document.getElementById('conversion-rate').textContent = `1 ${toCurrency} = ${formatNumber(1/rate)} ${fromCurrency}`;
            } else if (toCurrency === 'RUB') {
                document.getElementById('conversion-rate').textContent = `1 ${fromCurrency} = ${formatNumber(rate)} ${toCurrency}`;
            } else if (toCurrency === 'STARS' || toCurrency === 'CAT') {
                document.getElementById('conversion-rate').textContent = `1 ${fromCurrency} = ${formatNumber(rate)} ${toCurrency}`;
            } else if (fromCurrency === 'STARS' || fromCurrency === 'CAT') {
                document.getElementById('conversion-rate').textContent = `1 ${fromCurrency} = ${formatNumber(rate, 6)} ${toCurrency}`;
            } else {
                document.getElementById('conversion-rate').textContent = `1 ${fromCurrency} = ${formatNumber(rate, 6)} ${toCurrency}`;
            }
            
            document.getElementById('conversion-fee').textContent = formatNumber(fee, 6) + ' ' + fromCurrency;
        }

        // Выполнение конвертации
// Замените функцию performConversion() на эту исправленную версию:

// Выполнение конвертации
// Выполнение конвертации - ИСПРАВЛЕНА ОШИБКА С ОКРУГЛЕНИЕМ
// Выполнение конвертации - ИСПРАВЛЕННАЯ ВЕРСИЯ С ТОЧНОЙ АРИФМЕТИКОЙ

// Точная функция для вычитания
function preciseSubtract(a, b) {
    const multiplier = Math.pow(10, 8);
    const result = (a * multiplier - b * multiplier) / multiplier;
    return parseFloat(result.toFixed(8));
}

// Точная функция для сложения
function preciseAdd(a, b) {
    const multiplier = Math.pow(10, 8);
    const result = (a * multiplier + b * multiplier) / multiplier;
    return parseFloat(result.toFixed(8));
}

// Точная функция для умножения
function preciseMultiply(a, b) {
    const multiplier = Math.pow(10, 8);
    const result = (a * multiplier) * (b * multiplier) / (multiplier * multiplier);
    return parseFloat(result.toFixed(8));
}

// Выполнение конвертации - ИСПРАВЛЕННАЯ ВЕРСИЯ
function performConversion() {
    const fromCurrency = document.getElementById('from-currency').value;
    const toCurrency = document.getElementById('to-currency').value;
    let amount = document.getElementById('conversion-amount').value;
    
    console.log('Начало конвертации:', { fromCurrency, toCurrency, amount });
    
    // ===== 1. ВАЛИДАЦИЯ ВХОДНЫХ ДАННЫХ =====
    amount = parseFloat(amount.replace(',', '.'));
    
    if (isNaN(amount) || amount <= 0) {
        showNotification('Введите корректную сумму для конвертации', 'error');
        return;
    }
    
    // Для STARS и CAT - только целые числа
    if (fromCurrency === 'STARS' || fromCurrency === 'CAT') {
        amount = Math.floor(amount);
        if (amount <= 0) {
            showNotification('Для STARS и CAT только целые числа', 'error');
            return;
        }
    }
    
    // Фиксируем сумму для избежания погрешности
    const amountFixed = parseFloat(amount.toFixed(8));
    
    // ===== 2. ПРОВЕРКА БАЛАНСА С ЗАПАСОМ =====
    const currentBalance = parseFloat(state.balances[fromCurrency].toFixed(8));
    
    if (amountFixed > currentBalance + 0.000001) {
        showNotification(`Недостаточно средств. Доступно: ${formatNumber(currentBalance, 8)} ${fromCurrency}`, 'error');
        return;
    }
    
    // ===== 3. ПРОВЕРКА ОСОБЫХ ПРАВИЛ =====
    if (fromCurrency === 'STARS' && toCurrency !== 'RUB') {
        showNotification('STARS можно конвертировать только в RUB', 'error');
        return;
    }
    
    if (toCurrency === 'STARS' && fromCurrency === 'RUB') {
        showNotification('RUB нельзя конвертировать в STARS', 'error');
        return;
    }
    
    if (fromCurrency === 'CAT' && toCurrency !== 'TON') {
        showNotification('CAT можно конвертировать только в TON', 'error');
        return;
    }
    
    if (toCurrency === 'CAT' && fromCurrency !== 'TON') {
        showNotification('В CAT можно конвертировать только из TON', 'error');
        return;
    }
    
    if ((fromCurrency === 'CAT' || toCurrency === 'CAT') && !systemSettings.catcoinListed) {
        showNotification('Catcoin не в листинге. Конвертация недоступна.', 'error');
        return;
    }
    
    // ===== 4. РАСЧЕТ КУРСА И РЕЗУЛЬТАТА =====
    let rate = 1;
    
    if (fromCurrency === 'RUB') {
        rate = 1 / state.exchangeRates[toCurrency];
    } else if (toCurrency === 'RUB') {
        rate = state.exchangeRates[fromCurrency];
    } else if (toCurrency === 'STARS') {
        rate = state.exchangeRates[fromCurrency] / state.exchangeRates.STARS;
    } else if (fromCurrency === 'STARS') {
        rate = state.exchangeRates.STARS / state.exchangeRates[toCurrency];
    } else if (toCurrency === 'CAT') {
        rate = state.exchangeRates[fromCurrency] / state.exchangeRates.CAT;
    } else if (fromCurrency === 'CAT') {
        rate = state.exchangeRates.CAT / state.exchangeRates[toCurrency];
    } else {
        rate = state.exchangeRates[fromCurrency] / state.exchangeRates[toCurrency];
    }
    
    // Расчет комиссии (2%) с округлением до 8 знаков
    const fee = parseFloat((amountFixed * 0.02).toFixed(8));
    const amountAfterFee = parseFloat((amountFixed - fee).toFixed(8));
    let result = parseFloat((amountAfterFee * rate).toFixed(8));
    
    // Для STARS и CAT округляем до целого числа вниз
    if (toCurrency === 'STARS' || toCurrency === 'CAT') {
        result = Math.floor(result);
        if (result <= 0) {
            showNotification('Результат конвертации слишком мал', 'error');
            return;
        }
    }
    
    // ===== 5. ФИНАЛЬНАЯ ПРОВЕРКА БАЛАНСА =====
    // Округляем до 8 знаков для точного сравнения
    const finalAmount = parseFloat(amountFixed.toFixed(8));
    const finalBalance = parseFloat(state.balances[fromCurrency].toFixed(8));
    
    if (finalAmount > finalBalance) {
        showNotification(`Недостаточно средств. Финальная проверка: ${formatNumber(finalBalance, 8)} ${fromCurrency}`, 'error');
        return;
    }
    
    console.log('Расчет конвертации:', {
        amount: finalAmount,
        fee,
        amountAfterFee,
        rate,
        result,
        fromBalance: state.balances[fromCurrency],
        toBalance: state.balances[toCurrency]
    });
    
    // ===== 6. ПОДТВЕРЖДЕНИЕ ОПЕРАЦИИ =====
    const confirmMessage = `Вы уверены, что хотите конвертировать ${fromCurrency === 'STARS' || fromCurrency === 'CAT' ? Math.floor(amountFixed) : formatNumber(amountFixed, 6)} ${fromCurrency} в ${toCurrency === 'STARS' || toCurrency === 'CAT' ? Math.floor(result) : formatNumber(result, 6)} ${toCurrency}? Комиссия: ${formatNumber(fee, 6)} ${fromCurrency}`;
    
    showConfirmModal(confirmMessage, () => {
        console.log('Начинаем выполнение конвертации...');
        
        // ===== 7. ВЫПОЛНЕНИЕ КОНВЕРТАЦИИ С ТОЧНОЙ АРИФМЕТИКОЙ =====
        try {
            // 7.1. Вычитаем сумму с использованием защищенной функции
            const oldFromBalance = parseFloat(state.balances[fromCurrency].toFixed(8));
            const newFromBalance = safeSubtract(oldFromBalance, finalAmount);
            
            // Проверяем, что операция прошла успешно
            if (newFromBalance === oldFromBalance) {
                showNotification('Ошибка при списании средств', 'error');
                return;
            }
            
            state.balances[fromCurrency] = Math.max(0, newFromBalance);
            
            console.log('Вычитание завершено:', {
                old: oldFromBalance,
                amount: finalAmount,
                new: state.balances[fromCurrency]
            });
            
            // 7.2. Добавляем результат с использованием защищенной функции
            const oldToBalance = parseFloat(state.balances[toCurrency].toFixed(8));
            const newToBalance = safeAdd(oldToBalance, result);
            
            state.balances[toCurrency] = newToBalance;
            
            console.log('Добавление завершено:', {
                old: oldToBalance,
                result: result,
                new: state.balances[toCurrency]
            });
            
            // 7.3. Обработка комиссии
            if (state.isAdmin) {
                // Администратору комиссия возвращается
                state.balances[fromCurrency] = safeAdd(state.balances[fromCurrency], fee);
            } else {
                // Обычному пользователю комиссия уходит администратору
                const commissionInRub = parseFloat((fee * (state.exchangeRates[fromCurrency] || 1)).toFixed(2));
                systemSettings.adminCommission = parseFloat((systemSettings.adminCommission + commissionInRub).toFixed(2));
                saveSystemSettings();
            }
            
            // 7.4. Добавляем в историю
            addTransaction('conversion', `${fromCurrency}→${toCurrency}`, -finalAmount, result);
            
            // 7.5. Сохраняем данные
            saveUserData();
            
            // 7.6. Обновляем UI
            updateUI();
            
            // 7.7. Сбрасываем форму
            document.getElementById('conversion-amount').value = '';
            updateConversionResult();
            
            // 7.8. Показываем уведомление
            const successMessage = `Успешно конвертировано ${formatNumber(finalAmount, 6)} ${fromCurrency} в ${formatNumber(result, 6)} ${toCurrency}`;
            showNotification(successMessage, 'success');
            
            console.log('Конвертация успешно завершена');
            
        } catch (error) {
            console.error('Критическая ошибка при конвертации:', error);
            showNotification('Произошла ошибка при конвертации. Операция отменена.', 'error');
        }
    });
}

        // Пополнение счета
        function performDeposit() {
            const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
            const cardExpiry = document.getElementById('card-expiry').value;
            const cardCvc = document.getElementById('card-cvc').value;
            const amount = parseInt(document.getElementById('deposit-amount').value);
            
            if (cardNumber.length !== 16) {
                showNotification('Введите корректный номер карты', 'error');
                return;
            }
            
            if (!/^\d{2}\/\d{2}$/.test(cardExpiry)) {
                showNotification('Введите корректный срок действия карты', 'error');
                return;
            }
            
            if (cardCvc.length !== 3) {
                showNotification('Введите корректный CVC/CVV код', 'error');
                return;
            }
            
            if (!amount || amount <= 0) {
                showNotification('Введите корректную сумму пополнения', 'error');
                return;
            }
            
            if (amount > 9000000) {
                showNotification('Максимальная сумма пополнения: 70,000 ₽', 'error');
                return;
            }
            
            const cardExists = state.bank.cards.some(card => 
                card.number.replace(/\s/g, '') === cardNumber &&
                card.expiry === cardExpiry &&
                card.cvv === cardCvc
            );
            
            if (!cardExists) {
                showNotification('Карта не найдена в вашем банке или данные неверны', 'error');
                return;
            }
            
            if (amount > state.bank.balance) {
                showNotification('Недостаточно средств на банковском счете', 'error');
                return;
            }
            
            showConfirmModal(
                `Вы уверены, что хотите пополнить счет на ${formatNumber(amount)} ₽ с банковской карты?`,
                () => {
                    state.balances.RUB += amount;
                    state.bank.balance -= amount;
                    
                    addTransaction('deposit', 'RUB', amount);
                    
                    saveUserData();
                    
                    updateUI();
                    
                    document.getElementById('card-number').value = '';
                    document.getElementById('card-expiry').value = '';
                    document.getElementById('card-cvc').value = '';
                    document.getElementById('deposit-amount').value = '';
                    
                    showNotification('Счет успешно пополнен с банковской карты!', 'success');
                }
            );
        }

        // Вывод средств
        function performWithdrawal() {
            const cardNumber = document.getElementById('withdraw-card-number').value.replace(/\s/g, '');
            const amount = parseInt(document.getElementById('withdraw-amount').value);
            
            if (cardNumber.length !== 16) {
                showNotification('Введите корректный номер карты', 'error');
                return;
            }
            
            if (!amount || amount <= 0) {
                showNotification('Введите корректную сумму вывода', 'error');
                return;
            }
            
            if (amount > state.balances.RUB) {
                showNotification('Недостаточно средств для вывода', 'error');
                return;
            }
            
            const cardExists = state.bank.cards.some(card => 
                card.number.replace(/\s/g, '') === cardNumber
            );
            
            if (!cardExists) {
                showNotification('Карта не найдена в вашем банке', 'error');
                return;
            }
            
            showConfirmModal(
                `Вы уверены, что хотите вывести ${formatNumber(amount)} ₽ на банковскую карту?`,
                () => {
                    state.balances.RUB -= amount;
                    state.bank.balance += amount;
                    
                    addTransaction('withdrawal', 'RUB', -amount);
                    
                    saveUserData();
                    
                    updateUI();
                    
                    document.getElementById('withdraw-card-number').value = '';
                    document.getElementById('withdraw-amount').value = '';
                    
                    showNotification('Средства успешно выведены на банковскую карту!', 'success');
                }
            );
        }

        // Обновление NFT маркета
        function updateNFTMarket() {
            const grid = document.getElementById('nft-market-grid');
            grid.innerHTML = '';
            
            state.nfts.forEach(nft => {
                const card = document.createElement('div');
                card.className = 'nft-card';
                card.innerHTML = `
                    <div class="nft-image">${nft.emoji}</div>
                    <div class="nft-name">${nft.name}</div>
                    <div class="nft-price">${formatNumber(nft.price)} STARS</div>
                    <div class="nft-count">В инвентаре: ${nft.owned}/5</div>
                    <button class="btn btn-block ${nft.owned >= 5 ? 'btn-outline' : ''}" 
                            data-nft-id="${nft.id}" 
                            ${nft.owned >= 5 ? 'disabled' : ''}>
                        ${nft.owned >= 5 ? 'Максимум куплено' : 'Купить'}
                    </button>
                `;
                grid.appendChild(card);
            });
            
            document.querySelectorAll('#nft-market-grid .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const nftId = parseInt(this.getAttribute('data-nft-id'));
                    buyNFT(nftId);
                });
            });
        }

        // Обновление инвентаря
        function updateInventory() {
            const grid = document.getElementById('inventory-grid');
            grid.innerHTML = '';
            
            const ownedNFTs = state.nfts.filter(nft => nft.owned > 0);
            
            if (ownedNFTs.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #AAAAAA; grid-column: 1 / -1;">У вас пока нет NFT</div>';
                return;
            }
            
            ownedNFTs.forEach(nft => {
                const card = document.createElement('div');
                card.className = 'nft-card';
                
                let nftContent = '';
                if (nft.upgraded && nft.upgraded.length > 0) {
                    const upgrade = nft.upgraded[0];
                    card.classList.add(upgrade.colorClass);
                    nftContent = `
                        <div class="nft-image">${nft.emoji}</div>
                        <div class="nft-name">${nft.name} <span class="nft-upgrade-indicator upgrade-${upgrade.rarity}">${upgrade.rarity.toUpperCase()}</span></div>
                        <div class="nft-price">Фикс. цена: ${formatNumber(upgrade.price)} STARS</div>
                        <div class="nft-count">Улучшено: ${nft.upgraded.length}/${nft.owned}</div>
                        <button class="btn btn-outline btn-block" data-nft-id="${nft.id}">
                            Продать за ${formatNumber(Math.floor(upgrade.price * 0.8))} STARS
                        </button>
                    `;
                } else {
                    nftContent = `
                        <div class="nft-image">${nft.emoji}</div>
                        <div class="nft-name">${nft.name}</div>
                        <div class="nft-price">Текущая цена: ${formatNumber(nft.price)} STARS</div>
                        <div class="nft-count">Количество: ${nft.owned}</div>
                        <button class="btn btn-outline btn-block" data-nft-id="${nft.id}">
                            Продать за ${formatNumber(Math.floor(nft.price * 0.8))} STARS
                        </button>
                    `;
                }
                
                card.innerHTML = nftContent;
                grid.appendChild(card);
            });
            
            document.querySelectorAll('#inventory-grid .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const nftId = parseInt(this.getAttribute('data-nft-id'));
                    sellNFT(nftId);
                });
            });
        }

        // Покупка NFT
        function buyNFT(nftId) {
            const nft = state.nfts.find(n => n.id === nftId);
            
            if (!nft) return;
            
            if (nft.owned >= 5) {
                showNotification('Максимальное количество этого NFT уже куплено', 'error');
                return;
            }
            
            if (state.balances.STARS < nft.price) {
                showNotification('Недостаточно STARS для покупки', 'error');
                return;
            }
            
            showConfirmModal(
                `Вы уверены, что хотите купить NFT "${nft.name}" за ${formatNumber(nft.price)} STARS?`,
                () => {
                    state.balances.STARS -= nft.price;
                    nft.owned++;
                    
                    addTransaction('nft_buy', `NFT ${nft.name}`, -nft.price, null, 'STARS');
                    
                    saveUserData();
                    
                    updateUI();
                    
                    showNotification(`NFT "${nft.name}" успешно куплен!`, 'success');
                }
            );
        }

        // Продажа NFT
        function sellNFT(nftId) {
            const nft = state.nfts.find(n => n.id === nftId);
            
            if (!nft || nft.owned <= 0) return;
            
            let sellPrice;
            let nftToSell = null;
            
            if (nft.upgraded && nft.upgraded.length > 0) {
                nftToSell = nft.upgraded[nft.upgraded.length - 1];
                sellPrice = Math.floor(nftToSell.price * 0.8);
            } else {
                sellPrice = Math.floor(nft.price * 0.8);
            }
            
            showConfirmModal(
                `Вы уверены, что хотите продать NFT "${nft.name}" за ${formatNumber(sellPrice)} STARS?`,
                () => {
                    nft.owned--;
                    
                    if (nftToSell) {
                        nft.upgraded.pop();
                    }
                    
                    state.balances.STARS += sellPrice;
                    
                    const description = nftToSell ? 
                        `NFT ${nft.name} (${nftToSell.color})` : 
                        `NFT ${nft.name}`;
                    
                    addTransaction('nft_sell', description, sellPrice, null, 'STARS');
                    
                    saveUserData();
                    
                    updateUI();
                    
                    showNotification(`NFT "${nft.name}" успешно продан!`, 'success');
                },
                () => {
                    console.log('Продажа NFT отменена');
                }
            );
        }

        // Обновление графика
// Обновление графика
// Обновление графика
// Обновление графика - ИСПРАВЛЕННАЯ ВЕРСИЯ
function updateChart() {
    // Проверяем, существует ли график
    if (!state.chart || !state.chart.canvas) {
        return;
    }
    
    const currency = state.currentCurrency;
    
    // Проверяем, есть ли данные
    if (!state.priceHistory[currency] || state.priceHistory[currency].length === 0) {
        return;
    }
    
    // Берем только последние 50 точек
    const dataPoints = state.priceHistory[currency].slice(-50);
    
    try {
        // Обновляем данные
        state.chart.data.labels = dataPoints.map((_, i) => i + 'с');
        state.chart.data.datasets[0].data = dataPoints.map(p => p.price);
        state.chart.data.datasets[0].label = currency;
        
        // Безопасное обновление
        state.chart.update('none');
    } catch (error) {
        // Если ошибка, пересоздаем график
        console.log('Ошибка обновления графика, пересоздаем:', error);
        initChart();
    }
}

        // Запуск симуляции изменения цен
// Запуск симуляции изменения цен - ИСПРАВЛЕННАЯ ВЕРСИЯ
function startPriceSimulation() {
    setInterval(() => {
        // 1. Обновляем курсы всех валют
        for (const currency in state.exchangeRates) {
            if (currency === 'CAT') continue;
            
            // Генерируем случайное изменение от -0.5% до +0.5%
            const change = (Math.random() - 0.5) * 0.01;
            state.exchangeRates[currency] *= (1 + change);
            
            // Добавляем точку в историю
            const now = Date.now();
            state.priceHistory[currency].push({
                time: now,
                price: state.exchangeRates[currency]
            });
            
            // Ограничиваем историю 50 точками
            if (state.priceHistory[currency].length > 50) {
                state.priceHistory[currency].shift();
            }
        }
        
        // 2. Обновляем текущую цену в верхней панели
        updateCurrentPrice();
        
        // 3. ВАЖНОЕ ИСПРАВЛЕНИЕ: Обновляем график если открыта вкладка trade
        const tradeTab = document.getElementById('trade');
        if (tradeTab && tradeTab.classList.contains('active')) {
            // Проверяем, существует ли график
            if (state.chart && typeof state.chart.update === 'function') {
                try {
                    updateChart();
                } catch (e) {
                    console.log('Ошибка обновления графика, пересоздаем...');
                    initChart();
                }
            } else {
                // Если графика нет, создаем его
                initChart();
            }
        }
        
        // 4. Обновляем балансы в долларах
        updateDollarBalances();
        
    }, 1000); // Обновляем каждую секунду
}

// Функция обновления балансов в долларах
function updateDollarBalances() {
    // BTC
    const btcValue = state.balances.BTC * state.exchangeRates.BTC;
    document.getElementById('btc-value').textContent = '$' + formatNumber(btcValue, 2);
    
    // ETH
    const ethValue = state.balances.ETH * state.exchangeRates.ETH;
    document.getElementById('eth-value').textContent = '$' + formatNumber(ethValue, 2);
    
    // TON
    const tonValue = state.balances.TON * state.exchangeRates.TON;
    document.getElementById('ton-value').textContent = '$' + formatNumber(tonValue, 2);
    
    // STARS
    const starsValue = Math.floor(state.balances.STARS) * state.exchangeRates.STARS;
    document.getElementById('stars-value').textContent = formatNumber(starsValue) + ' ₽';
}

// Также обновите функцию обновления графика при смене валюты:
// В обработчике клика по валютам в initTradeTab():
currencyOptions.forEach(option => {
    option.addEventListener('click', function() {
        currencyOptions.forEach(o => o.classList.remove('active'));
        this.classList.add('active');
        state.currentCurrency = this.getAttribute('data-currency');
        
        // Обновляем отображение текущей цены
        updateCurrentPrice();
        
        // Пересоздаем график для новой валюты
        if (state.chart) {
            try {
                state.chart.destroy();
            } catch (e) {
                // Игнорируем ошибки
            }
            state.chart = null;
        }
        
        // Создаем новый график
        setTimeout(() => {
            initChart();
        }, 100);
        
        updateMaxBet();
    });
});

        // Запуск изменения цен NFT
        function startNFTPriceSimulation() {
            setInterval(() => {
                state.nfts.forEach(nft => {
                    if (nft.upgraded && nft.upgraded.length > 0) {
                        return;
                    }
                    
                    const change = (Math.random() * 0.35) - 0.15;
                    nft.price = Math.max(300, nft.price * (1 + change));
                });
                
                updateUI();
                
                console.log('Цены NFT обновлены');
            }, 60000);
        }

        // Показать уведомление
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Показать модальное окно подтверждения
        function showConfirmModal(message, onConfirm, onCancel = null) {
            const modal = document.getElementById('confirm-modal');
            const messageElement = document.getElementById('confirm-message');
            const cancelButton = document.getElementById('confirm-cancel');
            const okButton = document.getElementById('confirm-ok');
            const closeButton = document.querySelector('.close-modal');
            
            messageElement.textContent = message;
            modal.style.display = 'flex';
            
            const oldCancelHandler = cancelButton.onclick;
            const oldOkHandler = okButton.onclick;
            const oldCloseHandler = closeButton.onclick;
            
            if (oldCancelHandler) cancelButton.removeEventListener('click', oldCancelHandler);
            if (oldOkHandler) okButton.removeEventListener('click', oldOkHandler);
            if (oldCloseHandler) closeButton.removeEventListener('click', oldCloseHandler);
            
            const closeModal = function() {
                modal.style.display = 'none';
            };
            
            const confirmHandler = function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (onConfirm && typeof onConfirm === 'function') {
                    onConfirm();
                }
                closeModal();
                return false;
            };
            
            const cancelHandler = function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (onCancel && typeof onCancel === 'function') {
                    onCancel();
                }
                closeModal();
                return false;
            };
            
            const outsideClick = function(e) {
                if (e.target === modal) {
                    if (onCancel && typeof onCancel === 'function') {
                        onCancel();
                    }
                    closeModal();
                }
            };
            
            cancelButton.addEventListener('click', cancelHandler, { once: true });
            okButton.addEventListener('click', confirmHandler, { once: true });
            closeButton.addEventListener('click', cancelHandler, { once: true });
            window.addEventListener('click', outsideClick, { once: true });
            
            const escapeHandler = function(e) {
                if (e.key === 'Escape') {
                    if (onCancel && typeof onCancel === 'function') {
                        onCancel();
                    }
                    closeModal();
                    window.removeEventListener('keydown', escapeHandler);
                }
            };
            
            window.addEventListener('keydown', escapeHandler);
            
            cancelButton._confirmHandler = cancelHandler;
            okButton._confirmHandler = confirmHandler;
            closeButton._confirmHandler = cancelHandler;
            window._outsideClickHandler = outsideClick;
            window._escapeHandler = escapeHandler;
        }

        // Форматирование чисел
// Форматирование чисел с исправлением
// Форматирование чисел с безопасным округлением
function formatNumber(num, decimals = 2) {
    if (isNaN(num) || !isFinite(num)) return '0';
    
    // Округляем и обрезаем до нужного количества знаков
    const factor = Math.pow(10, decimals);
    const rounded = Math.round(num * factor) / factor;
    
    // Гарантируем, что число не отрицательное
    const safeNumber = Math.max(0, rounded);
    
    return safeNumber.toLocaleString('ru-RU', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
}
        // Обновление профиля
        function updateProfile() {
            if (state.user) {
                document.getElementById('profile-username').textContent = state.user.username;
                document.getElementById('profile-created').textContent = state.user.created;
                document.getElementById('profile-avatar').textContent = state.user.username.charAt(0).toUpperCase();
                
                if (state.isAdmin) {
                    const usernameElement = document.getElementById('profile-username');
                    if (!usernameElement.querySelector('.admin-badge')) {
                        const badge = document.createElement('span');
                        badge.className = 'admin-badge';
                        badge.textContent = 'ADMIN';
                        usernameElement.appendChild(badge);
                    }
                }
            }
        }

        // Обновление админ панели
        function updateAdminPanel() {
            if (state.isAdmin) {
                const luckStatus = document.getElementById('double-luck-status');
                const luckModeStatus = document.getElementById('luck-mode-status');
                
                if (systemSettings.doubleLuckMode) {
                    luckStatus.textContent = 'АКТИВЕН';
                    luckStatus.style.color = 'var(--success)';
                    luckModeStatus.textContent = '2x УДАЧА';
                    luckModeStatus.style.color = 'var(--success)';
                } else {
                    luckStatus.textContent = 'НЕАКТИВЕН';
                    luckStatus.style.color = 'var(--danger)';
                    luckModeStatus.textContent = 'НОРМАЛЬНЫЙ';
                    luckModeStatus.style.color = 'var(--text-gray)';
                }
                
                const catcoinStatus = document.getElementById('catcoin-listing-status');
                if (systemSettings.catcoinListed) {
                    catcoinStatus.textContent = 'В ЛИСТИНГЕ';
                    catcoinStatus.style.color = 'var(--success)';
                } else {
                    catcoinStatus.textContent = 'НЕ В ЛИСТИНГЕ';
                    catcoinStatus.style.color = 'var(--danger)';
                }
                
                const users = JSON.parse(localStorage.getItem('cryptoExchangeUsers') || '{}');
                document.getElementById('total-users').textContent = Object.keys(users).length;
                document.getElementById('active-sessions').textContent = '1';
                
                document.getElementById('admin-commission-balance').textContent = formatNumber(systemSettings.adminCommission) + ' ₽';
            }
        }
        // Функция для безопасного вычитания с плавающими числами
// Защищенная функция для вычитания с проверкой
function safeSubtract(balance, amount) {
    // Округляем до 8 знаков для избежания погрешности
    const balanceFixed = parseFloat(balance.toFixed(8));
    const amountFixed = parseFloat(amount.toFixed(8));
    const result = parseFloat((balanceFixed - amountFixed).toFixed(8));
    
    // Гарантируем, что результат не отрицательный
    if (result < 0) {
        console.error('Ошибка: попытка уйти в отрицательный баланс!', {
            balance: balanceFixed,
            amount: amountFixed,
            result: result
        });
        return balanceFixed; // Возвращаем старый баланс
    }
    
    return result;
}

// Защищенная функция для сложения
function safeAdd(balance, amount) {
    const balanceFixed = parseFloat(balance.toFixed(8));
    const amountFixed = parseFloat(amount.toFixed(8));
    return parseFloat((balanceFixed + amountFixed).toFixed(8));
}

// Используйте эти функции в расчетах:
// Например: state.balances[fromCurrency] = safeSubtract(state.balances[fromCurrency], amount);
// Функция для автоматической оплаты налогов
function processStockTaxes() {
    state.stocks.companies.forEach(company => {
        if (company.ownedShares > 0) {
            const ownershipPercent = (company.ownedShares / company.totalShares) * 100;
            
            if (ownershipPercent >= 75) {
                const taxAmount = company.ownedShares * company.price * 0.01; // 1% налог
                
                if (state.balances.BROKER >= taxAmount) {
                    state.balances.BROKER -= taxAmount;
                    
                    // Обновляем время последней оплаты
                    company.lastTaxPayment = Date.now();
                    
                    // Показываем уведомление
                    showNotification(`Налог на владение ${company.name}: ${formatNumber(taxAmount)} ₽`, 'warning');
                    
                    // Сохраняем данные
                    saveUserData();
                }
            }
        }
    });
}

// Функция для форматирования оставшегося времени
function formatTimeRemaining(lastPaymentTime) {
    if (!lastPaymentTime) return "5:00";
    
    const now = Date.now();
    const timePassed = now - lastPaymentTime;
    const timeRemaining = Math.max(0, 300000 - timePassed);
    
    const minutes = Math.floor(timeRemaining / 60000);
    const seconds = Math.floor((timeRemaining % 60000) / 1000);
    
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

// Функция для безопасного уничтожения всех графиков акций
// Обновление максимальной ставки
// Обновление максимальной ставки с проверками
function updateMaxBet() {
    try {
        const currency = state.currentCurrency;
        const balance = state.balances[currency] || 0;
        const maxBet = Math.min(balance, 1);
        
        const maxBetElement = document.getElementById('max-bet');
        const betAmountInput = document.getElementById('bet-amount');
        
        if (maxBetElement) {
            maxBetElement.textContent = formatNumber(maxBet, 6);
        }
        
        if (betAmountInput) {
            betAmountInput.max = maxBet;
            betAmountInput.placeholder = `Макс: ${formatNumber(maxBet, 6)}`;
            
            // Если текущее значение больше максимума, уменьшаем его
            const currentValue = parseFloat(betAmountInput.value);
            if (currentValue > maxBet) {
                betAmountInput.value = maxBet;
            }
        }
    } catch (error) {
        console.log('Ошибка в updateMaxBet:', error);
    }
}

// Функция для переключения валюты
function switchCurrency(newCurrency) {
    if (state.currentCurrency === newCurrency) return;
    
    state.currentCurrency = newCurrency;
    
    // Обновляем активные кнопки
    document.querySelectorAll('.currency-option').forEach(option => {
        if (option.getAttribute('data-currency') === newCurrency) {
            option.classList.add('active');
        } else {
            option.classList.remove('active');
        }
    });
    
    // Обновляем отображение текущей цены
    updateCurrentPrice();
    
    // Пересоздаем график
    if (state.chart) {
        try {
            state.chart.destroy();
        } catch (e) {
            // Игнорируем ошибки
        }
        state.chart = null;
    }
    
    // Создаем новый график
    setTimeout(() => {
        initChart();
    }, 150);
    
    updateMaxBet();
}

// И используйте эту функцию в обработчиках:
// Вместо: currencyOptions.forEach(option => { ... })
// Используйте: switchCurrency(newCurrency)

// Безопасное получение элементов currency-option
function getCurrencyOptions() {
    if (!currencyOptions || currencyOptions.length === 0) {
        // Пытаемся найти элементы заново
        const options = document.querySelectorAll('.currency-option');
        currencyOptions = Array.from(options);
        
        if (currencyOptions.length === 0) {
            console.warn('Не удалось найти элементы currency-option');
            return [];
        }
    }
    return currencyOptions;
}
// И используйте так:
// Функция обновления селектора валют
function updateCurrencySelector() {
    if (!currencyOptions || currencyOptions.length === 0) {
        // Пытаемся найти элементы заново
        currencyOptions = document.querySelectorAll('.currency-option');
    }
    
    if (currencyOptions && currencyOptions.length > 0) {
        currencyOptions.forEach(option => {
            const currency = option.getAttribute('data-currency');
            option.classList.toggle('active', currency === state.currentCurrency);
        });
    }
}

// Блокировка/разблокировка смены валют
function blockCurrencySwitching(block) {
    if (!currencyOptions || currencyOptions.length === 0) {
        currencyOptions = document.querySelectorAll('.currency-option');
    }
    
    currencyOptions.forEach(option => {
        if (block) {
            // Добавляем класс блокировки
            option.classList.add('disabled');
            option.style.opacity = '0.5';
            option.style.cursor = 'not-allowed';
            option.style.pointerEvents = 'none';
        } else {
            // Убираем класс блокировки
            option.classList.remove('disabled');
            option.style.opacity = '1';
            option.style.cursor = 'pointer';
            option.style.pointerEvents = 'auto';
        }
    });
    
    console.log(`Смена валют ${block ? 'заблокирована' : 'разблокирована'}`);
}
// ==================== ДАННЫЕ ДЛЯ FRAGMENT ====================

// Ники для покупки/продажи
const nickData = [
    { id: 1, name: '@awel', basePrice: 25000, currentPrice: 25000, owned: false, change: 0, availability: 5, isPremium: false },
    { id: 2, name: '@angry', basePrice: 30000, currentPrice: 30000, owned: false, change: 0, availability: 5, isPremium: false },
    { id: 3, name: '@KOCMOC', basePrice: 150000, currentPrice: 150000, owned: false, change: 0, availability: 1, isPremium: true },
    { id: 4, name: '@good', basePrice: 35000, currentPrice: 35000, owned: false, change: 0, availability: 5, isPremium: false },
    { id: 5, name: '@team', basePrice: 40000, currentPrice: 40000, owned: false, change: 0, availability: 5, isPremium: false },
    { id: 6, name: '@love', basePrice: 45000, currentPrice: 45000, owned: false, change: 0, availability: 5, isPremium: false },
    { id: 7, name: '@food', basePrice: 30000, currentPrice: 30000, owned: false, change: 0, availability: 5, isPremium: false },
    { id: 8, name: '@KOT', basePrice: 50000, currentPrice: 50000, owned: false, change: 0, availability: 5, isPremium: false },
    { id: 9, name: '@TOPT', basePrice: 55000, currentPrice: 55000, owned: false, change: 0, availability: 5, isPremium: false },
    { id: 10, name: '@game', basePrice: 35000, currentPrice: 35000, owned: false, change: 0, availability: 5, isPremium: false },
    { id: 11, name: '@YTKA_N_HOTA', basePrice: 60000, currentPrice: 60000, owned: false, change: 0, availability: 5, isPremium: false },
    { id: 12, name: '@always', basePrice: 40000, currentPrice: 40000, owned: false, change: 0, availability: 5, isPremium: false },
    { id: 13, name: '@COK', basePrice: 45000, currentPrice: 45000, owned: false, change: 0, availability: 5, isPremium: false },
    { id: 14, name: '@camera', basePrice: 35000, currentPrice: 35000, owned: false, change: 0, availability: 5, isPremium: false },
    { id: 15, name: '@english', basePrice: 40000, currentPrice: 40000, owned: false, change: 0, availability: 5, isPremium: false }
];

// Рынок NFT
const fragmentMarket = {
    nfts: [], // Будет заполняться динамически из улучшенных NFT пользователей
    saleTimers: {} // Таймеры для продажи NFT
};

// Состояние Fragment
// Обновите состояние Fragment в начале файла:
state.fragment = {
    purchasedNicks: [],
    originalNick: state.user ? state.user.username : 'user',
    currentNick: state.user ? state.user.username : 'user',
    nickPrices: {},
    marketNFTs: [],
    sellingNFTs: {},
    failedSales: {} // Новое: отслеживание неудачных продаж {nftId: count}
};

// ==================== ИНИЦИАЛИЗАЦИЯ FRAGMENT ====================

// Инициализация вкладки Fragment
// Инициализация вкладки Fragment - ИСПРАВЛЕННАЯ ВЕРСИЯ
// Инициализация вкладки Fragment - ИСПРАВЛЕННАЯ ВЕРСИЯ
// Обновление селектора NFT для продажи
function updateFragmentNFTSelector() {
    const selector = document.getElementById('fragment-sell-nft-selector');
    if (!selector) return;
    
    selector.innerHTML = '';
    
    // Находим все улучшенные NFT пользователя
    const upgradedNFTs = state.nfts.filter(nft => 
        nft.owned > 0 && nft.upgraded && nft.upgraded.length > 0
    );
    
    if (upgradedNFTs.length === 0) {
        selector.innerHTML = '<div style="text-align: center; padding: 40px; color: #AAAAAA; grid-column: 1 / -1;">У вас нет улучшенных NFT для продажи</div>';
        document.getElementById('btn-sell-fragment-nft').disabled = true;
        return;
    }
    
    upgradedNFTs.forEach(nft => {
        const upgrade = nft.upgraded[0];
        const isSelling = state.fragment.sellingNFTs[nft.id];
        
        // Получаем failedCount правильно
        const failedCount = state.fragment.failedSales ? (state.fragment.failedSales[nft.id] || 0) : 0;
        
        const nftItem = document.createElement('div');
        nftItem.className = `fragment-nft-item ${isSelling ? 'selected' : ''}`;
        nftItem.setAttribute('data-nft-id', nft.id);
        
        // Цвет рамки в зависимости от количества неудач
        if (failedCount === 1) {
            nftItem.style.border = '2px solid #FFD700';
            nftItem.classList.add('warning');
        } else if (failedCount >= 2) {
            nftItem.style.border = '2px solid var(--danger)';
            nftItem.classList.add('danger');
            
            // Добавляем предупреждение о сжигании
            const burnWarning = document.createElement('div');
            burnWarning.className = 'burn-warning';
            burnWarning.textContent = 'ГОРИТ!';
            nftItem.appendChild(burnWarning);
        }
        
        nftItem.innerHTML = `
            <div class="fragment-nft-emoji" style="background: ${getColorFromClass(upgrade.colorClass)};">
                ${nft.emoji}
            </div>
            <div style="font-weight: bold; margin-top: 8px;">${nft.name}</div>
            <div class="fragment-nft-rarity ${getRarityClass(upgrade.rarity)}">
                ${upgrade.rarity.toUpperCase()}
            </div>
            <div style="font-size: 0.9rem; color: #AAAAAA; margin-top: 5px;">
                Цена: ${formatNumber(upgrade.price)} STARS
            </div>
            ${failedCount > 0 ? 
                `<div style="font-size: 0.8rem; margin-top: 5px; padding: 2px 6px; border-radius: 8px; background: ${failedCount >= 2 ? 'rgba(255, 68, 68, 0.2)' : 'rgba(255, 200, 0, 0.2)'}; color: ${failedCount >= 2 ? 'var(--danger)' : '#FFD700'};">
                    Неудач: ${failedCount}/2
                </div>` : 
                ''
            }
            ${isSelling ? 
                '<div style="color: var(--warning); font-size: 0.8rem; margin-top: 5px;">На продаже</div>' : 
                ''
            }
        `;
        
// В обработчике клика по NFT добавьте:
nftItem.addEventListener('click', function() {
    if (isSelling) return;
    
    document.querySelectorAll('.fragment-nft-item').forEach(item => item.classList.remove('selected'));
    this.classList.add('selected');
    
    // Устанавливаем максимальную цену продажи
    updateMaxSellPriceForNFT(nft.id);
    
    // Устанавливаем рекомендуемую цену (рыночную * 1.1)
    const recommendedPrice = Math.floor(upgrade.price * 1.1);
    document.getElementById('fragment-sell-price').value = recommendedPrice;
    document.getElementById('fragment-sell-price').placeholder = `Рекомендуется: ${formatNumber(recommendedPrice)}`;
    
    // Обновляем информацию о шансе
    updateSellChanceInfo();
    
    document.getElementById('btn-sell-fragment-nft').disabled = false;
});
        
        selector.appendChild(nftItem);
    });
    
    // Автовыбор первого NFT если не выбран
    const firstNFT = selector.querySelector('.fragment-nft-item:not(.selected)');
    if (firstNFT) {
        firstNFT.click();
    }
    
    // Обновляем информацию о шансе
    updateSellChanceInfo();
}
function initFragmentTab() {
    console.log('Инициализация Fragment...');
    
    // Инициализация данных ников
    initNicksData();
    
    // Инициализация вкладок Fragment
    initFragmentTabs();
    
    // Инициализация обработчиков
    initFragmentHandlers();
    
    // Загрузка данных пользователя
    loadFragmentData();
    
    // Инициализируем failedSales если его нет
    if (!state.fragment.failedSales) {
        state.fragment.failedSales = {};
        console.log('Инициализирован failedSales');
    }
    
    // Обновление UI
    updateFragmentUI();
    
    console.log('Fragment инициализирован');
}
// Инициализация данных ников
function initNicksData() {
    // Инициализируем динамические цены
    nickData.forEach(nick => {
        state.fragment.nickPrices[nick.id] = nick.currentPrice;
    });
}

// Инициализация вкладок Fragment
function initFragmentTabs() {
    const fragmentTabs = document.querySelectorAll('.fragment-tab');
    
    fragmentTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const fragmentTab = this.getAttribute('data-fragment-tab');
            
            fragmentTabs.forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.fragment-content').forEach(c => c.classList.remove('active'));
            
            this.classList.add('active');
            document.getElementById(`fragment-${fragmentTab}`).classList.add('active');
            
            if (fragmentTab === 'nicks') {
                updateNicksUI();
            } else if (fragmentTab === 'nft-market') {
                updateFragmentNFTMarket();
            }
        });
    });
}

// Инициализация обработчиков
// Инициализация обработчиков Fragment - ИСПРАВЛЕННАЯ ВЕРСИЯ
function initFragmentHandlers() {
    console.log('Инициализация обработчиков Fragment...');
    
    // Удаляем старые обработчики если есть
    const sellNickBtn = document.getElementById('btn-sell-nick');
    const oldSellHandler = sellNickBtn._sellHandler;
    if (oldSellHandler) {
        sellNickBtn.removeEventListener('click', oldSellHandler);
    }
    
    // Устанавливаем новый обработчик продажи ника
    const newSellHandler = function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Клик по продаже ника');
        sellNick();
    };
    
    sellNickBtn.addEventListener('click', newSellHandler);
    sellNickBtn._sellHandler = newSellHandler;
    
    // Обработчик продажи NFT на рынке
    const sellFragmentBtn = document.getElementById('btn-sell-fragment-nft');
    const oldSellNFTHandler = sellFragmentBtn._sellNFTHandler;
    if (oldSellNFTHandler) {
        sellFragmentBtn.removeEventListener('click', oldSellNFTHandler);
    }
    
    const newSellNFTHandler = function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Клик по продаже NFT на Fragment');
        sellNFTOnFragment();
    };
    
    sellFragmentBtn.addEventListener('click', newSellNFTHandler);
    sellFragmentBtn._sellNFTHandler = newSellNFTHandler;
    
    // Обработчик изменения цены для автоматического обновления шансов
    const priceInput = document.getElementById('fragment-sell-price');
    if (priceInput) {
        priceInput.addEventListener('input', function() {
            // Обновляем максимальную цену
            updateMaxSellPrice();
            
            // Обновляем информацию о шансах с учетом новой цены
            setTimeout(() => {
                updateSellChanceInfo();
            }, 100);
        });
    }
    
    console.log('Обработчики Fragment инициализированы');
    
}

// Загрузка данных Fragment
// Загрузка данных Fragment - ОБНОВЛЕННАЯ ВЕРСИЯ
function loadFragmentData() {
    if (!state.user) return;
    
    const fragmentData = localStorage.getItem(`fragmentData_${state.user.username}`);
    if (fragmentData) {
        try {
            const parsedData = JSON.parse(fragmentData);
            
            if (parsedData.purchasedNicks) {
                state.fragment.purchasedNicks = parsedData.purchasedNicks;
            }
            
            if (parsedData.originalNick) {
                state.fragment.originalNick = parsedData.originalNick;
            }
            
            if (parsedData.currentNick) {
                state.fragment.currentNick = parsedData.currentNick;
            }
            
            if (parsedData.nickPrices) {
                state.fragment.nickPrices = parsedData.nickPrices;
            }
            
            if (parsedData.marketNFTs) {
                state.fragment.marketNFTs = parsedData.marketNFTs;
            }
            
            if (parsedData.sellingNFTs) {
                state.fragment.sellingNFTs = parsedData.sellingNFTs;
            }
            
            if (parsedData.failedSales) {
                state.fragment.failedSales = parsedData.failedSales;
            }
            
            console.log('Данные Fragment загружены, счетчики неудач:', Object.keys(state.fragment.failedSales).length);
            
        } catch (e) {
            console.error('Ошибка загрузки данных Fragment:', e);
        }
    } else {
        state.fragment.failedSales = {};
        saveFragmentData();
    }
}

// Сохранение данных Fragment
// Сохранение данных Fragment - ОБНОВЛЕННАЯ ВЕРСИЯ
function saveFragmentData() {
    if (!state.user) return;
    
    try {
        const fragmentData = {
            purchasedNicks: state.fragment.purchasedNicks,
            originalNick: state.fragment.originalNick,
            currentNick: state.fragment.currentNick,
            nickPrices: state.fragment.nickPrices,
            marketNFTs: state.fragment.marketNFTs,
            sellingNFTs: state.fragment.sellingNFTs,
            failedSales: state.fragment.failedSales // Сохраняем счетчики неудач
        };
        
        localStorage.setItem(`fragmentData_${state.user.username}`, JSON.stringify(fragmentData));
    } catch (e) {
        console.error('Ошибка сохранения данных Fragment:', e);
    }
}

// ==================== ОБНОВЛЕНИЕ UI ====================

// Обновление всего UI Fragment
function updateFragmentUI() {
    updateNicksUI();
    updateFragmentNFTMarket();
    updateCurrentNickDisplay();
    updateSellNickSelector();
    updateFragmentNFTSelector();
}

// Обновление UI ников
function updateNicksUI() {
    updateNicksMarket();
    updateSellNickSelector();
    updateCurrentNickDisplay();
}

// Обновление рынка ников
// Обновление рынка ников - ИСПРАВЛЕННАЯ ВЕРСИЯ
function updateNicksMarket() {
    const nicksGrid = document.getElementById('nicks-market-grid');
    if (!nicksGrid) return;
    
    // Сохраняем текущие обработчики если они есть
    const oldButtons = nicksGrid.querySelectorAll('.btn[data-nick-id]');
    const oldHandlers = [];
    
    oldButtons.forEach(btn => {
        if (btn._buyHandler) {
            oldHandlers.push({
                btn: btn,
                handler: btn._buyHandler
            });
        }
    });
    
    nicksGrid.innerHTML = '';
    
    nickData.forEach(nick => {
        const isOwned = state.fragment.purchasedNicks.some(p => p.id === nick.id);
        const currentPrice = state.fragment.nickPrices[nick.id] || nick.currentPrice;
        const change = ((currentPrice - nick.basePrice) / nick.basePrice) * 100;
        
        const nickCard = document.createElement('div');
        nickCard.className = `nick-card ${isOwned ? 'owned' : ''} ${nick.isPremium ? 'premium' : ''}`;
        
        if (nick.isPremium) {
            const badge = document.createElement('div');
            badge.className = 'nick-badge';
            badge.textContent = 'PREMIUM';
            nickCard.appendChild(badge);
        }
        
        let buttonText = 'Купить за ' + formatNumber(currentPrice) + ' STARS';
        if (isOwned) {
            buttonText = '✓ Уже куплен';
        } else if (nick.availability <= 0) {
            buttonText = 'Распродано';
        }
        
        nickCard.innerHTML = `
            <div class="nick-name">${nick.name}</div>
            <div class="nick-price">${formatNumber(currentPrice)} STARS</div>
            <div class="nick-change ${change >= 0 ? 'positive' : 'negative'}">
                ${change >= 0 ? '↗' : '↘'} ${Math.abs(change).toFixed(1)}%
            </div>
            <div class="nick-availability">Доступно: ${nick.availability} шт.</div>
            <button class="btn ${isOwned ? 'btn-outline' : (nick.availability > 0 ? '' : 'btn-outline')}" 
                    data-nick-id="${nick.id}" 
                    ${isOwned || nick.availability <= 0 ? 'disabled' : ''}>
                ${buttonText}
            </button>
        `;
        
        nicksGrid.appendChild(nickCard);
    });
    
    // Добавляем обработчики для кнопок покупки - ИСПРАВЛЕННАЯ ВЕРСИЯ
    const newButtons = nicksGrid.querySelectorAll('.btn[data-nick-id]');
    newButtons.forEach(btn => {
        if (!btn.disabled && !btn.textContent.includes('Уже куплен')) {
            const nickId = parseInt(btn.getAttribute('data-nick-id'));
            
            // Удаляем старый обработчик если есть
            if (btn._buyHandler) {
                btn.removeEventListener('click', btn._buyHandler);
            }
            
            // Создаем новый обработчик с правильным контекстом
            const buyHandler = function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Клик по покупке ника ID:', nickId);
                buyNick(nickId);
            };
            
            btn.addEventListener('click', buyHandler);
            btn._buyHandler = buyHandler;
        }
    });
}

// Обновление отображения текущего ника
function updateCurrentNickDisplay() {
    const currentNickDisplay = document.getElementById('current-nick-display');
    const currentNickAvatar = document.getElementById('current-nick-avatar');
    const additionalNicksDisplay = document.getElementById('additional-nicks-display');
    
    if (!currentNickDisplay || !currentNickAvatar || !additionalNicksDisplay) return;
    
    // Устанавливаем текущий ник
    currentNickDisplay.textContent = state.fragment.currentNick;
    currentNickAvatar.textContent = state.fragment.currentNick.charAt(0).toUpperCase();
    
    // Показываем дополнительные ники
    const otherNicks = state.fragment.purchasedNicks.filter(nick => 
        nick.name !== state.fragment.currentNick
    );
    
    if (otherNicks.length > 0) {
        const nickNames = otherNicks.map(nick => nick.name).join(', ');
        additionalNicksDisplay.innerHTML = `Также: <span style="color: var(--primary);">${nickNames}</span>`;
    } else {
        additionalNicksDisplay.innerHTML = 'Нет дополнительных ников';
    }
}

// Обновление селектора продажи ников
function updateSellNickSelector() {
    const sellNickSelect = document.getElementById('sell-nick-select');
    const sellNickPrice = document.getElementById('sell-nick-price');
    
    if (!sellNickSelect || !sellNickPrice) return;
    
    sellNickSelect.innerHTML = '';
    
    // Добавляем купленные ники в селектор
    state.fragment.purchasedNicks.forEach(nick => {
        const option = document.createElement('option');
        option.value = nick.id;
        option.textContent = `${nick.name} (куплен за ${formatNumber(nick.purchasePrice)} STARS)`;
        sellNickSelect.appendChild(option);
    });
    
    // Если нет ников для продажи
    if (state.fragment.purchasedNicks.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Нет ников для продажи';
        option.disabled = true;
        sellNickSelect.appendChild(option);
        sellNickPrice.value = '0 TON';
        document.getElementById('btn-sell-nick').disabled = true;
        return;
    }
    
    document.getElementById('btn-sell-nick').disabled = false;
    
    // Обновляем цену при изменении выбора
    sellNickSelect.addEventListener('change', function() {
        updateSellNickPrice();
    });
    
    // Устанавливаем начальную цену
    updateSellNickPrice();
}

// Обновление цены продажи ника
// Обновление цены продажи ника - ИСПРАВЛЕННАЯ ВЕРСИЯ
function updateSellNickPrice() {
    const sellNickSelect = document.getElementById('sell-nick-select');
    const sellNickPrice = document.getElementById('sell-nick-price');
    
    if (!sellNickSelect || !sellNickPrice) return;
    
    const selectedNickId = parseInt(sellNickSelect.value);
    if (!selectedNickId) return;
    
    const nick = state.fragment.purchasedNicks.find(n => n.id === selectedNickId);
    if (!nick) return;
    
    // ИСПРАВЛЕНИЕ БАГА 1: Правильная конвертация STARS → TON
    // Используем текущий курс обмена
    const starsToTonRate = state.exchangeRates.STARS / state.exchangeRates.TON;
    
    // Цена продажи = цена покупки в STARS * курс STARS/TON * 0.95 (5% комиссия)
    const sellPriceInStars = nick.purchasePrice;
    const sellPriceInTon = Math.floor(sellPriceInStars * starsToTonRate * 0.95);
    
    sellNickPrice.value = formatNumber(sellPriceInTon) + ' TON';
}

// ==================== ОБРАБОТКА НИКОВ ====================

// Покупка ника
// Покупка ника - ИСПРАВЛЕННАЯ ВЕРСИЯ
function buyNick(nickId) {
    console.log('Начало покупки ника ID:', nickId);
    
    const nick = nickData.find(n => n.id === nickId);
    if (!nick) {
        console.error('Ник не найден:', nickId);
        return;
    }
    
    const currentPrice = state.fragment.nickPrices[nickId] || nick.currentPrice;
    
    // Проверяем, не куплен ли уже этот ник
    const isAlreadyOwned = state.fragment.purchasedNicks.some(n => n.id === nickId);
    if (isAlreadyOwned) {
        showNotification('Этот ник уже куплен!', 'error');
        return;
    }
    
    // Проверяем баланс STARS с запасом
    const currentBalance = parseFloat(state.balances.STARS.toFixed(8));
    const priceFixed = parseFloat(currentPrice.toFixed(8));
    
    if (currentBalance + 0.000001 < priceFixed) { // Добавляем небольшой запас
        showNotification(`Недостаточно STARS. Нужно: ${formatNumber(currentPrice)} STARS, есть: ${formatNumber(currentBalance)}`, 'error');
        return;
    }
    
    // Проверяем доступность
    if (nick.availability <= 0) {
        showNotification('Этот ник больше не доступен для покупки', 'error');
        return;
    }
    
    showConfirmModal(
        `Вы уверены, что хотите купить ник ${nick.name} за ${formatNumber(currentPrice)} STARS?`,
        () => {
            console.log('Подтверждение покупки ника:', nick.name);
            
            // ИСПРАВЛЕНИЕ: Используем защищенное вычитание
            const oldBalance = parseFloat(state.balances.STARS.toFixed(8));
            const newBalance = safeSubtract(oldBalance, priceFixed);
            
            // Проверяем, что операция прошла успешно
            if (newBalance === oldBalance) {
                showNotification('Ошибка: недостаточно средств после проверки', 'error');
                return;
            }
            
            state.balances.STARS = newBalance;
            
            // Добавляем ник в список купленных
            state.fragment.purchasedNicks.push({
                id: nick.id,
                name: nick.name,
                purchasePrice: currentPrice,
                purchaseDate: new Date().toLocaleString('ru-RU'),
                isPremium: nick.isPremium
            });
            
            // Уменьшаем доступность
            nick.availability--;
            
            // Если это первый купленный ник, делаем его текущим
            if (state.fragment.purchasedNicks.length === 1) {
                state.fragment.currentNick = nick.name;
            }
            
            // Добавляем в историю транзакций
            addTransaction('nick_buy', nick.name, -currentPrice, null, 'STARS');
            
            // Сохраняем данные
            saveFragmentData();
            saveUserData();
            
            // Обновляем UI
            updateFragmentUI();
            updateUI();
            
            // Показываем уведомление
            showNotification(`Ник ${nick.name} успешно куплен!`, 'success');
        }
    );
}

// Продажа ника
// Продажа ника - ИСПРАВЛЕННАЯ ВЕРСИЯ
function sellNick() {
    const sellNickSelect = document.getElementById('sell-nick-select');
    const selectedNickId = parseInt(sellNickSelect.value);
    
    if (!selectedNickId) {
        showNotification('Выберите ник для продажи', 'error');
        return;
    }
    
    const nick = state.fragment.purchasedNicks.find(n => n.id === selectedNickId);
    if (!nick) return;
    
    // ИСПРАВЛЕНИЕ БАГА 1: Правильный расчет цены
    const starsToTonRate = state.exchangeRates.STARS / state.exchangeRates.TON;
    const sellPriceInTon = Math.floor(nick.purchasePrice * starsToTonRate * 0.95);
    
    // Проверяем, что цена корректная
    if (sellPriceInTon <= 0) {
        showNotification('Ошибка расчета цены продажи', 'error');
        return;
    }
    
    showConfirmModal(
        `Вы уверены, что хотите продать ник ${nick.name} за ${formatNumber(sellPriceInTon)} TON?`,
        () => {
            // Увеличиваем доступность ника
            const originalNick = nickData.find(n => n.id === nick.id);
            if (originalNick) {
                originalNick.availability++;
            }
            
            // Удаляем ник из купленных
            state.fragment.purchasedNicks = state.fragment.purchasedNicks.filter(n => n.id !== nick.id);
            
            // Добавляем TON на баланс (ПРАВИЛЬНАЯ ЦЕНА)
            state.balances.TON += sellPriceInTon;
            
            // Если продали текущий ник, меняем на другой или на оригинальный
            if (state.fragment.currentNick === nick.name) {
                if (state.fragment.purchasedNicks.length > 0) {
                    state.fragment.currentNick = state.fragment.purchasedNicks[0].name;
                } else {
                    state.fragment.currentNick = state.fragment.originalNick;
                }
            }
            
            // Добавляем в историю транзакций
            addTransaction('nick_sell', nick.name, sellPriceInTon, null, 'TON');
            
            // Сохраняем данные
            saveFragmentData();
            saveUserData();
            
            // Обновляем UI
            updateFragmentUI();
            updateUI();
            
            // Показываем уведомление
            showNotification(`Ник ${nick.name} продан за ${formatNumber(sellPriceInTon)} TON!`, 'success');
        }
    );
}

// Симуляция изменения цен ников
function startNickPriceSimulation() {
    setInterval(() => {
        nickData.forEach(nick => {
            if (nick.availability <= 0) return;
            
            // Изменение цены от -5% до +10%
            const change = (Math.random() * 0.15) - 0.05;
            const currentPrice = state.fragment.nickPrices[nick.id] || nick.currentPrice;
            const newPrice = Math.max(nick.basePrice * 0.5, currentPrice * (1 + change));
            
            state.fragment.nickPrices[nick.id] = Math.floor(newPrice);
        });
        
        // Обновляем UI если открыта вкладка ников
        if (document.querySelector('#fragment-nicks.fragment-content.active')) {
            updateNicksMarket();
        }
        
    }, 60000); // Каждую минуту
}

// ==================== FRAGMENT NFT РЫНОК ====================

// Обновление рынка NFT Fragment
function updateFragmentNFTMarket() {
    updateFragmentNFTGrid();
    updateFragmentNFTSelector();
    updateSellChanceInfo();
}

// Обновление сетки NFT на рынке
function updateFragmentNFTGrid() {
    const fragmentNFTGrid = document.getElementById('fragment-nft-grid');
    if (!fragmentNFTGrid) return;
    
    fragmentNFTGrid.innerHTML = '';
    
    // Формируем список всех улучшенных NFT на рынке
    const allMarketNFTs = [];
    
    // 1. NFT от других игроков (реальные продажи)
    state.fragment.marketNFTs.forEach(marketNFT => {
        const nft = findNFTById(marketNFT.nftId);
        if (nft && nft.upgraded && nft.upgraded.length > 0) {
            const upgrade = nft.upgraded[0];
            allMarketNFTs.push({
                type: 'market',
                data: marketNFT,
                nft: nft,
                upgrade: upgrade
            });
        }
    });
    
    // 2. NFT, выставленные на продажу
    for (const nftId in state.fragment.sellingNFTs) {
        const sellingData = state.fragment.sellingNFTs[nftId];
        const nft = findNFTById(parseInt(nftId));
        
        if (nft && nft.upgraded && nft.upgraded.length > 0) {
            const upgrade = nft.upgraded[0];
            allMarketNFTs.push({
                type: 'selling',
                data: sellingData,
                nft: nft,
                upgrade: upgrade
            });
        }
    }
    
    if (allMarketNFTs.length === 0) {
        fragmentNFTGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: #AAAAAA; grid-column: 1 / -1;">На рынке пока нет NFT</div>';
        return;
    }
    
    // Отображаем все NFT
    allMarketNFTs.forEach(item => {
        const isSelling = item.type === 'selling';
        const marketNFTCard = document.createElement('div');
        marketNFTCard.className = 'market-nft-card';
        
        const price = isSelling ? item.data.askingPrice : item.data.price;
        const seller = isSelling ? 'Вы' : item.data.seller;
        const status = isSelling ? 'selling' : 'available';
        const statusText = isSelling ? 'На продаже' : 'В продаже';
        
        // Определяем цвет фона по редкости
        const rarityClass = getRarityClass(item.upgrade.rarity);
        
        marketNFTCard.innerHTML = `
            <div class="market-nft-image" style="background: ${getColorFromClass(item.upgrade.colorClass)};">
                ${item.nft.emoji}
            </div>
            <div class="market-nft-info">
                <div class="market-nft-name">${item.nft.name}</div>
                <div class="market-nft-owner">Продавец: ${seller}</div>
                <div class="market-nft-price">${formatNumber(price)} STARS</div>
                <div class="market-nft-status ${status}">${statusText}</div>
                <span class="nft-upgrade-indicator ${rarityClass}" style="display: inline-block; margin-bottom: 10px;">
                    ${item.upgrade.rarity.toUpperCase()}
                </span>
            </div>
            ${isSelling ? 
                `<div class="sale-timer">Осталось: ${formatTimeRemaining(item.data.startTime)}</div>
                <button class="btn btn-outline btn-block" data-nft-id="${item.nft.id}" data-type="cancel">Отменить продажу</button>` :
                `<button class="btn btn-block" data-nft-id="${item.nft.id}" data-type="buy">Купить NFT</button>`
            }
        `;
        
        fragmentNFTGrid.appendChild(marketNFTCard);
    });
    
    // Добавляем обработчики
    document.querySelectorAll('#fragment-nft-grid .btn').forEach(btn => {
        const nftId = parseInt(btn.getAttribute('data-nft-id'));
        const actionType = btn.getAttribute('data-type');
        
        btn.addEventListener('click', function() {
            if (actionType === 'buy') {
                buyMarketNFT(nftId);
            } else if (actionType === 'cancel') {
                cancelNFTSale(nftId);
            }
        });
    });
}

// Поиск NFT по ID
function findNFTById(nftId) {
    return state.nfts.find(n => n.id === nftId);
}

// Получение класса редкости
function getRarityClass(rarity) {
    const classes = {
        'common': 'rarity-common',
        'uncommon': 'rarity-uncommon',
        'rare': 'rarity-rare',
        'epic': 'rarity-epic',
        'legendary': 'rarity-legendary',
        'godlike': 'rarity-godlike'
    };
    return classes[rarity] || 'rarity-common';
}

// Обновление селектора NFT для продажи
// Обновление селектора NFT для продажи - ИСПРАВЛЕННАЯ ВЕРСИЯ
// Обновление информации о шансе продажи - ИСПРАВЛЕННАЯ ВЕРСИЯ
// Обновление информации о шансе продажи - ОБНОВЛЕННАЯ С УЧЕТОМ ЦЕНЫ
function updateSellChanceInfo() {
    const selectedNFT = document.querySelector('.fragment-nft-item.selected');
    if (!selectedNFT) {
        // Устанавливаем значения по умолчанию если ничего не выбрано
        document.getElementById('sell-chance-normal').textContent = '75%';
        document.getElementById('sell-chance-luck').textContent = systemSettings.doubleLuckMode ? '85%' : '75%';
        return;
    }
    
    const nftId = parseInt(selectedNFT.getAttribute('data-nft-id'));
    const nft = findNFTById(nftId);
    
    if (!nft) {
        document.getElementById('sell-chance-normal').textContent = '75%';
        document.getElementById('sell-chance-luck').textContent = systemSettings.doubleLuckMode ? '85%' : '75%';
        return;
    }
    
    // Получаем введенную цену
    const askingPriceInput = document.getElementById('fragment-sell-price');
    const askingPrice = askingPriceInput.value ? parseInt(askingPriceInput.value) : 0;
    
    // Проверяем наличие failedSales
    const failedCount = state.fragment.failedSales ? (state.fragment.failedSales[nftId] || 0) : 0;
    
    // Получаем рыночную цену NFT (цена улучшения)
    const marketPrice = nft.upgraded && nft.upgraded.length > 0 ? nft.upgraded[0].price : nft.price;
    
    // Рассчитываем коэффициент цены (во сколько раз выше рыночной)
    const priceMultiplier = askingPrice > 0 ? (askingPrice / marketPrice) : 1;
    
    // Базовые шансы в зависимости от попыток
    let baseChance;
    
    if (failedCount === 0) {
        baseChance = 0.75; // 75% - Первая попытка
    } else if (failedCount === 1) {
        baseChance = 0.85; // 85% - Вторая попытка
    } else {
        baseChance = 0.95; // 95% - Третья попытка (последний шанс)
    }
    
    // КОРРЕКЦИЯ ШАНСА В ЗАВИСИМОСТИ ОТ ЦЕНЫ:
    // 1.0x - 1.2x рыночной цены: -0% к шансу
    // 1.2x - 1.4x: -10% к шансу
    // 1.4x - 1.6x: -25% к шансу
    // 1.6x - 1.8x: -50% к шансу
    
    let pricePenalty = 0;
    
    if (priceMultiplier >= 1.6) {
        pricePenalty = 0.50; // 50% штраф
    } else if (priceMultiplier >= 1.4) {
        pricePenalty = 0.25; // 25% штраф
    } else if (priceMultiplier >= 1.2) {
        pricePenalty = 0.10; // 10% штраф
    }
    
    // Итоговый шанс с учетом штрафа за цену
    let finalChance = Math.max(0.05, baseChance - pricePenalty); // Минимальный шанс 5%
    
    // Шанс с 2x удачей (увеличиваем на 10%)
    let finalChanceWithLuck = Math.min(0.95, finalChance + 0.10); // Максимальный шанс 95%
    
    // Округляем для отображения
    const normalChance = Math.round(finalChance * 100);
    const luckChance = Math.round(finalChanceWithLuck * 100);
    
    document.getElementById('sell-chance-normal').textContent = `${normalChance}%`;
    document.getElementById('sell-chance-luck').textContent = systemSettings.doubleLuckMode ? `${luckChance}%` : `${normalChance}%`;
    
    // Обновляем информацию о цене
    updatePriceInfo(marketPrice, askingPrice, priceMultiplier);
    
    // Показываем предупреждение если это последняя попытка
    updateWarningInfo(failedCount, priceMultiplier);
}

// Обновление информации о цене
// Обновление информации о цене с визуализацией
function updatePriceInfo(marketPrice, askingPrice, priceMultiplier) {
    const priceInfoElement = document.getElementById('price-info');
    if (!priceInfoElement) {
        const sellPriceDiv = document.querySelector('#fragment-nft-market .form-group:nth-child(2)');
        if (sellPriceDiv) {
            const info = document.createElement('div');
            info.id = 'price-info';
            sellPriceDiv.appendChild(info);
        } else {
            return;
        }
    }
    
    const priceInfo = document.getElementById('price-info');
    if (!priceInfo) return;
    
    // Рассчитываем примерный шанс для визуализации
    let estimatedChance = 75;
    let chanceClass = 'chance-high';
    let infoClass = 'price-info-normal';
    let priceStatus = 'НОРМАЛЬНАЯ ЦЕНА';
    let color = 'var(--primary)';
    
    if (priceMultiplier >= 1.6) {
        estimatedChance = 25;
        chanceClass = 'chance-very-low';
        infoClass = 'price-info-danger';
        priceStatus = 'ОЧЕНЬ ВЫСОКАЯ ЦЕНА (-50% к шансу)';
        color = 'var(--danger)';
    } else if (priceMultiplier >= 1.4) {
        estimatedChance = 50;
        chanceClass = 'chance-low';
        infoClass = 'price-info-warning';
        priceStatus = 'ВЫСОКАЯ ЦЕНА (-25% к шансу)';
        color = '#FF9800';
    } else if (priceMultiplier >= 1.2) {
        estimatedChance = 65;
        chanceClass = 'chance-medium';
        infoClass = 'price-info-warning';
        priceStatus = 'ПОВЫШЕННАЯ ЦЕНА (-10% к шансу)';
        color = '#FFD700';
    } else if (askingPrice > 0 && priceMultiplier < 1.0) {
        estimatedChance = 90;
        chanceClass = 'chance-high';
        infoClass = 'price-info-success';
        priceStatus = 'НИЗКАЯ ЦЕНА (+5% к шансу)';
        color = 'var(--success)';
    }
    
    priceInfo.innerHTML = `
        <div class="price-info-container ${infoClass}">
            <div style="font-weight: bold; margin-bottom: 5px;">
                ${priceStatus}
            </div>
            <div style="color: ${color}; margin-bottom: 5px;">
                Коэффициент цены: ${priceMultiplier.toFixed(2)}x
            </div>
            <div class="chance-indicator">
                <div class="chance-bar">
                    <div class="chance-fill ${chanceClass}" style="width: ${estimatedChance}%"></div>
                </div>
                <div style="font-size: 0.8rem; color: #AAAAAA;">
                    ≈${estimatedChance}% шанс
                </div>
            </div>
            <div style="font-size: 0.8rem; color: #AAAAAA; margin-top: 5px;">
                Рыночная: ${formatNumber(marketPrice)} STARS<br>
                Ваша: ${formatNumber(askingPrice)} STARS
            </div>
        </div>
    `;
}

// Обновление информации с предупреждениями
function updateWarningInfo(failedCount, priceMultiplier) {
    const warningElement = document.getElementById('sell-warning');
    if (!warningElement) {
        const sellChanceDiv = document.querySelector('#fragment-nft-market .form-group:nth-child(3)');
        if (sellChanceDiv) {
            const warning = document.createElement('div');
            warning.id = 'sell-warning';
            warning.style.marginTop = '10px';
            sellChanceDiv.appendChild(warning);
        }
    }
    
    const warningEl = document.getElementById('sell-warning');
    if (!warningEl) return;
    
    let warnings = [];
    
    if (failedCount >= 2) {
        warnings.push(`<div style="background: rgba(255, 68, 68, 0.2); padding: 8px; border-radius: 8px; color: var(--danger); font-size: 0.9rem; margin-bottom: 5px;">
            ⚠️ <strong>ПОСЛЕДНИЙ ШАНС!</strong> Если NFT не продастся в этот раз - он сгорит!
        </div>`);
    } else if (failedCount === 1) {
        warnings.push(`<div style="background: rgba(255, 200, 0, 0.2); padding: 8px; border-radius: 8px; color: #FFD700; font-size: 0.9rem; margin-bottom: 5px;">
            ⚠️ <strong>Вторая попытка!</strong> Следующая неудачная продажа приведет к сжиганию NFT
        </div>`);
    }
    
    if (priceMultiplier >= 1.6) {
        warnings.push(`<div style="background: rgba(255, 68, 68, 0.2); padding: 8px; border-radius: 8px; color: var(--danger); font-size: 0.9rem; margin-bottom: 5px;">
            ⚠️ <strong>ОЧЕНЬ ВЫСОКАЯ ЦЕНА!</strong> Шанс продажи снижен на 50%
        </div>`);
    } else if (priceMultiplier >= 1.4) {
        warnings.push(`<div style="background: rgba(255, 152, 0, 0.2); padding: 8px; border-radius: 8px; color: #FF9800; font-size: 0.9rem; margin-bottom: 5px;">
            ⚠️ <strong>ВЫСОКАЯ ЦЕНА!</strong> Шанс продажи снижен на 25%
        </div>`);
    } else if (priceMultiplier >= 1.2) {
        warnings.push(`<div style="background: rgba(255, 215, 0, 0.2); padding: 8px; border-radius: 8px; color: #FFD700; font-size: 0.9rem; margin-bottom: 5px;">
            ⚠️ <strong>ПОВЫШЕННАЯ ЦЕНА!</strong> Шанс продажи снижен на 10%
        </div>`);
    }
    
    warningEl.innerHTML = warnings.join('');
}

// Обновление максимальной цены продажи для выбранного NFT
function updateMaxSellPriceForNFT(nftId) {
    const nft = findNFTById(nftId);
    if (!nft || !nft.upgraded || nft.upgraded.length === 0) return;
    
    const upgrade = nft.upgraded[0];
    const maxPrice = Math.floor(upgrade.price * 1.8);
    
    document.getElementById('max-sell-price').textContent = formatNumber(maxPrice);
    document.getElementById('fragment-sell-price').max = maxPrice;
    document.getElementById('fragment-sell-price').placeholder = `Макс: ${formatNumber(maxPrice)}`;
}

// Обновление максимальной цены продажи
function updateMaxSellPrice() {
    const sellPriceInput = document.getElementById('fragment-sell-price');
    const maxPrice = parseInt(document.getElementById('fragment-sell-price').max);
    const currentPrice = parseInt(sellPriceInput.value);
    
    if (currentPrice > maxPrice) {
        sellPriceInput.value = maxPrice;
    }
}

// Обновление информации о шансе продажи
// Обновление информации о шансе продажи - ИСПРАВЛЕННАЯ ВЕРСИЯ
function updateSellChanceInfo() {
    const selectedNFT = document.querySelector('.fragment-nft-item.selected');
    if (!selectedNFT) return;
    
    const nftId = parseInt(selectedNFT.getAttribute('data-nft-id'));
    const nft = findNFTById(nftId);
    
    if (!nft) return;
    
    // Проверяем количество неудачных продаж
    const failedCount = state.fragment.failedSales[nftId] || 0;
    
    // Базовые шансы
    let normalChance, luckChance;
    
    // УВЕЛИЧЕННЫЕ ШАНСЫ:
    // 1 попытка: 75% (раньше 45%)
    // 2 попытка: 85% (если первая неудачная)
    // 3 попытка: 95% (если две неудачные)
    
    if (failedCount === 0) {
        normalChance = 75; // Первая попытка
        luckChance = 85;   // С 2x удачей
    } else if (failedCount === 1) {
        normalChance = 85; // Вторая попытка
        luckChance = 90;   // С 2x удачей
    } else {
        normalChance = 95; // Третья попытка (последний шанс)
        luckChance = 98;   // С 2x удачей
    }
    
    // Если режим 2x удачи не активен, показываем нормальный шанс
    if (!systemSettings.doubleLuckMode) {
        luckChance = normalChance;
    }
    
    document.getElementById('sell-chance-normal').textContent = `${normalChance}%`;
    document.getElementById('sell-chance-luck').textContent = `${luckChance}%`;
    
    // Показываем предупреждение если это последняя попытка
    const warningElement = document.getElementById('sell-warning');
    if (!warningElement) {
        const sellChanceDiv = document.querySelector('#fragment-nft-market .form-group:nth-child(3)');
        if (sellChanceDiv) {
            const warning = document.createElement('div');
            warning.id = 'sell-warning';
            warning.style.marginTop = '10px';
            sellChanceDiv.appendChild(warning);
        }
    }
    
    if (failedCount >= 2) {
        document.getElementById('sell-warning').innerHTML = `
            <div style="background: rgba(255, 68, 68, 0.2); padding: 12px; border-radius: 8px; color: var(--danger); font-size: 0.9rem;">
                ⚠️ <strong>ПОСЛЕДНИЙ ШАНС!</strong> Если NFT не продастся в этот раз - он сгорит!
            </div>
        `;
    } else if (failedCount === 1) {
        document.getElementById('sell-warning').innerHTML = `
            <div style="background: rgba(255, 200, 0, 0.2); padding: 12px; border-radius: 8px; color: #FFD700; font-size: 0.9rem;">
                ⚠️ <strong>Вторая попытка!</strong> Следующая неудачная продажа приведет к сжиганию NFT
            </div>
        `;
    } else {
        document.getElementById('sell-warning').innerHTML = '';
    }
}
// ==================== ОБРАБОТКА NFT НА РЫНКЕ ====================

// Покупка NFT с рынка
function buyMarketNFT(nftId) {
    const marketNFT = state.fragment.marketNFTs.find(n => n.nftId === nftId);
    if (!marketNFT) return;
    
    const nft = findNFTById(nftId);
    if (!nft) return;
    
    const price = marketNFT.price;
    
    // Проверяем баланс STARS
    if (state.balances.STARS < price) {
        showNotification(`Недостаточно STARS. Нужно: ${formatNumber(price)} STARS`, 'error');
        return;
    }
    
    showConfirmModal(
        `Вы уверены, что хотите купить NFT "${nft.name}" за ${formatNumber(price)} STARS?`,
        () => {
            // Списание STARS
            state.balances.STARS -= price;
            
            // Добавляем NFT в инвентарь
            nft.owned++;
            nft.upgraded.push({...marketNFT.upgrade});
            
            // Удаляем NFT с рынка
            state.fragment.marketNFTs = state.fragment.marketNFTs.filter(n => n.nftId !== nftId);
            
            // Добавляем в историю транзакций
            addTransaction('fragment_nft_buy', `NFT ${nft.name}`, -price, null, 'STARS');
            
            // Сохраняем данные
            saveFragmentData();
            saveUserData();
            
            // Обновляем UI
            updateFragmentUI();
            updateUI();
            
            // Показываем уведомление
            showNotification(`NFT "${nft.name}" успешно куплен!`, 'success');
        }
    );
}

// Продажа NFT на рынке Fragment
// Продажа NFT на рынке Fragment - ИСПРАВЛЕННАЯ ВЕРСИЯ
function sellNFTOnFragment() {
    console.log('Начало продажи NFT на Fragment');
    
    const selectedNFT = document.querySelector('.fragment-nft-item.selected');
    if (!selectedNFT) {
        showNotification('Выберите NFT для продажи', 'error');
        return;
    }
    
    const nftId = parseInt(selectedNFT.getAttribute('data-nft-id'));
    const nft = findNFTById(nftId);
    
    if (!nft || nft.owned <= 0 || !nft.upgraded || nft.upgraded.length === 0) {
        showNotification('NFT не найден или не улучшен', 'error');
        return;
    }
    
    const askingPrice = parseInt(document.getElementById('fragment-sell-price').value);
    const maxPrice = parseInt(document.getElementById('fragment-sell-price').max);
    
    if (!askingPrice || askingPrice <= 0) {
        showNotification('Введите корректную цену', 'error');
        return;
    }
    
    if (askingPrice > maxPrice) {
        showNotification(`Цена не может превышать ${formatNumber(maxPrice)} STARS`, 'error');
        return;
    }
    
    const upgrade = nft.upgraded[0];
    
    // Проверяем, не продается ли уже этот NFT
    if (state.fragment.sellingNFTs[nftId]) {
        showNotification('Этот NFT уже выставлен на продажу', 'error');
        return;
    }
    
    showConfirmModal(
        `Выставить NFT "${nft.name}" на продажу за ${formatNumber(askingPrice)} STARS на 2 минуты?`,
        () => {
            console.log('Подтверждение продажи NFT:', nft.name);
            
            const startTime = Date.now();
            const saleId = `sale_${nftId}_${startTime}`;
            
            // Добавляем NFT в список продающихся
            state.fragment.sellingNFTs[nftId] = {
                nftId: nftId,
                askingPrice: askingPrice,
                startTime: startTime,
                saleId: saleId,
                upgrade: {...upgrade},
                seller: state.user.username
            };
            
            // Уменьшаем количество NFT у пользователя (временно)
            nft.owned--;
            nft.upgraded.shift();
            
            // Запускаем таймер продажи
            startNFTSaleTimer(nftId, askingPrice);
            
            // Сохраняем данные
            saveFragmentData();
            saveUserData();
            
            // Обновляем UI
            updateFragmentUI();
            updateUI();
            
            // Показываем уведомление
            showNotification(`NFT выставлен на продажу! Продажа займет 2 минуты.`, 'success');
        }
    );
}

// Обработка результата продажи NFT - ОБНОВЛЕННАЯ С УЧЕТОМ ЦЕНЫ
function processNFTSaleResult(nftId, askingPrice) {
    console.log('Обработка результата продажи NFT ID:', nftId);
    
    const saleData = state.fragment.sellingNFTs[nftId];
    if (!saleData) {
        console.error('Данные о продаже не найдены');
        return;
    }
    
    const nft = findNFTById(nftId);
    
    // Проверяем наличие failedSales
    const failedCount = state.fragment.failedSales ? (state.fragment.failedSales[nftId] || 0) : 0;
    
    // Получаем рыночную цену NFT
    const marketPrice = nft.upgraded && nft.upgraded.length > 0 ? nft.upgraded[0].price : nft.price;
    
    // Рассчитываем коэффициент цены
    const priceMultiplier = askingPrice / marketPrice;
    
    // Базовые шансы в зависимости от попыток
    let baseChance;
    
    if (failedCount === 0) {
        baseChance = 0.75; // 75% - Первая попытка
    } else if (failedCount === 1) {
        baseChance = 0.85; // 85% - Вторая попытка
    } else {
        baseChance = 0.95; // 95% - Третья попытка (последний шанс)
    }
    
    // ШТРАФ ЗА ЦЕНУ:
    let pricePenalty = 0;
    
    if (priceMultiplier >= 1.6) {
        pricePenalty = 0.50; // 50% штраф
    } else if (priceMultiplier >= 1.4) {
        pricePenalty = 0.25; // 25% штраф
    } else if (priceMultiplier >= 1.2) {
        pricePenalty = 0.10; // 10% штраф
    }
    
    // БОНУС ЗА НИЗКУЮ ЦЕНУ (ниже рыночной)
    let priceBonus = 0;
    if (priceMultiplier < 1.0) {
        priceBonus = 0.05; // +5% за низкую цену
    }
    
    // Итоговый шанс
    let finalChance = Math.max(0.05, baseChance - pricePenalty + priceBonus);
    
    // Шанс с 2x удачей (увеличиваем на 10%)
    if (systemSettings.doubleLuckMode) {
        finalChance = Math.min(0.95, finalChance + 0.10);
    }
    
    const isSold = Math.random() < finalChance;
    
    console.log('Параметры продажи:', {
        nftName: nft?.name,
        askingPrice,
        marketPrice,
        priceMultiplier: priceMultiplier.toFixed(2),
        failedCount,
        baseChance: Math.round(baseChance * 100) + '%',
        pricePenalty: Math.round(pricePenalty * 100) + '%',
        priceBonus: Math.round(priceBonus * 100) + '%',
        finalChance: Math.round(finalChance * 100) + '%',
        isSold,
        doubleLuckMode: systemSettings.doubleLuckMode
    });
    
    // ... остальная часть функции остается без изменений ...
    // (та же логика обработки продажи/непродажи)
    
    if (isSold) {
        // NFT ПРОДАНО УСПЕШНО!
        // Сбрасываем счетчик неудач
        if (state.fragment.failedSales) {
            delete state.fragment.failedSales[nftId];
        }
        
        // Добавляем деньги продавцу (с комиссией 10%)
        const sellerProfit = Math.floor(askingPrice * 0.9);
        state.balances.STARS += sellerProfit;
        
        // Добавляем NFT на рынок для покупки другими игроками
        state.fragment.marketNFTs.push({
            nftId: nftId,
            price: askingPrice,
            upgrade: saleData.upgrade,
            seller: saleData.seller,
            saleTime: new Date().toLocaleString('ru-RU')
        });
        
        // Добавляем в историю транзакций
        if (nft) {
            addTransaction('fragment_nft_sell', `NFT ${nft.name}`, sellerProfit, null, 'STARS');
        }
        
        // Показываем сообщение с учетом цены
        let priceMessage = '';
        if (priceMultiplier >= 1.6) {
            priceMessage = ' 🎉 Несмотря на высокую цену!';
        } else if (priceMultiplier < 1.0) {
            priceMessage = ' 🎉 Выгодная цена помогла продать быстро!';
        }
        
        showNotification(`🎉 NFT "${nft?.name || 'Неизвестный'}" ПРОДАН за ${formatNumber(askingPrice)} STARS!${priceMessage} Вы получили ${formatNumber(sellerProfit)} STARS`, 'success');
        
    } else {
        // NFT НЕ ПРОДАНО
        // Увеличиваем счетчик неудачных продаж
        if (!state.fragment.failedSales) {
            state.fragment.failedSales = {};
        }
        
        state.fragment.failedSales[nftId] = (state.fragment.failedSales[nftId] || 0) + 1;
        const newFailedCount = state.fragment.failedSales[nftId];
        
        console.log('Неудачная продажа. Новый счетчик:', newFailedCount);
        
        // Показываем сообщение с учетом цены
        let priceReason = '';
        if (priceMultiplier >= 1.6) {
            priceReason = ' Цена слишком высокая!';
        } else if (priceMultiplier >= 1.4) {
            priceReason = ' Цена высокая для рынка.';
        }
        
        if (newFailedCount >= 3) {
            // 3 НЕУДАЧНЫЕ ПОПЫТКИ - NFT СГОРАЕТ!
            showNotification(`🔥 NFT "${nft?.name || 'Неизвестный'}" СГОРЕЛ после 3 неудачных попыток продажи!${priceReason}`, 'error');
            
            // Удаляем счетчик неудач
            delete state.fragment.failedSales[nftId];
            
            // NFT сгорает - ничего не возвращаем
            
        } else if (newFailedCount >= 2) {
            // 2 НЕУДАЧНЫЕ ПОПЫТКИ - ВОЗВРАЩАЕМ НО С ПРЕДУПРЕЖДЕНИЕМ
            if (nft) {
                nft.owned++;
                nft.upgraded.unshift(saleData.upgrade);
            }
            
            showNotification(`⚠️ NFT "${nft?.name || 'Неизвестный'}" не продан!${priceReason} Это 2-я неудача. Следующая неудача приведет к сжиганию NFT!`, 'warning');
            
        } else {
            // 1 НЕУДАЧНАЯ ПОПЫТКА - ПРОСТО ВОЗВРАЩАЕМ
            if (nft) {
                nft.owned++;
                nft.upgraded.unshift(saleData.upgrade);
            }
            
            showNotification(`😔 NFT "${nft?.name || 'Неизвестный'}" не продан.${priceReason} Попробуйте снизить цену!`, 'info');
        }
    }
    
    // Удаляем из списка продающихся В ЛЮБОМ СЛУЧАЕ
    delete state.fragment.sellingNFTs[nftId];
    
    // Сохраняем данные
    saveFragmentData();
    saveUserData();
    
    // Обновляем UI
    updateFragmentUI();
    updateUI();
}

// Запуск таймера продажи NFT
function startNFTSaleTimer(nftId, askingPrice) {
    const saleData = state.fragment.sellingNFTs[nftId];
    if (!saleData) return;
    
    const saleTimeout = setTimeout(() => {
        processNFTSaleResult(nftId, askingPrice);
    }, 120000); // 2 минуты
    
    // Сохраняем timeout ID
    saleData.timeoutId = saleTimeout;
    state.fragment.sellingNFTs[nftId] = saleData;
}

// Обработка результата продажи NFT
// Обработка результата продажи NFT - ПОЛНОСТЬЮ ПЕРЕПИСАНА С СИСТЕМОЙ СЖИГАНИЯ
// Обработка результата продажи NFT - ИСПРАВЛЕННАЯ ВЕРСИЯ


// Отмена продажи NFT
// Отмена продажи NFT - ОБНОВЛЕННАЯ ВЕРСИЯ
// Отмена продажи NFT - ОБНОВЛЕННАЯ ВЕРСИЯ
function cancelNFTSale(nftId) {
    const saleData = state.fragment.sellingNFTs[nftId];
    if (!saleData) return;
    
    const nft = findNFTById(nftId);
    
    showConfirmModal(
        `Отменить продажу NFT "${nft?.name || 'Неизвестный'}"?`,
        () => {
            // Возвращаем NFT владельцу
            if (nft) {
                nft.owned++;
                nft.upgraded.unshift(saleData.upgrade);
            }
            
            // Сбрасываем счетчик неудач при добровольной отмене
            if (state.fragment.failedSales) {
                delete state.fragment.failedSales[nftId];
            }
            
            // Очищаем таймер
            if (saleData.timeoutId) {
                clearTimeout(saleData.timeoutId);
            }
            
            // Удаляем из списка продающихся
            delete state.fragment.sellingNFTs[nftId];
            
            // Сохраняем данные
            saveFragmentData();
            saveUserData();
            
            // Обновляем UI
            updateFragmentUI();
            updateUI();
            
            showNotification('Продажа NFT отменена. Счетчик неудач сброшен.', 'info');
        }
    );
}
// Форматирование оставшегося времени
function formatTimeRemaining(startTime) {
    const now = Date.now();
    const timePassed = now - startTime;
    const timeRemaining = Math.max(0, 120000 - timePassed);
    
    const minutes = Math.floor(timeRemaining / 60000);
    const seconds = Math.floor((timeRemaining % 60000) / 1000);
    
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

// Очистка устаревших продаж при загрузке
function cleanupOldSales() {
    const now = Date.now();
    const twoMinutes = 2 * 60 * 1000;
    
    for (const nftId in state.fragment.sellingNFTs) {
        const saleData = state.fragment.sellingNFTs[nftId];
        if (saleData.startTime && (now - saleData.startTime > twoMinutes)) {
            console.log('Очистка устаревшей продажи NFT ID:', nftId);
            
            // Обрабатываем как неудачную продажу
            processNFTSaleResult(parseInt(nftId), saleData.askingPrice);
        }
    }
}
// Функция для валидации и исправления балансов
function validateAndFixBalances() {
    let fixed = false;
    
    for (const currency in state.balances) {
        if (state.balances[currency] < 0) {
            console.warn(`Исправляю отрицательный баланс ${currency}: было ${state.balances[currency]}`);
            state.balances[currency] = 0;
            fixed = true;
        }
        
        // Округляем до 8 знаков для избежания погрешности
        state.balances[currency] = parseFloat(state.balances[currency].toFixed(8));
    }
    
    if (fixed) {
        saveUserData();
        updateUI();
        console.log('Балансы проверены и исправлены');
    }
}

// Запускаем проверку каждые 30 секунд
setInterval(validateAndFixBalances, 30000);
    </script>
</body>
</html>
